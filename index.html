<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive dashboard analyzing Washington State K-12 school funding gaps. Compare districts, explore funding problems, and simulate policy reforms.">
    <meta name="keywords" content="Washington, K-12, education funding, school funding gap, McCleary, special education, LEA, poverty weight">
    <meta name="author" content="WA K-12 Funding Analysis Project">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="WA K-12 Funding Gap Analysis Dashboard">
    <meta property="og:description" content="Explore how Washington's school funding formula creates gaps. Compare your district, simulate reforms, and learn what you can do.">
    <meta property="og:image" content="https://wa-k12-funding.org/preview.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="WA K-12 Funding Gap Analysis">
    <meta name="twitter:description" content="Interactive analysis of Washington State school funding inequities.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ“</text></svg>">

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <title>WA K-12 Funding Gap Analysis Dashboard</title>
    <style>
        /* ============== CSS VARIABLES (Shared Theme) ============== */
        :root {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #4facfe;
            --accent-cyan: #00f2fe;
            --accent-red: #ff6b6b;
            --accent-yellow: #feca57;
            --accent-green: #2ed573;
            --accent-purple: #a55eea;
            --text-primary: #e8e8e8;
            --text-secondary: #9a9a9a;
            --card-bg: rgba(255,255,255,0.04);
            --card-border: rgba(255,255,255,0.12);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ============== ACCESSIBILITY ============== */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-blue);
            color: #000;
            padding: 10px 20px;
            z-index: 1000;
            font-weight: 600;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus visible styles for keyboard navigation */
        *:focus-visible {
            outline: 3px solid var(--accent-blue);
            outline-offset: 2px;
        }

        button:focus-visible,
        select:focus-visible,
        input:focus-visible,
        a:focus-visible {
            outline: 3px solid var(--accent-blue);
            outline-offset: 2px;
            box-shadow: 0 0 0 6px rgba(79, 172, 254, 0.25);
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --card-bg: rgba(0, 0, 0, 0.5);
                --card-border: rgba(255, 255, 255, 0.3);
            }

            .metric-card, .problem-card, .families-card {
                border-width: 2px;
            }
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* ============== GLOBAL HEADER ============== */
        .global-header {
            padding: 12px 30px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue) 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .control-group label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            background: rgba(0,0,0,0.3);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 180px;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .btn-generate {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-blue), #00f2fe);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }
        
        /* ============== FEATURED DISTRICTS ============== */
        .featured-districts {
            padding: 10px 30px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .featured-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .featured-btn {
            padding: 6px 14px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            color: var(--accent-blue);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .featured-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--accent-blue);
        }
        
        /* ============== TAB NAVIGATION - MODERN BUTTON STYLE ============== */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid var(--card-border);
            overflow-x: auto;
            padding: 15px 20px;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(79, 172, 254, 0.15);
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.2);
        }

        .tab-btn.active {
            color: #fff;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-color: transparent;
            box-shadow: 0 5px 25px rgba(79, 172, 254, 0.4);
            transform: translateY(-2px);
        }

        .tab-btn.active::before {
            display: none;
        }

        .tab-btn.problems:hover {
            background: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.3);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.2);
        }

        .tab-btn.problems.active {
            background: linear-gradient(135deg, var(--accent-red), #ff8e8e);
            box-shadow: 0 5px 25px rgba(255, 107, 107, 0.4);
        }

        .tab-btn.solutions:hover {
            background: rgba(46, 213, 115, 0.15);
            border-color: rgba(46, 213, 115, 0.3);
            box-shadow: 0 5px 20px rgba(46, 213, 115, 0.2);
        }

        .tab-btn.solutions.active {
            background: linear-gradient(135deg, var(--accent-green), #7bed9f);
            box-shadow: 0 5px 25px rgba(46, 213, 115, 0.4);
        }

        /* Active indicator dot */
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: currentColor;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        @media (max-width: 900px) {
            .tab-nav {
                justify-content: flex-start;
                padding: 12px 15px;
                gap: 8px;
            }

            .tab-btn {
                padding: 10px 18px;
                font-size: 0.85rem;
                border-radius: 20px;
            }
        }

        @media (max-width: 500px) {
            .tab-btn {
                padding: 8px 14px;
                font-size: 0.8rem;
                border-radius: 18px;
            }
        }
        
        /* ============== FOR FAMILIES TAB STYLES ============== */
        .families-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .families-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .families-header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .families-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        .families-section {
            margin-bottom: 30px;
        }
        
        .families-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--card-border);
        }
        
        .families-card.problem-card-families {
            /* no border */
        }
        
        .families-card.highlight-card {
            /* no border */
        }
        
        .families-card.action-card {
            /* no border */
        }
        
        .families-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .families-card h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 25px;
        }
        
        .families-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .simple-text {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }
        
        /* Money Sources */
        .money-sources {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .source-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .source-icon {
            font-size: 2.5rem;
            min-width: 60px;
            text-align: center;
        }
        
        .source-text strong {
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .source-text p {
            margin-top: 5px;
            color: var(--text-secondary);
        }
        
        /* Problem List */
        .problem-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .problem-item-simple {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .problem-number {
            min-width: 40px;
            height: 40px;
            background: var(--accent-red);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .problem-explain strong {
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .problem-explain p {
            margin-top: 8px;
        }
        
        .highlight-red {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        /* Impact Grid */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .impact-item {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .impact-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .impact-text strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 8px;
        }
        
        .impact-text p {
            font-size: 0.9rem;
        }
        
        /* Action List */
        .action-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .action-icon {
            font-size: 2rem;
        }
        
        .action-text strong {
            font-size: 1rem;
        }
        
        .action-text p {
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        /* Action Link Styles */
        a.action-link {
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
        }
        
        .action-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .link-hint {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        .action-link:hover .link-hint {
            opacity: 1;
        }
        
        /* Glossary */
        .glossary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .glossary-item {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .glossary-item strong {
            color: var(--accent-blue);
            display: block;
            margin-bottom: 5px;
        }
        
        .glossary-item p {
            font-size: 0.9rem;
        }
        
        /* District Simple Stats */
        .district-simple-stats {
            padding: 20px;
        }
        
        /* Families Metrics Grid (KPI Cards) */
        .families-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .families-metric-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .families-metric-card:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: var(--accent-blue);
        }
        
        .families-metric-card.highlight-red {
            border-left: 4px solid var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(0, 0, 0, 0.3));
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .metric-icon {
            font-size: 1.2rem;
        }
        
        .metric-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        .metric-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .families-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 500px) {
            .families-metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .simple-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .simple-stat-item {
            text-align: center;
            padding: 25px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .simple-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        
        .simple-stat-value.negative {
            color: var(--accent-red);
        }
        
        .simple-stat-label {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .simple-stat-explain {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Responsive for Families */
        @media (max-width: 768px) {
            .impact-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-list {
                grid-template-columns: 1fr;
            }
            
            .glossary {
                grid-template-columns: 1fr;
            }
            
            .simple-stat-grid {
                grid-template-columns: 1fr;
            }
            
            .families-header h1 {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 500px) {
            .impact-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ============== TAB CONTENT ============== */
        .tab-content {
            display: none;
            padding: 20px 30px;
            max-width: 1500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ============== SECTION STYLES ============== */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.1rem;
            color: var(--accent-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* ============== TAB 1: MY DISTRICT - METRICS GRID ============== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 900px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 500px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
        
        .metric-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px 12px;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: rgba(79, 172, 254, 0.3);
            background: rgba(0,0,0,0.3);
        }
        
        .metric-card.status-red { /* no border */ }
        .metric-card.status-yellow { /* no border */ }
        .metric-card.status-green { /* no border */ }

        .metric-card.highlight-card {
            /* no special styling */
        }
        
        .metric-card.highlight-card .metric-value {
            font-size: 2rem;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .metric-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .metric-value.red { /* no color */ }
        .metric-value.yellow { /* no color */ }
        .metric-value.green { /* no color */ }
        .metric-value.blue { /* no color */ }
        
        .metric-subtitle {
            font-size: 0.7rem;
            color: #666;
        }
        
        /* Metric Card Tooltip */
        .metric-card {
            position: relative;
        }
        
        .metric-card .card-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 15, 30, 0.98);
            border: 1px solid rgba(79, 172, 254, 0.5);
            border-radius: 10px;
            padding: 15px;
            width: 280px;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        
        .metric-card .card-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(79, 172, 254, 0.5);
        }
        
        .metric-card:hover .card-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .card-tooltip .tt-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        
        .card-tooltip .tt-text {
            font-size: 0.8rem;
            color: #ccc;
            line-height: 1.5;
        }
        
        .card-tooltip .tt-text strong {
            color: #fff;
        }
        
        .card-tooltip .tt-highlight {
            color: var(--accent-yellow);
        }
        
        .card-tooltip .tt-warning {
            color: var(--accent-red);
            display: block;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(79, 172, 254, 0.3);
            color: var(--accent-blue);
            font-size: 0.6rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            font-style: normal;
            margin-left: 4px;
        }
        
        /* ============== INTERPRETATION TABLE ============== */
        .interpretation-table {
            margin-top: 25px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .interpretation-title {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .interpretation-table table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 0.85rem;
        }
        
        .interpretation-table th {
            text-align: left;
            padding: 12px 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .interpretation-table td {
            padding: 14px 15px;
            background: rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        
        .interpretation-table tr td:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .interpretation-table tr td:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        .interpretation-table tbody tr:hover td {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-badge.critical {
            background: rgba(255, 255, 255, 0.1);
        }

        .status-badge.warning {
            background: rgba(255, 255, 255, 0.1);
        }

        .status-badge.good {
            background: rgba(255, 255, 255, 0.1);
        }

        .status-badge.info {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* ============== GAP BREAKDOWN ============== */
        .gap-summary-header {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .gap-summary {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px 40px;
            text-align: center;
        }
        
        .gap-summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .gap-summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-red);
        }
        
        .gap-summary-total {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--card-border);
        }
        
        .gap-summary-total span {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        /* Gap breakdown bars */
        .gap-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .gap-bar-item {
            display: grid;
            grid-template-columns: 140px 1fr 100px;
            align-items: center;
            gap: 15px;
        }
        
        .gap-bar-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .gap-bar-track {
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .gap-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .gap-bar-fill.poverty { background: linear-gradient(90deg, #ff6b6b, #ff8e8e); }
        .gap-bar-fill.sped { background: linear-gradient(90deg, #feca57, #ffdd7f); }
        .gap-bar-fill.lea { background: linear-gradient(90deg, #a55eea, #c77dff); }
        .gap-bar-fill.msoc { background: linear-gradient(90deg, #4facfe, #7fc4ff); }
        .gap-bar-fill.region { background: linear-gradient(90deg, #2ed573, #7bed9f); }
        .gap-bar-fill.ell { background: linear-gradient(90deg, #ff9f43, #ffbe76); }
        
        .gap-bar-value {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
            color: var(--accent-red);
        }
        
        /* Gap Table Styles */
        .gap-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .gap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 0.85rem;
        }
        
        .gap-table th {
            text-align: left;
            padding: 12px 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .gap-table th:nth-child(2),
        .gap-table th:nth-child(3),
        .gap-table th:nth-child(4) {
            text-align: right;
        }
        
        .gap-table th:nth-child(5) {
            text-align: left;
            width: 280px;
        }
        
        .gap-table td {
            padding: 14px 15px;
            background: rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        
        .gap-table tr td:first-child {
            border-radius: 8px 0 0 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .gap-table tr td:last-child {
            border-radius: 0 8px 8px 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .gap-table tr td:nth-child(2),
        .gap-table tr td:nth-child(3),
        .gap-table tr td:nth-child(4) {
            text-align: right;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        .gap-table tbody tr:hover td {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .gap-table .current { color: var(--accent-yellow); }
        .gap-table .need { color: var(--accent-blue); }
        .gap-table .gap-positive { color: var(--accent-green); }
        .gap-table .gap-negative { color: var(--accent-red); font-weight: 600; }
        
        .gap-table .category-bar {
            display: inline-block;
            width: 4px;
            height: 20px;
            border-radius: 2px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .gap-table .bar-poverty { background: #ff6b6b; }
        .gap-table .bar-sped { background: #feca57; }
        .gap-table .bar-ell { background: #ff9f43; }
        .gap-table .bar-region { background: #2ed573; }
        .gap-table .bar-lea { background: #a55eea; }
        .gap-table .bar-msoc { background: #4facfe; }
        
        /* ============== GAP + REFORM COMBINED LAYOUT ============== */
        .gap-summary-header {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .gap-summary-header .gap-summary {
            flex: 1;
        }
        
        .gap-reform-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gap-reform-row {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .gap-reform-row:hover {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .gap-reform-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .gap-category {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 140px;
        }
        
        .gap-values {
            display: flex;
            gap: 25px;
        }
        
        .gap-col {
            text-align: right;
            min-width: 80px;
        }
        
        .gap-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .gap-value {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .gap-value.current { color: var(--accent-yellow); }
        .gap-value.need { color: var(--accent-blue); }
        .gap-value.gap-negative { color: var(--accent-red); }
        .gap-value.gap-positive { color: var(--accent-green); }
        
        .gap-reform-slider {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .slider-row .slider-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 100px;
        }
        
        .slider-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
        }
        
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        
        .slider-row input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        
        /* Category-specific slider colors */
        .gap-reform-row[data-category="poverty"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }
        .gap-reform-row[data-category="sped"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #feca57, #ffdd7f);
        }
        .gap-reform-row[data-category="ell"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #ff9f43, #ffbe76);
        }
        .gap-reform-row[data-category="region"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }
        .gap-reform-row[data-category="lea"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #a55eea, #c77dff);
        }
        .gap-reform-row[data-category="msoc"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #4facfe, #7fc4ff);
        }
        
        /* Firefox slider thumb */
        .slider-row input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .gap-reform-row[data-category="poverty"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }
        .gap-reform-row[data-category="sped"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #feca57, #ffdd7f);
        }
        .gap-reform-row[data-category="ell"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #ff9f43, #ffbe76);
        }
        .gap-reform-row[data-category="region"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }
        .gap-reform-row[data-category="lea"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #a55eea, #c77dff);
        }
        .gap-reform-row[data-category="msoc"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #4facfe, #7fc4ff);
        }
        
        .slider-row .slider-value {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--accent-cyan);
            min-width: 60px;
            text-align: right;
            font-weight: 600;
        }
        
        .slider-impact {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-left: 112px;
        }
        
        .reform-presets {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--card-border);
        }
        
        .preset-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }
        
        @media (max-width: 900px) {
            .gap-summary-header {
                flex-direction: column;
            }
            
            .gap-reform-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .gap-reform-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .slider-impact {
                padding-left: 0;
            }
            
            .reform-presets {
                flex-wrap: wrap;
            }
        }
        
        /* ============== STATEWIDE COMPARISON CHART ============== */
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .chart-container svg {
            width: 100%;
            height: 100%;
        }
        
        .axis text { fill: var(--text-secondary); font-size: 11px; }
        .axis line, .axis path { stroke: rgba(255,255,255,0.2); }
        .grid line { stroke: rgba(255,255,255,0.05); }
        
        .dot {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dot:hover {
            filter: brightness(1.3);
        }
        
        .dot.highlighted {
            stroke: var(--accent-blue);
            stroke-width: 3;
        }
        
        /* ============== REFORM SIMULATOR ============== */
        .simulator-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .simulator-grid { grid-template-columns: 1fr; }
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .slider-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .slider-value {
            font-size: 0.9rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }
        
        .slider-impact {
            font-size: 0.75rem;
            color: var(--accent-green);
            margin-top: 5px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-yellow), #ff9f43);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(254, 202, 87, 0.4);
        }
        
        .reform-result {
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid rgba(46, 213, 115, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .reform-result-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .reform-result-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .reform-comparison {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .reform-item {
            text-align: center;
        }
        
        .reform-item .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .reform-item .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .reform-item .value.before { color: var(--accent-red); }
        .reform-item .value.after { color: var(--accent-green); }
        
        /* ============== TAB 2: PROBLEMS ============== */
        .problems-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .problems-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .problems-grid { grid-template-columns: 1fr; }
        }
        
        .problem-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .problem-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.2);
        }
        
        .problem-card.expanded {
            grid-column: span 3;
        }
        
        @media (max-width: 1200px) {
            .problem-card.expanded { grid-column: span 2; }
        }
        
        @media (max-width: 768px) {
            .problem-card.expanded { grid-column: span 1; }
        }
        
        .problem-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .problem-title {
            font-size: 1.1rem;
            color: var(--accent-red);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .problem-summary {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .problem-impact {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
        }
        
        .problem-impact-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 5px;
        }
        
        .problem-impact-value {
            color: var(--accent-red);
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .problem-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--card-border);
        }
        
        .problem-card.expanded .problem-details {
            display: block;
        }
        
        /* ============== TAB 3: COMPARE ============== */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .compare-container { grid-template-columns: 1fr; }
        }
        
        .compare-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .compare-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preset-btn:hover, .preset-btn.active {
            background: rgba(79, 172, 254, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .comparison-table th {
            text-align: left;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .comparison-table tr:hover {
            background: rgba(79, 172, 254, 0.05);
        }
        
        .diff-positive { color: var(--accent-red); }
        .diff-negative { color: var(--accent-green); }
        
        .ranking-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .ranking-card .rank-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .ranking-card .rank-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .ranking-card .rank-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .ranking-card .rank-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), #00f2fe);
            border-radius: 4px;
        }
        
        .ranking-card .rank-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* ============== TAB 4: SOLUTIONS ============== */
        .timeline-container {
            position: relative;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .timeline-line {
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            transform: translateY(-50%);
            border-radius: 2px;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
            padding: 0 5%;
        }
        
        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .timeline-item:hover .timeline-dot {
            transform: scale(1.2);
        }
        
        .timeline-item.active .timeline-dot {
            background: var(--accent-green);
            box-shadow: 0 0 20px rgba(46, 213, 115, 0.5);
        }
        
        .timeline-dot {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(79, 172, 254, 0.3);
            border: 3px solid var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .timeline-year {
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .timeline-session {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .year-detail {
            background: var(--card-bg);
            border: 1px solid rgba(46, 213, 115, 0.3);
            border-radius: 12px;
            padding: 25px;
        }
        
        .year-detail h3 {
            color: var(--accent-green);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .policy-card {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--accent-blue);
        }
        
        .policy-card.priority-high { border-left-color: var(--accent-red); }
        .policy-card.priority-medium { border-left-color: var(--accent-yellow); }
        .policy-card.priority-low { border-left-color: var(--accent-green); }
        
        .policy-card h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .policy-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .policy-card .cost {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--card-border);
            font-size: 0.85rem;
        }
        
        .policy-card .cost span {
            color: var(--accent-yellow);
            font-weight: 600;
        }
        
        /* ============== TAB 5: BRIEF ============== */
        .brief-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            color: #333;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .brief-header {
            text-align: center;
            border-bottom: 3px solid var(--accent-blue);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .brief-header h1 {
            color: #1a1a2e;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .brief-header .subtitle {
            color: #666;
            font-size: 0.9rem;
        }
        
        .brief-section {
            margin-bottom: 25px;
        }
        
        .brief-section h2 {
            color: #1a1a2e;
            font-size: 1rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .brief-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .brief-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .brief-metric .label { color: #666; }
        .brief-metric .value { font-weight: 600; color: #333; }
        .brief-metric .value.gap { color: #ff6b6b; }
        
        .brief-challenges {
            list-style: none;
        }
        
        .brief-challenges li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .brief-challenges .challenge-title {
            font-weight: 600;
            color: #333;
        }
        
        .brief-challenges .challenge-impact {
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        .brief-actions {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .brief-actions li {
            padding: 5px 0;
            color: #333;
        }
        
        .brief-actions .benefit {
            color: #2ed573;
            font-weight: 600;
        }
        
        .brief-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
        }
        
        .brief-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .brief-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .brief-btn.print {
            background: var(--accent-blue);
            color: #fff;
        }
        
        .brief-btn.copy {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }
        
        .brief-btn:hover {
            transform: translateY(-2px);
        }
        
        /* ============== TAB 6: ABOUT ============== */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .about-grid { grid-template-columns: 1fr; }
        }
        
        .about-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 25px;
        }
        
        .about-card h3 {
            color: var(--accent-blue);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .about-card p, .about-card li {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .about-card ul {
            list-style: none;
            margin-top: 10px;
        }
        
        .about-card li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .about-card li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }
        
        .about-card code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--accent-yellow);
        }
        
        .lea-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .lea-table th, .lea-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }
        
        .lea-table th {
            background: rgba(0,0,0,0.2);
            color: var(--accent-blue);
        }
        
        /* ============== TOOLTIP ============== */
        .tooltip {
            position: absolute;
            background: rgba(10, 15, 30, 0.98);
            border: 1px solid rgba(79, 172, 254, 0.5);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 4px 0;
            font-size: 0.8rem;
        }
        
        .tooltip-row span:first-child { color: var(--text-secondary); }
        .tooltip-row .gap { color: var(--accent-red); font-weight: 600; }
        
        /* ============== PRINT STYLES ============== */
        @media print {
            body {
                background: #fff;
                color: #333;
            }
            
            .global-header, .featured-districts, .tab-nav, .brief-controls {
                display: none !important;
            }
            
            .tab-content {
                display: none !important;
            }
            
            .tab-content.brief-print {
                display: block !important;
            }
            
            .brief-container {
                box-shadow: none;
                max-width: 100%;
            }
        }
        
        /* ============== LOADING STATE ============== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(79, 172, 254, 0.2);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============== LOADING OVERLAY ============== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            z-index: 9999;
            color: var(--text-primary);
        }

        .loading-overlay.active {
            display: flex;
        }

        /* ============== ENHANCED MOBILE STYLES ============== */
        @media (max-width: 768px) {
            .global-header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 10px;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .control-group {
                flex: 1;
                min-width: 0;
            }

            .control-group select {
                min-width: unset;
                width: 100%;
                font-size: 14px;
                padding: 10px 8px;
            }

            .btn-generate {
                width: 100%;
                justify-content: center;
                padding: 12px;
                font-size: 1rem;
            }

            .featured-districts {
                padding: 10px 15px;
                overflow-x: auto;
                justify-content: flex-start;
            }

            .featured-btn {
                flex-shrink: 0;
            }

            .tab-nav {
                padding: 0 10px;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 0.8rem;
            }

            .tab-content {
                padding: 15px;
            }

            .families-header h1 {
                font-size: 1.6rem;
            }

            .families-card {
                padding: 20px;
            }

            .source-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .problem-item-simple {
                flex-direction: column;
                gap: 15px;
            }

            .problem-number {
                align-self: flex-start;
            }

            .action-list {
                grid-template-columns: 1fr;
            }

            .section-title {
                font-size: 1rem;
            }

            .gap-reform-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .gap-reform-info {
                flex-direction: column;
                gap: 8px;
            }

            .gap-values {
                gap: 15px;
            }

            .slider-row {
                flex-wrap: wrap;
            }

            .slider-row .slider-label {
                min-width: 100%;
                margin-bottom: 5px;
            }

            .reform-presets {
                flex-direction: column;
                align-items: stretch;
            }

            .reform-presets span {
                text-align: center;
            }

            .compare-container {
                grid-template-columns: 1fr;
            }

            .brief-container {
                padding: 20px;
                margin: 10px;
            }

            .brief-header h1 {
                font-size: 1.2rem;
            }

            .brief-metrics {
                grid-template-columns: 1fr;
            }

            .timeline {
                flex-direction: column;
                gap: 20px;
                padding: 0;
            }

            .timeline-line {
                display: none;
            }

            .timeline-item {
                flex-direction: row;
                gap: 15px;
            }

            .policy-grid {
                grid-template-columns: 1fr;
            }

            .simulator-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============== VERY SMALL SCREENS ============== */
        @media (max-width: 400px) {
            .header-controls {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            .families-header h1 {
                font-size: 1.3rem;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 0.75rem;
            }

            .metric-card {
                padding: 12px 10px;
            }

            .metric-value {
                font-size: 1.4rem;
            }
        }

        /* ============== SMOOTH SCROLLING ============== */
        html {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }

        /* ============== BETTER TOUCH TARGETS ============== */
        @media (pointer: coarse) {
            .tab-btn, .featured-btn, .preset-btn, .action-item {
                min-height: 44px;
            }

            select, input[type="range"] {
                min-height: 44px;
            }

            .problem-card {
                min-height: 44px;
            }
        }

        /* ============== ENHANCED VISUAL EFFECTS ============== */
        /* Card hover effects */
        .metric-card, .problem-card, .families-card, .about-card {
            transition: transform var(--transition-normal),
                        box-shadow var(--transition-normal),
                        border-color var(--transition-normal);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(79, 172, 254, 0.15);
        }

        .families-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        /* Button shine effect */
        .btn-generate {
            position: relative;
            overflow: hidden;
        }

        .btn-generate::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 70%
            );
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .btn-generate:hover::after {
            transform: translateX(100%);
        }

        /* Tab button active indicator */
        .tab-btn {
            position: relative;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--accent-blue);
            transition: width var(--transition-normal), left var(--transition-normal);
        }

        .tab-btn.active::before,
        .tab-btn:hover::before {
            width: 100%;
            left: 0;
        }

        .tab-btn.problems.active::before,
        .tab-btn.problems:hover::before {
            background: var(--accent-red);
        }

        .tab-btn.solutions.active::before,
        .tab-btn.solutions:hover::before {
            background: var(--accent-green);
        }

        /* Fade in animation for tab content */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            animation: slideUp 0.4s ease-out;
        }

        /* Pulse animation for important values */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .metric-card.highlight-card .metric-value {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Staggered card animations */
        .metrics-grid .metric-card,
        .problems-grid .problem-card {
            opacity: 0;
            animation: slideUp 0.5s ease-out forwards;
        }

        .metrics-grid .metric-card:nth-child(1) { animation-delay: 0.05s; }
        .metrics-grid .metric-card:nth-child(2) { animation-delay: 0.1s; }
        .metrics-grid .metric-card:nth-child(3) { animation-delay: 0.15s; }
        .metrics-grid .metric-card:nth-child(4) { animation-delay: 0.2s; }
        .metrics-grid .metric-card:nth-child(5) { animation-delay: 0.25s; }
        .metrics-grid .metric-card:nth-child(6) { animation-delay: 0.3s; }
        .metrics-grid .metric-card:nth-child(7) { animation-delay: 0.35s; }
        .metrics-grid .metric-card:nth-child(8) { animation-delay: 0.4s; }
        .metrics-grid .metric-card:nth-child(9) { animation-delay: 0.45s; }

        /* Progress bar animation */
        @keyframes growWidth {
            from { width: 0; }
        }

        .gap-bar-fill, .rank-fill {
            animation: growWidth 0.8s ease-out;
        }

        /* Gradient text for headers */
        .families-header h1,
        .section-title {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Improved scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--accent-cyan), var(--accent-blue));
        }

        /* Selection color */
        ::selection {
            background: rgba(79, 172, 254, 0.3);
            color: #fff;
        }

        /* ============== PIE CHART STYLES ============== */
        .pie-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            padding: 20px 0;
        }

        .pie-chart-wrapper {
            position: relative;
            width: 220px;
            height: 220px;
        }

        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #2563eb 0% 70%,
                #10b981 70% 92%,
                #ffc107 92% 100%
            );
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3),
                        inset 0 0 30px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .pie-chart:hover {
            transform: scale(1.02);
        }

        .pie-chart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .pie-chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }

        .pie-chart-center .total-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pie-chart-center .total-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pie-legend-item:hover {
            background: rgba(79, 172, 254, 0.15);
            transform: translateX(5px);
        }

        .pie-legend-item.state { border-left: 4px solid #2563eb; }
        .pie-legend-item.local { border-left: 4px solid #10b981; }
        .pie-legend-item.federal { border-left: 4px solid #ffc107; }

        .legend-color {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .legend-color.state { background: linear-gradient(135deg, #2563eb, #3b82f6); }
        .legend-color.local { background: linear-gradient(135deg, #10b981, #34d399); }
        .legend-color.federal { background: linear-gradient(135deg, #ffc107, #ffd54f); }

        .legend-info {
            flex: 1;
        }

        .legend-info strong {
            display: block;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .legend-info p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0;
        }

        .legend-values {
            text-align: right;
        }

        .legend-percent {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .legend-amount {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            margin-top: 2px;
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .legend-percent.state { color: #3b82f6; }
        .legend-percent.local { color: #10b981; }
        .legend-percent.federal { color: #ffc107; }

        @media (max-width: 768px) {
            .pie-chart-container {
                flex-direction: column;
                gap: 25px;
            }

            .pie-chart-wrapper {
                width: 180px;
                height: 180px;
            }

            .pie-chart::before {
                width: 80px;
                height: 80px;
            }

            .pie-legend {
                width: 100%;
            }

            .pie-legend-item {
                padding: 10px 12px;
            }

            .legend-color {
                width: 35px;
                height: 35px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- GLOBAL HEADER -->
    <header class="global-header" role="banner">
        <div class="header-left">
            <div class="logo">
                ðŸŽ“ WA K-12 Funding Gap Analysis
            </div>
        </div>
        <div class="header-controls">
            <div class="control-group">
                <label>County</label>
                <select id="countySelect" onchange="filterByCounty()">
                    <option value="">All Counties</option>
                </select>
            </div>
            <div class="control-group">
                <label>District</label>
                <select id="districtSelect" onchange="selectDistrict()">
                    <option value="">Select a District...</option>
                </select>
            </div>
            <div class="control-group">
                <label>Year</label>
                <select id="yearSelect" onchange="updateYear()">
                    <option value="2024-25" selected>2024-25</option>
                    <option value="2023-24">2023-24</option>
                    <option value="2022-23">2022-23</option>
                    <option value="2021-22">2021-22</option>
                    <option value="2020-21">2020-21</option>
                    <option value="2019-20">2019-20</option>
                </select>
            </div>
            <button class="btn-generate" onclick="generateBrief()">
                ðŸ“„ Generate Brief
            </button>
        </div>
    </header>
    
    <!-- TAB NAVIGATION -->
    <nav class="tab-nav" role="tablist" aria-label="Dashboard sections">
        <button class="tab-btn active" onclick="showTab('families', this)" role="tab" aria-selected="true" aria-controls="tab-families" id="btn-families">Quick Guide</button>
        <button class="tab-btn" onclick="showTab('mydistrict', this)" role="tab" aria-selected="false" aria-controls="tab-mydistrict" id="btn-mydistrict">My District</button>
        <button class="tab-btn problems" onclick="showTab('problems', this)" role="tab" aria-selected="false" aria-controls="tab-problems" id="btn-problems">6 Problems</button>
        <button class="tab-btn" onclick="showTab('compare', this)" role="tab" aria-selected="false" aria-controls="tab-compare" id="btn-compare">Compare</button>
        <button class="tab-btn solutions" onclick="showTab('solutions', this)" role="tab" aria-selected="false" aria-controls="tab-solutions" id="btn-solutions">Solutions</button>
        <button class="tab-btn" onclick="showTab('brief', this)" role="tab" aria-selected="false" aria-controls="tab-brief" id="btn-brief">Brief</button>
        <button class="tab-btn" onclick="showTab('about', this)" role="tab" aria-selected="false" aria-controls="tab-about" id="btn-about">About</button>
    </nav>
    
    <!-- TAB 0: FOR FAMILIES (Easy Guide) -->
    <main id="main-content">
    <div id="tab-families" class="tab-content active" role="tabpanel" aria-labelledby="btn-families">
        <div class="families-container">
            <div class="families-header">
                <h1>ðŸ  Understanding School Funding</h1>
                <p class="families-subtitle">A simple guide for parents and students</p>
            </div>
            
            <!-- Section 1: The Basics - Pie Chart -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon">ðŸ’°</div>
                    <h2>Where Does School Money Come From?</h2>
                    <div class="families-content">
                        <div class="pie-chart-container">
                            <!-- Pie Chart -->
                            <div class="pie-chart-wrapper" role="img" aria-label="Pie chart showing school funding sources" id="pie-chart-aria">
                                <div class="pie-chart" id="pie-chart"></div>
                                <div class="pie-chart-center">
                                    <div class="total-label">Total Budget</div>
                                    <div class="total-value" id="pie-total-amt">$0</div>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="pie-legend">
                                <div class="pie-legend-item state">
                                    <div class="legend-color state">ðŸ›ï¸</div>
                                    <div class="legend-info">
                                        <strong>State Government</strong>
                                        <p>Primary funding through state taxes</p>
                                    </div>
                                    <div class="legend-values">
                                        <div class="legend-percent state" id="pie-state-pct">70%</div>
                                        <div class="legend-amount" id="pie-state-amt">$0</div>
                                    </div>
                                </div>

                                <div class="pie-legend-item local">
                                    <div class="legend-color local">ðŸ˜ï¸</div>
                                    <div class="legend-info">
                                        <strong>Local Property Taxes</strong>
                                        <p>Voter-approved levies & bonds</p>
                                    </div>
                                    <div class="legend-values">
                                        <div class="legend-percent local" id="pie-local-pct">22%</div>
                                        <div class="legend-amount" id="pie-local-amt">$0</div>
                                    </div>
                                </div>

                                <div class="pie-legend-item federal">
                                    <div class="legend-color federal">ðŸ‡ºðŸ‡¸</div>
                                    <div class="legend-info">
                                        <strong>Federal Government</strong>
                                        <p>Title I, special ed, lunch programs</p>
                                    </div>
                                    <div class="legend-values">
                                        <div class="legend-percent federal" id="pie-federal-pct">8%</div>
                                        <div class="legend-amount" id="pie-federal-amt">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: The Problem -->
            <div class="families-section">
                <div class="families-card problem-card-families">
                    <div class="families-icon">âš ï¸</div>
                    <h2>Why Don't Schools Have Enough Money?</h2>
                    <div class="families-content">
                        <p class="simple-text">Washington State has some big problems with how it gives money to schools:</p>
                        
                        <div class="problem-list" id="guide-problem-list">
                            <div class="problem-item-simple">
                                <div class="problem-number">1</div>
                                <div class="problem-explain">
                                    <strong>No Extra Help for Poor Families</strong>
                                    <p><span id="guide-district-label">This district</span> has <span id="guide-li-pct">45%</span> low-income students who need extra support. Almost every other state gives extra money for this. Washington gives $0.</p>
                                    <p style="margin-top: 8px;">With a 20% poverty weight: <span id="guide-poverty-benefit">+$0</span> needs more funding</p>
                                </div>
                            </div>

                            <div class="problem-item-simple">
                                <div class="problem-number">2</div>
                                <div class="problem-explain">
                                    <strong>Special Education Cap</strong>
                                    <p><span id="guide-district-label2">This district</span> has <span id="guide-sped-pct">15.5%</span> SpEd students. The state only pays up to 15.5%. <span id="guide-sped-status">Students over cap get no state funding.</span></p>
                                    <p style="margin-top: 8px;" id="guide-sped-detail"></p>
                                </div>
                            </div>

                            <div class="problem-item-simple">
                                <div class="problem-number">3</div>
                                <div class="problem-explain">
                                    <strong>Not Enough for English Learners</strong>
                                    <p><span id="guide-district-label3">This district</span> has <span id="guide-ell-pct">12%</span> ELL students. Teaching English costs ~$2,500/student but state only gives $1,200.</p>
                                    <p style="margin-top: 8px;">ELL funding gap: <span id="guide-ell-gap">+$0</span> needs more funding</p>
                                </div>
                            </div>

                            <div class="problem-item-simple">
                                <div class="problem-number">4</div>
                                <div class="problem-explain">
                                    <strong>Operating Costs Frozen Since 2018</strong>
                                    <p>Money for daily school operations hasn't increased since 2018. Everything costs more now, but schools get the same $1,533/student.</p>
                                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">âš¡ Electricity</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ”¥ Heating & Gas</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ’§ Water</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ›¡ï¸ Insurance</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ“š Textbooks</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ’» Technology</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ§¹ Cleaning</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ”§ Repairs</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸšŒ Bus Fuel</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;">ðŸ“ Office Supplies</span>
                                    </div>
                                    <p style="margin-top: 10px; font-size: 0.9rem;"><span id="guide-district-label4">This district</span>: +<span id="guide-msoc-gap">$0</span>/year needs more funding</p>
                                </div>
                            </div>

                            <div class="problem-item-simple">
                                <div class="problem-number">5</div>
                                <div class="problem-explain">
                                    <strong>Unfair Local Levy Rules</strong>
                                    <p>Local levies are supposed to help, but the rules hurt both rich and poor districts:</p>
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;" id="guide-levy-box">
                                        <div style="margin-bottom: 10px;">
                                            <span>ðŸ“ <span id="guide-district-label5">Your District</span>:</span>
                                            <p style="margin-top: 4px;" id="guide-levy-status">Select a district to see levy details</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 3: Real Impact -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</div>
                    <h2>How Does This Affect Your Child?</h2>
                    <div class="families-content">
                        <div class="impact-grid">
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ‘©â€ðŸ«</div>
                                <div class="impact-text">
                                    <strong>Bigger Classes</strong>
                                    <p>Fewer teachers means more students per class</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ“š</div>
                                <div class="impact-text">
                                    <strong>Fewer Programs</strong>
                                    <p>Schools cut art, music, sports, and after-school activities</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ«</div>
                                <div class="impact-text">
                                    <strong>Old Buildings</strong>
                                    <p>No money to fix or update school facilities</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ’»</div>
                                <div class="impact-text">
                                    <strong>Less Technology</strong>
                                    <p>Older computers and fewer learning tools</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ§‘â€ðŸ¤â€ðŸ§‘</div>
                                <div class="impact-text">
                                    <strong>Less Help</strong>
                                    <p>Fewer counselors, nurses, and support staff</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon">ðŸ“–</div>
                                <div class="impact-text">
                                    <strong>Old Materials</strong>
                                    <p>Outdated textbooks and learning materials</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 4: Your District -->
            <div class="families-section">
                <div class="families-card highlight-card">
                    <div class="families-icon">ðŸ“</div>
                    <h2>What About <span id="familiesDistrictName">Your District</span>?</h2>
                    <div class="families-content">
                        <div class="district-simple-stats" id="familiesDistrictStats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 5: What You Can Do -->
            <div class="families-section">
                <div class="families-card action-card">
                    <div class="families-icon">âœŠ</div>
                    <h2>What Can You Do?</h2>
                    <div class="families-content">
                        <div class="action-list">
                            <a href="https://www.wastatepta.org/focus-areas/advocacy/" target="_blank" class="action-item action-link">
                                <div class="action-icon">ðŸ—³ï¸</div>
                                <div class="action-text">
                                    <strong>Vote YES on School Levies</strong>
                                    <p>Local levies help your school get more money</p>
                                    <span class="link-hint">â†’ WA State PTA Advocacy</span>
                                </div>
                            </a>
                            <a href="https://app.leg.wa.gov/districtfinder/" target="_blank" class="action-item action-link">
                                <div class="action-icon">ðŸ“§</div>
                                <div class="action-text">
                                    <strong>Contact Your Legislators</strong>
                                    <p>Tell them schools need more state funding</p>
                                    <span class="link-hint">â†’ Find Your WA Legislators</span>
                                </div>
                            </a>
                            <a href="https://www.wssda.org/about-us/calendar/" target="_blank" class="action-item action-link">
                                <div class="action-icon">ðŸ—£ï¸</div>
                                <div class="action-text">
                                    <strong>Attend School Board Meetings</strong>
                                    <p>Your voice matters in local decisions</p>
                                    <span class="link-hint">â†’ WSSDA Events Calendar</span>
                                </div>
                            </a>
                            <div class="action-item action-link" onclick="copyPageLink()" style="cursor: pointer;">
                                <div class="action-icon">ðŸ“¢</div>
                                <div class="action-text">
                                    <strong>Share This Information</strong>
                                    <p>Help other parents understand the problem</p>
                                    <span class="link-hint" id="shareHint">â†’ Click to copy link</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 6: Key Terms -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon">ðŸ“–</div>
                    <h2>Words to Know</h2>
                    <div class="families-content">
                        <div class="glossary">
                            <div class="glossary-item">
                                <strong>Levy</strong>
                                <p>Extra local taxes that voters approve to help schools</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Per-Pupil Funding</strong>
                                <p>How much money the school gets for each student</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Special Education (SpEd)</strong>
                                <p>Extra help for students with learning differences or disabilities</p>
                            </div>
                            <div class="glossary-item">
                                <strong>ELL (English Language Learner)</strong>
                                <p>Students who are learning English as a new language</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Low-Income / Free & Reduced Lunch</strong>
                                <p>Families who qualify for help with school meals based on income</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Funding Gap</strong>
                                <p>The difference between what schools need and what they actually get</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- TAB 1: MY DISTRICT -->
    <div id="tab-mydistrict" class="tab-content" role="tabpanel" aria-labelledby="btn-mydistrict">
        <div id="noDistrictMessage" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ«</div>
            <h2 style="color: var(--accent-blue); margin-bottom: 10px;">Select a District to Begin</h2>
            <p>Choose a district from the dropdown above or use the quick access buttons.</p>
        </div>
        
        <div id="districtContent" style="display: none;">
            <!-- Section 1: District Overview -->
            <section class="section">
                <h2 class="section-title">ðŸ“Š District Overview</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Populated by JS -->
                </div>
                
                <div class="interpretation-table" id="interpretationTable">
                    <div class="interpretation-title">ðŸ“ What These Numbers Mean</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 120px;">Metric</th>
                                <th style="width: 200px;">Value</th>
                                <th>Meaning</th>
                                <th style="width: 120px; text-align: right;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="interpretationBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Section 2: Gap Breakdown + Reform Simulator (Combined) -->
            <section class="section">
                <h2 class="section-title">ðŸ’° Funding Gap Breakdown & Reform Simulator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                    Adjust sliders to simulate policy reforms and see real-time impact on funding gaps.
                </p>
                
                <div class="gap-summary-header">
                    <div class="gap-summary">
                        <div class="gap-summary-label">Per-Pupil Funding Gap</div>
                        <div class="gap-summary-value" id="totalGapValue">-$0</div>
                        <div class="gap-summary-total">
                            Total Annual Shortfall: <span id="totalShortfall">$0</span>
                        </div>
                    </div>
                    <div class="gap-summary" style="background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(46, 213, 115, 0.05));">
                        <div class="gap-summary-label" style="color: var(--accent-green);">Reform Benefit</div>
                        <div class="gap-summary-value" id="newGapValue" style="color: var(--accent-green);">$0</div>
                        <div class="gap-summary-total" style="font-size: 0.75rem; line-height: 1.4;">
                            Additional funding per student<br>if these reforms pass
                        </div>
                    </div>
                </div>
                
                <div class="gap-reform-container">
                    <!-- Row 1: Low-Income -->
                    <div class="gap-reform-row" data-category="poverty">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-poverty"></span>
                                <span class="category-icon">ðŸ“Š</span> Low-Income
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="poverty-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="poverty-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="poverty-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">Poverty Weight</span>
                                <input type="range" id="povertyWeightSlider" min="0" max="35" value="0" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="povertyWeightValue">0%</span>
                            </div>
                            <div class="slider-impact" id="poverty-impact">WA currently provides $0 extra for low-income students</div>
                        </div>
                    </div>
                    
                    <!-- Row 2: SpEd -->
                    <div class="gap-reform-row" data-category="sped">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-sped"></span>
                                <span class="category-icon">â™¿</span> SpEd
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="sped-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="sped-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="sped-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">SpEd Cap</span>
                                <input type="range" id="spedCapSlider" min="155" max="250" value="155" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="spedCapValue">15.5%</span>
                            </div>
                            <div class="slider-impact" id="sped-impact">State caps funding at 15.5% SpEd rate</div>
                        </div>
                    </div>
                    
                    <!-- Row 3: ELL -->
                    <div class="gap-reform-row" data-category="ell">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-ell"></span>
                                <span class="category-icon">ðŸŒ</span> ELL
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="ell-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="ell-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="ell-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">TBIP Funding</span>
                                <input type="range" id="ellFundingSlider" min="1200" max="2500" value="1200" step="100" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="ellFundingValue">$1,200</span>
                            </div>
                            <div class="slider-impact" id="ell-impact">TBIP provides $1,200/ELL vs $2,500 actual cost</div>
                        </div>
                    </div>
                    
                    <!-- Row 4: Regionalization -->
                    <div class="gap-reform-row" data-category="region">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-region"></span>
                                <span class="category-icon">ðŸ—ºï¸</span> Regionalization
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="region-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="region-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="region-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">CIS Floor</span>
                                <input type="range" id="regionMinSlider" min="100" max="104" value="100" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="regionMinValue">1.00</span>
                            </div>
                            <div class="slider-impact" id="region-impact">Current CIS ranges from 1.00 to 1.04</div>
                        </div>
                    </div>
                    
                    <!-- Row 5: Local Levy -->
                    <div class="gap-reform-row" data-category="lea">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-lea"></span>
                                <span class="category-icon">ðŸ¦</span> Local Levy
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="lea-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="lea-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="lea-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">Voter-Approved</span>
                                <input type="range" id="leaThresholdSlider" min="2021" max="5000" value="2021" step="50" disabled style="opacity: 0.6;">
                                <span class="slider-value" id="leaThresholdValue">$2,021</span>
                            </div>
                            <div class="slider-impact" id="lea-impact">Fixed at voter-approved amount</div>
                        </div>
                    </div>
                    
                    <!-- Row 6: MSOC -->
                    <div class="gap-reform-row" data-category="msoc">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-msoc"></span>
                                <span class="category-icon">ðŸ“¦</span> MSOC
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="msoc-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="msoc-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="msoc-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">MSOC Amount</span>
                                <input type="range" id="msocSlider" min="1533" max="2200" value="1533" step="50" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="msocValue">$1,533</span>
                            </div>
                            <div class="slider-impact" id="msoc-impact">Frozen since 2018, should be ~$1,980</div>
                        </div>
                    </div>
                </div>
                
                <div class="reform-presets">
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Quick Presets:</span>
                    <button class="preset-btn" onclick="applyPreset('reset')">ðŸ”„ Reset</button>
                    <button class="preset-btn" onclick="applyPreset('moderate')">ðŸ“Š Moderate Reform</button>
                    <button class="preset-btn" onclick="applyPreset('aggressive')">ðŸš€ Full Equity</button>
                    <button class="preset-btn" onclick="applyPreset('district')">ðŸŽ¯ District-Optimized</button>
                </div>
            </section>
            
            <!-- Section 3: Statewide Comparison -->
            <section class="section">
                <div class="section-header-row">
                    <h2 class="section-title">ðŸ—ºï¸ Statewide Comparison</h2>
                    <div class="control-group">
                        <select id="chartXAxis" onchange="updateComparisonChart()">
                            <option value="lowIncome">Low-Income % (X-Axis)</option>
                            <option value="ell">ELL % (X-Axis)</option>
                            <option value="sped">SpEd % (X-Axis)</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" id="comparisonChart">
                    <svg id="scatterSvg"></svg>
                </div>
            </section>
        </div>
    </div>
    
    <!-- TAB 2: THE 6 PROBLEMS -->
    <div id="tab-problems" class="tab-content" role="tabpanel" aria-labelledby="btn-problems">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="margin-bottom: 10px;">âš ï¸ 6 Structural Problems in WA's Funding Model</h2>
            <p style="color: var(--text-secondary);">Click each card to see detailed analysis and impact on <span id="problemDistrictName">your district</span></p>
        </div>
        
        <div class="problems-grid" id="problemsGrid">
            <!-- Problem 1: No Poverty Weight -->
            <div class="problem-card" onclick="toggleProblem(this, 1)">
                <div class="problem-icon">ðŸ’°</div>
                <div class="problem-title">No Poverty Weight</div>
                <div class="problem-summary">
                    Washington is 1 of only 3 states without additional funding for low-income students.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Impact on Your District</div>
                    <div class="problem-impact-value" id="problem1Impact">$0 unfunded</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Low-income students require additional support services, smaller class sizes, and intervention programs. 
                        Without a poverty weight, high-poverty districts must fund these with local levies, creating systematic inequality.
                    </p>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong style="color: var(--accent-yellow);">If WA adopted a 20% poverty weight:</strong>
                        <div id="problem1Solution" style="color: var(--accent-green); font-size: 1.2rem; margin-top: 10px;">+$0 for your district</div>
                    </div>
                </div>
            </div>
            
            <!-- Problem 2: SpEd Cap -->
            <div class="problem-card" onclick="toggleProblem(this, 2)">
                <div class="problem-icon">â™¿</div>
                <div class="problem-title">SpEd 15.5% Cap</div>
                <div class="problem-summary">
                    State funding is capped at 15.5% regardless of actual special education population.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Impact on Your District</div>
                    <div class="problem-impact-value" id="problem2Impact">0% above cap</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Many districts serve SpEd populations well above 15.5%. Each student above the cap costs $25,000+ annually 
                        but receives no state funding, forcing districts to cut general education programs.
                    </p>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong style="color: var(--accent-yellow);">If cap raised to 17.5%:</strong>
                        <div id="problem2Solution" style="color: var(--accent-green); font-size: 1.2rem; margin-top: 10px;">+$0 for your district</div>
                    </div>
                </div>
            </div>
            
            <!-- Problem 3: MSOC Freeze -->
            <div class="problem-card" onclick="toggleProblem(this, 3)">
                <div class="problem-icon">ðŸ“¦</div>
                <div class="problem-title">MSOC Frozen Since 2018</div>
                <div class="problem-summary">
                    Materials, Supplies, Operating Costs haven't kept pace with inflation since McCleary.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Statewide Impact</div>
                    <div class="problem-impact-value">~$350M shortfall</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Insurance premiums have risen 100%+, utilities 50%+, but MSOC allocations remain at 2018 levels.
                        This silent erosion forces districts to cut classroom spending to pay fixed costs.
                    </p>
                </div>
            </div>
            
            <!-- Problem 4: Regionalization -->
            <div class="problem-card" onclick="toggleProblem(this, 4)">
                <div class="problem-icon">ðŸ—ºï¸</div>
                <div class="problem-title">Regressive Regionalization</div>
                <div class="problem-summary">
                    Cost-of-living factors (CIS/CLS) don't reflect actual regional cost differences.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Your District's CIS Factor</div>
                    <div class="problem-impact-value" id="problem4Impact">1.00</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Districts with CIS below 1.04 receive less funding per staff position despite needing competitive 
                        salaries to attract teachers. This creates hiring disadvantages for suburban and rural districts.
                    </p>
                </div>
            </div>
            
            <!-- Problem 5: LEA Inequality -->
            <div class="problem-card" onclick="toggleProblem(this, 5)">
                <div class="problem-icon">ðŸ¦</div>
                <div class="problem-title">LEA Inequality</div>
                <div class="problem-summary">
                    Property-poor districts can't raise equivalent local revenue even at maximum levy rates.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">LEA Status</div>
                    <div class="problem-impact-value" id="problem5Impact">Loading...</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Local Effort Assistance (LEA) attempts to equalize, but thresholds have lagged behind inflation.
                        HB 2049 increases the threshold to $2,227.84 in 2026, helping but not fully solving the gap.
                    </p>
                    <table class="lea-table">
                        <tr><th>Year</th><th>Threshold</th><th>Policy</th></tr>
                        <tr><td>2025</td><td>$2,021</td><td>Seattle CPI</td></tr>
                        <tr><td>2026</td><td>$2,227.84</td><td>HB 2049: IPD+$200</td></tr>
                        <tr><td>2027</td><td>$2,547.35</td><td>Projected</td></tr>
                    </table>
                </div>
            </div>
            
            <!-- Problem 6: Enrollment Decline -->
            <div class="problem-card" onclick="toggleProblem(this, 6)">
                <div class="problem-icon">ðŸ“‰</div>
                <div class="problem-title">Enrollment Decline Cliff</div>
                <div class="problem-summary">
                    No "hold harmless" provision - funding drops immediately with enrollment.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Your Enrollment Change</div>
                    <div class="problem-impact-value" id="problem6Impact">0%</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Fixed costs (buildings, staff contracts) don't scale linearly with enrollment. 
                        A 5% enrollment decline doesn't mean 5% fewer teachers are needed, but funding drops exactly 5%.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAB 3: COMPARE -->
    <div id="tab-compare" class="tab-content" role="tabpanel" aria-labelledby="btn-compare">
        <section class="section">
            <h2 class="section-title">ðŸ“ˆ District Comparison</h2>
            
            <div class="compare-selector">
                <div class="control-group">
                    <label>Compare To</label>
                    <select id="compareToSelect" onchange="updateComparison()">
                        <option value="state">State Average</option>
                        <option value="county">County Average</option>
                        <option value="district">Specific District</option>
                    </select>
                </div>
                <div class="control-group" id="compareDistrictGroup" style="display: none;">
                    <label>Select District</label>
                    <select id="compareDistrictSelect" onchange="updateComparison()"></select>
                </div>
                <div class="compare-presets">
                    <button class="preset-btn" onclick="comparePreset('size', this)">Similar Size</button>
                    <button class="preset-btn" onclick="comparePreset('demographics', this)">Similar Demographics</button>
                    <button class="preset-btn" onclick="comparePreset('county', this)">Same County</button>
                </div>
            </div>
        </section>
        
        <div class="compare-container">
            <section class="section">
                <h3 class="section-title">Side-by-Side Metrics</h3>
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th id="compareCol1">Your District</th>
                            <th id="compareCol2">State Average</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </section>
            
            <div class="rankings-sidebar">
                <div class="ranking-card">
                    <div class="rank-label">Funding Gap Ranking</div>
                    <div class="rank-value" id="gapRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="gapRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="gapRankDesc">Select a district</div>
                </div>
                
                <div class="ranking-card">
                    <div class="rank-label">Low-Income % Ranking</div>
                    <div class="rank-value" id="povertyRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="povertyRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="povertyRankDesc">Select a district</div>
                </div>
                
                <div class="ranking-card">
                    <div class="rank-label">SpEd % Ranking</div>
                    <div class="rank-value" id="spedRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="spedRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="spedRankDesc">Select a district</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAB 4: SOLUTIONS -->
    <div id="tab-solutions" class="tab-content" role="tabpanel" aria-labelledby="btn-solutions">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--accent-green); margin-bottom: 10px;">âœ… 5-Year Reform Roadmap</h2>
            <p style="color: var(--text-secondary);">Click a year to see proposed policy changes</p>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-line"></div>
            <div class="timeline">
                <div class="timeline-item active" onclick="selectYear(2025, this)">
                    <div class="timeline-dot">Y1</div>
                    <div class="timeline-year">2025</div>
                    <div class="timeline-session">Long Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2026, this)">
                    <div class="timeline-dot">Y2</div>
                    <div class="timeline-year">2026</div>
                    <div class="timeline-session">Short Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2027, this)">
                    <div class="timeline-dot">Y3</div>
                    <div class="timeline-year">2027</div>
                    <div class="timeline-session">Long Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2028, this)">
                    <div class="timeline-dot">Y4</div>
                    <div class="timeline-year">2028</div>
                    <div class="timeline-session">Short Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2029, this)">
                    <div class="timeline-dot">Y5</div>
                    <div class="timeline-year">2029</div>
                    <div class="timeline-session">Long Session</div>
                </div>
            </div>
        </div>
        
        <div class="year-detail" id="yearDetail">
            <h3>ðŸ“… Year 1 (2025): Emergency Repairs</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Estimated Total Cost: <span style="color: var(--accent-yellow); font-weight: 600;">$1.2B</span></p>
            <div class="policy-grid" id="policyGrid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <section class="section" style="margin-top: 30px;">
            <h2 class="section-title">ðŸ”§ Policy Simulator</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Adjust parameters to see the combined impact on your district</p>
            
            <div class="simulator-grid">
                <div class="sliders-container">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Poverty Weight</span>
                            <span class="slider-value" id="solPovertyValue">0%</span>
                        </div>
                        <input type="range" id="solPovertySlider" min="0" max="30" value="20" oninput="updateSolutionSimulator()">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">SpEd Cap Increase</span>
                            <span class="slider-value" id="solSpedValue">15.5%</span>
                        </div>
                        <input type="range" id="solSpedSlider" min="155" max="200" value="175" oninput="updateSolutionSimulator()">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">LEA Threshold</span>
                            <span class="slider-value" id="solLeaValue">$2,228</span>
                        </div>
                        <input type="range" id="solLeaSlider" min="2021" max="3500" value="2228" step="50" oninput="updateSolutionSimulator()">
                    </div>
                </div>
                
                <div class="reform-result">
                    <div class="reform-result-label">Total Benefit to Your District</div>
                    <div class="reform-result-value" id="solTotalBenefit">+$0/year</div>
                    <div class="reform-comparison">
                        <div class="reform-item">
                            <div class="label">Per Student</div>
                            <div class="value after" id="solPerStudent">+$0</div>
                        </div>
                        <div class="reform-item">
                            <div class="label">Statewide Cost</div>
                            <div class="value" style="color: var(--accent-yellow);" id="solStatewideCost">$0B</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- TAB 5: 1-PAGE BRIEF -->
    <div id="tab-brief" class="tab-content" role="tabpanel" aria-labelledby="btn-brief">
        <div class="brief-controls">
            <button class="brief-btn print" onclick="printBrief()">ðŸ–¨ï¸ Print Brief</button>
            <button class="brief-btn copy" onclick="copyBrief()">ðŸ“‹ Copy Text</button>
        </div>
        
        <div class="brief-container" id="briefContainer">
            <div class="brief-header">
                <h1 id="briefDistrictName">Select a District</h1>
                <div class="subtitle">K-12 Funding Gap Analysis | Fiscal Year <span id="briefYear">2024-25</span></div>
            </div>
            
            <div class="brief-section">
                <h2>Executive Summary</h2>
                <p id="briefSummary">Select a district to generate a funding analysis brief.</p>
            </div>
            
            <div class="brief-section">
                <h2>Key Metrics</h2>
                <div class="brief-metrics" id="briefMetrics">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="brief-section">
                <h2>Top 3 Funding Challenges</h2>
                <ol class="brief-challenges" id="briefChallenges">
                    <!-- Populated by JS -->
                </ol>
            </div>
            
            <div class="brief-section">
                <h2>Recommended Policy Actions</h2>
                <ul class="brief-actions" id="briefActions">
                    <!-- Populated by JS -->
                </ul>
            </div>
            
            <div class="brief-section">
                <h2>Contact</h2>
                <p style="color: #666;">
                    Superintendent: _______________________________<br>
                    Email: _______________________________<br>
                    Phone: _______________________________
                </p>
            </div>
            
            <div class="brief-footer">
                Generated by WA K-12 Funding Analysis Tool<br>
                Data Source: OSPI Prototypical School Funding Model<br>
                <span id="briefDate"></span>
            </div>
        </div>
    </div>
    
    <!-- TAB 6: ABOUT -->
    <div id="tab-about" class="tab-content" role="tabpanel" aria-labelledby="btn-about">
        <!-- Selected District Summary -->
        <div id="aboutDistrictSummary" class="about-district-summary" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 0, 0, 0.2)); border-radius: 12px; border: 1px solid var(--card-border);">
            <h3 style="margin-bottom: 20px;">ðŸ“ Selected District Overview</h3>
            <div id="aboutDistrictContent">
                <p style="color: var(--text-secondary);">Select a district from the dropdown above to see its funding details.</p>
            </div>
        </div>

        <div class="about-grid">
            <div class="about-card">
                <h3>ðŸ“š Research Overview</h3>
                <p>
                    This dashboard was developed as part of a research project analyzing 
                    structural inequities in Washington State's K-12 education funding model.
                </p>
                <ul>
                    <li><strong>Research Question:</strong> How do the six structural flaws in Washington's prototypical funding model create systematic disadvantages for high-poverty and rural school districts?</li>
                    <li><strong>Researcher:</strong> William Park</li>
                    <li><strong>School:</strong> Interlake High School, Bellevue School District</li>
                    <li><strong>Submission:</strong> Regeneron Science Talent Search 2027</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3>ðŸ”¬ Methodology</h3>
                <p><strong>Data Collection:</strong></p>
                <ul>
                    <li>Primary source: OSPI Prototypical School Funding Model (2019-2025)</li>
                    <li>Enrollment data: OSPI Report Card</li>
                    <li>Demographic data: OSPI Student Demographics</li>
                    <li>Cost of living indices: Bureau of Labor Statistics</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Analysis Framework:</strong></p>
                <ul>
                    <li>Funding gap = Adequate funding (McCleary-based) - Actual state allocation</li>
                    <li>Per-pupil calculations normalized by enrollment</li>
                    <li>Correlation analysis: Demographics vs Funding Gap</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3>ðŸ“Š LEA Threshold Values</h3>
                <p>Local Effort Assistance thresholds by year:</p>
                <table class="lea-table">
                    <tr><th>Year</th><th>Threshold</th><th>Policy Basis</th></tr>
                    <tr><td>2025</td><td>$2,021</td><td>Seattle CPI adjustment</td></tr>
                    <tr><td>2026</td><td>$2,227.84</td><td>HB 2049: IPD + $200</td></tr>
                    <tr><td>2027</td><td>$2,547.35</td><td>Projected</td></tr>
                    <tr><td>2028</td><td>$2,599.57</td><td>Projected</td></tr>
                    <tr><td>2029</td><td>$2,654.16</td><td>Projected</td></tr>
                    <tr><td>2030</td><td>$2,704.32</td><td>Projected</td></tr>
                </table>
            </div>
            
            <div class="about-card">
                <h3>ðŸ“– Data Sources & Citations</h3>
                <ul>
                    <li><strong>Office of Superintendent of Public Instruction (OSPI)</strong> - Prototypical School Funding Model</li>
                    <li><strong>Washington State Legislature</strong> - HB 2049 (LEA threshold adjustments)</li>
                    <li><strong>McCleary v. State of Washington</strong> - Adequacy baseline</li>
                    <li><strong>Bureau of Labor Statistics</strong> - Seattle-Tacoma-Bellevue CPI</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3>âš ï¸ Limitations</h3>
                <ul>
                    <li>Data represents state funding only; federal and local sources vary</li>
                    <li>"Adequate" funding based on McCleary estimates, not universal standard</li>
                    <li>Projections assume current policy framework continues</li>
                    <li>Individual district circumstances may vary significantly</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3>ðŸ’» Open Source</h3>
                <p>
                    This tool is open source and available for replication and improvement.
                </p>
                <ul>
                    <li><strong>License:</strong> MIT</li>
                    <li>Contributions and feedback welcome</li>
                    <li>Built with HTML5, CSS3, and vanilla JavaScript</li>
                </ul>
            </div>
        </div>
    </div>
    
    </main>

    <!-- TOOLTIP -->
    <div class="tooltip" id="tooltip" role="tooltip" aria-hidden="true">
        <div class="tooltip-title"></div>
        <div class="tooltip-content"></div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
        <div class="spinner" aria-label="Loading"></div>
        <p>Loading data...</p>
    </div>

<script>
// ============== DISTRICT DATA ==============
// Embedded district data (subset for demonstration - full data would include all 295+ districts)
// Data will be loaded from JSON files
let DISTRICTS = [];
let STATE_AVERAGES = {};
let LEA_THRESHOLDS = {};
let REFORM_POLICIES = {};

// Load all data from JSON files
async function loadData() {
    try {
        const [districtsRes, stateAvgRes, leaRes, reformRes] = await Promise.all([
            fetch('data/districts.json'),
            fetch('data/state_averages.json'),
            fetch('data/lea_thresholds.json'),
            fetch('data/reform_policies.json')
        ]);

        DISTRICTS = await districtsRes.json();
        STATE_AVERAGES = await stateAvgRes.json();
        LEA_THRESHOLDS = await leaRes.json();
        REFORM_POLICIES = await reformRes.json();

        console.log('Data loaded successfully:', {
            districts: DISTRICTS.length,
            stateAverages: Object.keys(STATE_AVERAGES).length,
            leaThresholds: Object.keys(LEA_THRESHOLDS).length,
            reformPolicies: Object.keys(REFORM_POLICIES).length
        });

        return true;
    } catch (error) {
        console.error('Error loading data:', error);
        // Fallback to show error message
        document.body.innerHTML = `
            <div style="padding: 50px; text-align: center; color: #ff6b6b;">
                <h2>Error Loading Data</h2>
                <p>Could not load data files. Please ensure JSON files exist in the data/ folder.</p>
                <p style="color: #888;">${error.message}</p>
            </div>
        `;
        return false;
    }
}

// Current state
let currentDistrict = null;
let currentYear = '2024-25';
let allDistrictsForYear = [];

// ============== INITIALIZATION ==============
document.addEventListener('DOMContentLoaded', async function() {
    // Load data from JSON files first
    const dataLoaded = await loadData();
    if (!dataLoaded) return;

    populateCountySelect();
    populateDistrictSelect();
    updateYear();

    // Initialize Quick Guide with state averages first
    updateFamiliesTab();

    // Set default district to Bellevue on page load
    setTimeout(() => {
        selectFeatured('Bellevue School District');
    }, 100);
});

function populateCountySelect() {
    const counties = [...new Set(DISTRICTS.map(d => d.c))].sort();
    const select = document.getElementById('countySelect');
    counties.forEach(county => {
        const option = document.createElement('option');
        option.value = county;
        option.textContent = county;
        select.appendChild(option);
    });
}

function populateDistrictSelect(county = '') {
    const select = document.getElementById('districtSelect');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select a District...</option>';
    
    const year = document.getElementById('yearSelect').value;
    let districts = DISTRICTS.filter(d => d.y === year);
    
    if (county) {
        districts = districts.filter(d => d.c === county);
    }
    
    // Get unique districts by name
    const uniqueDistricts = [];
    const seen = new Set();
    districts.forEach(d => {
        if (!seen.has(d.n)) {
            seen.add(d.n);
            uniqueDistricts.push(d);
        }
    });
    
    uniqueDistricts.sort((a, b) => a.n.localeCompare(b.n));
    
    uniqueDistricts.forEach(d => {
        const option = document.createElement('option');
        option.value = d.n;
        option.textContent = d.n;
        select.appendChild(option);
    });
    
    // Also populate compare district select
    const compareSelect = document.getElementById('compareDistrictSelect');
    if (compareSelect) {
        compareSelect.innerHTML = '<option value="">Select...</option>';
        uniqueDistricts.forEach(d => {
            const option = document.createElement('option');
            option.value = d.n;
            option.textContent = d.n;
            compareSelect.appendChild(option);
        });
    }
    
    // Restore selection if still valid
    if (currentValue && uniqueDistricts.some(d => d.n === currentValue)) {
        select.value = currentValue;
    }
}

function filterByCounty() {
    const county = document.getElementById('countySelect').value;
    populateDistrictSelect(county);
}

function updateYear() {
    currentYear = document.getElementById('yearSelect').value;
    allDistrictsForYear = DISTRICTS.filter(d => d.y === currentYear);
    populateDistrictSelect(document.getElementById('countySelect').value);
    if (currentDistrict) {
        selectDistrict();
    }
}

function selectDistrict() {
    const districtName = document.getElementById('districtSelect').value;
    if (!districtName) {
        currentDistrict = null;
        document.getElementById('noDistrictMessage').style.display = 'block';
        document.getElementById('districtContent').style.display = 'none';
        return;
    }
    
    currentDistrict = DISTRICTS.find(d => d.n === districtName && d.y === currentYear);
    if (!currentDistrict) {
        // Try to find any year
        currentDistrict = DISTRICTS.find(d => d.n === districtName);
    }
    
    if (currentDistrict) {
        document.getElementById('noDistrictMessage').style.display = 'none';
        document.getElementById('districtContent').style.display = 'block';
        updateAllDisplays();
    }
}

function selectFeatured(districtName) {
    document.getElementById('countySelect').value = '';
    populateDistrictSelect();
    document.getElementById('districtSelect').value = districtName;
    selectDistrict();
}

// ============== LOCAL LEVY HELPER FUNCTIONS ==============
const VOTER_APPROVED_DATA = {
    'Bellevue School District': { taxRate: 0.75, approved: 79000000 },
    'Yakima School District': { taxRate: 2.50, approved: 21500000 },
    'Seattle Public Schools': { taxRate: 0.75, approved: 225000000 },
    'Spokane Public Schools': { taxRate: 2.50, approved: 95000000 },
    'Lake Washington School District': { taxRate: 1.03, approved: 94400000 },
    'Issaquah School District': { taxRate: 1.42, approved: 67000000 },
    'Tacoma School District': { taxRate: 2.50, approved: 58000000 },
    'Highline School District': { taxRate: 2.46, approved: 67988856 },
    'Kent School District': { taxRate: 1.72, approved: 79300000 },
    'Federal Way School District': { taxRate: 1.86, approved: 45000000 },
    'Auburn School District': { taxRate: 2.50, approved: 51841820 },
    'Renton School District': { taxRate: 1.23, approved: 43272122 },
    'Northshore School District': { taxRate: 1.40, approved: 67500000 },
    'Mercer Island School District': { taxRate: 1.00, approved: 12000000 },
};

function getLocalLevyValue(d, levy250) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const actualTaxRate = voterData ? voterData.taxRate : (d.lea === 'revenue' ? 0.75 : 2.50);
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const levyCap = 2500;
    const overCap = perStudentApproved ? perStudentApproved > levyCap : false;

    if (voterData) {
        return `$${actualTaxRate.toFixed(2)}/1000 (${overCap ? 'Levy Cap Hit' : 'Under Cap'})`;
    } else {
        return `$${actualTaxRate.toFixed(2)}/1000 (Est.)`;
    }
}

function getLocalLevyMeaning(d, levy250) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const actualTaxRate = voterData ? voterData.taxRate : (d.lea === 'revenue' ? 0.75 : 2.50);
    const voterApproved = voterData ? voterData.approved : null;
    const perStudentApproved = voterApproved ? Math.round(voterApproved / d.t) : null;
    const levyCap = 2500;
    const overCap = perStudentApproved ? perStudentApproved > levyCap : false;
    const lossPerStudent = overCap ? perStudentApproved - levyCap : 0;
    const totalLoss = lossPerStudent * d.t;

    if (overCap) {
        return `<strong>Voter-approved: $${perStudentApproved.toLocaleString()}/student</strong> but <strong>Levy Cap = $${levyCap.toLocaleString()}</strong>. Using only <strong>$${actualTaxRate.toFixed(2)}/1000</strong> rate. <strong>Cannot collect $${totalLoss.toLocaleString()}</strong> (${Math.round(totalLoss/voterApproved*100)}% of approved)`;
    } else if (d.lea === 'rate') {
        return `<strong>Already at max rate ($2.50/1000)</strong> but only generates <strong>$${Math.round(levy250).toLocaleString()}/student</strong>. Below $2,500 target â†’ state provides <strong>$${Math.round(Math.max(0, 2500 - levy250)).toLocaleString()} LEA</strong>.`;
    } else {
        return `Voter-approved levy within cap limits. Generates <strong>$${Math.round(levy250).toLocaleString()}/student</strong>.`;
    }
}

function getLocalLevyStatus(d) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const overCap = perStudentApproved ? perStudentApproved > 2500 : false;
    
    if (overCap) return 'Over Cap';
    if (d.lea === 'rate') return 'Needs LEA';
    return 'Under Cap';
}

function getLocalLevyStatusType(d) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const overCap = perStudentApproved ? perStudentApproved > 2500 : false;
    
    if (overCap) return 'critical';
    if (d.lea === 'rate') return 'warning';
    return 'good';
}

// ============== TAB NAVIGATION ==============
function showTab(tabId, btnElement) {
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (btnElement) {
        btnElement.classList.add('active');
    }
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    
    // Special updates for certain tabs
    if (tabId === 'mydistrict') {
        // Re-render chart after tab becomes visible (needs slight delay for DOM)
        setTimeout(() => {
            updateComparisonChart();
        }, 50);
    } else if (tabId === 'problems') {
        updateProblemsTab();
    } else if (tabId === 'compare') {
        updateComparison();
    } else if (tabId === 'solutions') {
        selectYear(2025);
    } else if (tabId === 'brief') {
        updateBrief();
    }
}

// ============== CALCULATIONS ==============
function calculateFundingGap(district) {
    if (!district) return { total: 0, components: {} };
    
    const baseFunding = 12500; // Base per-pupil funding
    
    // Poverty gap (no poverty weight in WA)
    const povertyGap = district.li > 0.4 ? (district.li - 0.4) * baseFunding * 0.35 : district.li * baseFunding * 0.15;
    
    // SpEd gap (15.5% cap)
    const spedGap = district.sp > 0.155 ? (district.sp - 0.155) * baseFunding * 2.5 : 0;
    
    // ELL gap
    const ellGap = district.el > 0.05 ? (district.el - 0.05) * baseFunding * 0.3 : 0;
    
    // Regionalization gap
    const regionGap = (1.04 - district.cis) * baseFunding * 0.45;
    
    // LEA gap
    const ppAV = district.av / district.t;
    const levy250 = ppAV * 0.0025;
    const leaGap = district.lea === 'rate' ? Math.max(0, 2784 - levy250) : 0;
    
    // MSOC (flat estimate)
    const msocGap = 450; // ~$450 per student due to inflation freeze
    
    const total = povertyGap + spedGap + ellGap + Math.max(0, regionGap) + leaGap + msocGap;
    
    return {
        total: Math.round(total),
        components: {
            poverty: Math.round(povertyGap),
            sped: Math.round(spedGap),
            ell: Math.round(ellGap),
            region: Math.round(Math.max(0, regionGap)),
            lea: Math.round(leaGap),
            msoc: Math.round(msocGap)
        }
    };
}

// ============== UPDATE DISPLAYS ==============
function updateAllDisplays() {
    if (!currentDistrict) return;

    updateMetricsGrid();
    updateInterpretationTable();
    updateGapBreakdown();
    updateComparisonChart();
    updateRankings();
    updateFamiliesTab();
    updateAboutTab();
}

function updateAboutTab() {
    const contentDiv = document.getElementById('aboutDistrictContent');
    if (!contentDiv) return;

    if (!currentDistrict) {
        contentDiv.innerHTML = `<p style="color: var(--text-secondary);">Select a district from the dropdown above to see its funding details.</p>`;
        return;
    }

    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    const totalGap = gap.total * d.t;

    contentDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">District Name</div>
                <div style="font-size: 1.2rem; font-weight: 600;">${d.n}</div>
            </div>
            <div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">County</div>
                <div style="font-size: 1.2rem; font-weight: 600;">${d.c}</div>
            </div>
            <div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">School Year</div>
                <div style="font-size: 1.2rem; font-weight: 600;">${d.y}</div>
            </div>
            <div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Enrollment</div>
                <div style="font-size: 1.2rem; font-weight: 600;">${d.t.toLocaleString()} students</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-border);">
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Low-Income</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${(d.li * 100).toFixed(1)}%</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">SpEd</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${(d.sp * 100).toFixed(1)}%</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">ELL</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${(d.el * 100).toFixed(1)}%</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">CIS Factor</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${d.cis.toFixed(2)}</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">LEA Type</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${d.lea === 'revenue' ? 'Revenue-Capped' : 'Rate-Capped'}</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Assessed Value</div>
                <div style="font-size: 1.1rem; font-weight: 600;">$${(d.av / 1000000000).toFixed(1)}B</div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-border);">
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Per-Pupil Funding Gap</div>
                <div style="font-size: 1.3rem; font-weight: 700;">-$${gap.total.toLocaleString()}</div>
            </div>
            <div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Annual Shortfall</div>
                <div style="font-size: 1.3rem; font-weight: 700;">-$${(totalGap / 1000000).toFixed(1)}M</div>
            </div>
        </div>
    `;
}

function updateMetricsGrid() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    // Calculate some derived values
    const enrollmentTrend = d.t > STATE_AVERAGES.enrollment ? 'Large' : d.t > 1000 ? 'Medium' : 'Small';
    const regionGap = (1.04 - d.cis) * 100;
    const msocShortfall = gap.components.msoc;
    const totalGap = gap.total * d.t;
    
    const metrics = [
        {
            label: 'ðŸš¨ Total Funding Gap',
            value: '-$' + (totalGap >= 1000000 ? (totalGap / 1000000).toFixed(1) + 'M' : totalGap.toLocaleString()),
            subtitle: `${d.t.toLocaleString()} students Ã— $${gap.total.toLocaleString()}`,
            status: 'red',
            statusClass: 'status-red highlight-card',
            tooltip: {
                title: 'Total Annual Funding Gap',
                text: `This district faces a <strong style="color: var(--accent-red);">$${totalGap.toLocaleString()}</strong> annual funding shortfall.<br><br>Calculated as:<br>â€¢ Enrollment: ${d.t.toLocaleString()} students<br>â€¢ Per-pupil gap: $${gap.total.toLocaleString()}<br><br>This gap directly impacts classroom resources, teacher retention, and student outcomes.`,
                warning: 'This amount represents funding the district SHOULD receive but DOES NOT under current state formulas.'
            }
        },
        {
            label: 'ðŸ‘¥ Enrollment',
            value: d.t.toLocaleString(),
            subtitle: `${d.c} County`,
            status: 'blue',
            statusClass: '',
            tooltip: {
                title: 'Total Student Enrollment',
                text: `<strong>${d.t.toLocaleString()}</strong> students enrolled in ${currentYear}.<br><br>District size affects economies of scale, administrative costs, and bargaining power for contracts.`,
                highlight: `State average: ${STATE_AVERAGES.enrollment.toLocaleString()} students`
            }
        },
        {
            label: 'ðŸ’° Per-Pupil Gap',
            value: '-$' + gap.total.toLocaleString(),
            subtitle: `State avg: -$${STATE_AVERAGES.perPupilGap.toLocaleString()}`,
            status: gap.total > STATE_AVERAGES.perPupilGap ? 'red' : 'yellow',
            statusClass: gap.total > STATE_AVERAGES.perPupilGap ? 'status-red' : 'status-yellow',
            tooltip: {
                title: 'Per-Pupil Funding Gap',
                text: `The difference between <strong>adequate funding</strong> (McCleary baseline) and <strong>actual state allocation</strong>.<br><br>Total annual shortfall: <strong style="color: var(--accent-red);">$${totalGap.toLocaleString()}</strong>`,
                warning: gap.total > STATE_AVERAGES.perPupilGap ? 'Above state average gap - this district is more underfunded than typical.' : null
            }
        },
        {
            label: 'ðŸ“Š Low-Income %',
            value: (d.li * 100).toFixed(1) + '%',
            subtitle: `State avg: ${(STATE_AVERAGES.lowIncome * 100).toFixed(1)}%`,
            status: d.li > STATE_AVERAGES.lowIncome ? 'red' : 'green',
            statusClass: d.li > STATE_AVERAGES.lowIncome ? 'status-red' : 'status-green',
            tooltip: {
                title: 'Free/Reduced Lunch Eligible',
                text: `<strong>${(d.li * 100).toFixed(1)}%</strong> of students qualify for free or reduced-price lunch.<br><br>Washington is <strong>1 of only 3 states</strong> that provides NO additional funding for low-income students (no "poverty weight").`,
                warning: d.li > 0.5 ? 'High-poverty district receiving no additional state support for student needs.' : null
            }
        },
        {
            label: 'â™¿ SpEd %',
            value: (d.sp * 100).toFixed(1) + '%',
            subtitle: d.sp > 0.155 ? `${((d.sp - 0.155) * 100).toFixed(1)}% over cap!` : 'Under 15.5% cap',
            status: d.sp > 0.155 ? 'red' : 'green',
            statusClass: d.sp > 0.155 ? 'status-red' : 'status-green',
            tooltip: {
                title: 'Special Education Population',
                text: `<strong>${(d.sp * 100).toFixed(1)}%</strong> of students receive special education services.<br><br>State funding is <strong>capped at 15.5%</strong>. Students above this cap cost ~$25,000/year but receive <strong>$0 state funding</strong>.`,
                warning: d.sp > 0.155 ? `${Math.round((d.sp - 0.155) * d.t)} students above cap = $${Math.round((d.sp - 0.155) * d.t * 25000).toLocaleString()} unfunded annually.` : null
            }
        },
        {
            label: 'ðŸŒ ELL %',
            value: (d.el * 100).toFixed(1) + '%',
            subtitle: `State avg: ${(STATE_AVERAGES.ell * 100).toFixed(1)}%`,
            status: d.el > STATE_AVERAGES.ell * 1.5 ? 'yellow' : 'blue',
            statusClass: d.el > STATE_AVERAGES.ell * 1.5 ? 'status-yellow' : '',
            tooltip: {
                title: 'English Language Learners',
                text: `<strong>${(d.el * 100).toFixed(1)}%</strong> of students are English Language Learners.<br><br>TBIP (Transitional Bilingual Instruction Program) funding may not cover actual costs for districts with high ELL populations.`,
                highlight: d.el > 0.2 ? 'High ELL population requires additional instructional support.' : null
            }
        },
        {
            label: 'ðŸ¦ LEA Status',
            value: d.lea === 'rate' ? 'Rate-Capped' : 'Revenue-Capped',
            subtitle: d.lea === 'rate' ? 'Needs LEA support' : 'Self-sufficient',
            status: d.lea === 'rate' ? 'yellow' : 'green',
            statusClass: d.lea === 'rate' ? 'status-yellow' : 'status-green',
            tooltip: {
                title: 'Local Effort Assistance Status',
                text: d.lea === 'rate' 
                    ? `<strong>Rate-Capped (Low Wealth):</strong> Even at maximum levy rate (2.50/$1000), this district cannot generate sufficient local revenue.<br><br>Receives LEA state assistance to partially close the gap.`
                    : `<strong>Revenue-Capped (High Wealth):</strong> Property values are high enough to generate local revenue at lower levy rates.<br><br>Constrained by the $2,500/student levy cap, not property values.`,
                highlight: `2025 LEA threshold: $2,021 â†’ 2026: $2,227.84 (HB 2049)`
            }
        },
        {
            label: 'ðŸ—ºï¸ Regionalization',
            value: d.cis.toFixed(2),
            subtitle: d.cis >= 1.04 ? 'At maximum' : `${regionGap.toFixed(1)}% below max`,
            status: d.cis >= 1.04 ? 'green' : d.cis >= 1.02 ? 'yellow' : 'red',
            statusClass: d.cis >= 1.04 ? 'status-green' : d.cis >= 1.02 ? 'status-yellow' : 'status-red',
            tooltip: {
                title: 'CIS (Comparable Insurance Salary) Factor',
                text: `Regional cost adjustment factor: <strong>${d.cis.toFixed(2)}</strong><br><br>Ranges from 1.00 to 1.04. Higher factors provide more funding per staff position to account for regional cost-of-living differences.<br><br>Maximum factor (1.04) applies to Seattle/King County area.`,
                warning: d.cis < 1.02 ? `This district receives ${regionGap.toFixed(1)}% less per staff position than high-cost regions - may struggle to compete for teachers.` : null
            }
        },
        {
            label: 'ðŸ“¦ MSOC',
            value: '$1,533',
            subtitle: 'Per Student Funding',
            status: 'blue',
            statusClass: '',
            tooltip: {
                title: 'Materials, Supplies & Operating Costs',
                text: `MSOC allocations have been <strong>frozen at $1,533/student since 2018</strong> (post-McCleary).<br><br>Meanwhile, actual costs have risen dramatically:<br>â€¢ Insurance: +100%<br>â€¢ Utilities: +50%<br>â€¢ Supplies: +35%<br><br>This creates a silent erosion of classroom spending.`,
                warning: `If adjusted for inflation, MSOC should be ~$1,980/student - a $${(447 * d.t).toLocaleString()} annual shortfall for this district.`
            }
        }
    ];
    
    const grid = document.getElementById('metricsGrid');
    grid.innerHTML = metrics.map(m => `
        <div class="metric-card ${m.statusClass}">
            <div class="metric-label">${m.label}<i class="info-icon">?</i></div>
            <div class="metric-value ${m.status}">${m.value}</div>
            <div class="metric-subtitle">${m.subtitle}</div>
            <div class="card-tooltip">
                <div class="tt-title">${m.tooltip.title}</div>
                <div class="tt-text">
                    ${m.tooltip.text}
                    ${m.tooltip.highlight ? `<span class="tt-highlight"><br><br>${m.tooltip.highlight}</span>` : ''}
                    ${m.tooltip.warning ? `<span class="tt-warning">âš ï¸ ${m.tooltip.warning}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function updateInterpretationTable() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    // Calculate derived values
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    const ellGapPerStudent = d.el > 0.05 ? 1300 : 0;
    
    // Find prior year enrollment for comparison
    const priorYearMap = {
        '2024-25': '2023-24',
        '2023-24': '2022-23',
        '2022-23': '2021-22',
        '2021-22': '2020-21',
        '2020-21': '2019-20'
    };
    const priorYear = priorYearMap[currentYear];
    const priorYearData = DISTRICTS.find(dist => dist.n === d.n && dist.y === priorYear);
    
    let enrollmentChange = 0;
    let enrollmentChangePercent = 0;
    let enrollmentChangeText = '';
    
    if (priorYearData) {
        enrollmentChange = d.t - priorYearData.t;
        enrollmentChangePercent = ((enrollmentChange / priorYearData.t) * 100).toFixed(1);
        const sign = enrollmentChange >= 0 ? '+' : '';
        enrollmentChangeText = `(${sign}${enrollmentChange.toLocaleString()}, ${sign}${enrollmentChangePercent}%)`;
    }
    
    // Calculate percentile rankings
    const sortedByPoverty = [...allDistrictsForYear].sort((a, b) => b.li - a.li);
    const povertyRank = sortedByPoverty.findIndex(x => x.n === d.n) + 1;
    const povertyPercentile = Math.round((1 - povertyRank / sortedByPoverty.length) * 100);
    
    const sortedByELL = [...allDistrictsForYear].sort((a, b) => b.el - a.el);
    const ellRank = sortedByELL.findIndex(x => x.n === d.n) + 1;
    const ellPercentile = Math.round((ellRank / sortedByELL.length) * 100);
    
    // Determine enrollment status
    let enrollmentStatus = 'Stable';
    let enrollmentStatusType = 'info';
    if (enrollmentChange > 0) {
        enrollmentStatus = 'Growing';
        enrollmentStatusType = 'good';
    } else if (enrollmentChange < -100 || enrollmentChangePercent < -2) {
        enrollmentStatus = 'Declining';
        enrollmentStatusType = 'critical';
    } else if (enrollmentChange < 0) {
        enrollmentStatus = 'Slight Decline';
        enrollmentStatusType = 'warning';
    }
    
    const rows = [
        {
            metric: 'Enrollment',
            value: `${d.t.toLocaleString()} ${enrollmentChangeText}`,
            meaning: enrollmentChange >= 0
                ? `Total students. Increased ${Math.abs(enrollmentChange).toLocaleString()} from prior year`
                : `Total students. Decreased ${Math.abs(enrollmentChange).toLocaleString()} from prior year. <strong>Funding drops immediately with enrollment</strong>`,
            status: enrollmentStatus,
            statusType: enrollmentStatusType
        },
        {
            metric: 'Low-Income',
            value: `${(d.li * 100).toFixed(1)}% (Top ${povertyPercentile}%)`,
            meaning: `Low-income student rate. Top ${povertyPercentile}% in state. <strong>No Poverty Weight â†’ $0 extra funding</strong>`,
            status: d.li > 0.5 ? 'High' : d.li > 0.3 ? 'Moderate' : 'Low',
            statusType: d.li > 0.5 ? 'critical' : d.li > 0.3 ? 'warning' : 'good'
        },
        {
            metric: 'SpEd %',
            value: d.sp > 0.155
                ? `${(d.sp * 100).toFixed(1)}% (+${((d.sp - 0.155) * 100).toFixed(1)}% Over Cap)`
                : `${(d.sp * 100).toFixed(1)}% (Under Cap)`,
            meaning: d.sp > 0.155
                ? `Your rate: <strong>${(d.sp * 100).toFixed(1)}%</strong> vs State cap: <strong>15.5%</strong>. <strong>${((d.sp - 0.155) * 100).toFixed(1)}% above cap</strong> = ${Math.round((d.sp - 0.155) * d.t)} students UNFUNDED (~$25K each)`
                : `Your rate: <strong>${(d.sp * 100).toFixed(1)}%</strong> vs State cap: <strong>15.5%</strong>. All SpEd students fully funded.`,
            status: d.sp > 0.155 ? 'Over Cap' : 'Under Cap',
            statusType: d.sp > 0.155 ? 'critical' : 'good'
        },
        {
            metric: 'ELL %',
            value: `${(d.el * 100).toFixed(1)}% (Top ${ellPercentile}%)`,
            meaning: d.el > 0.1
                ? `English Language Learners. Top ${ellPercentile}% in state. <strong>TBIP ~$1,200 vs actual cost ~$2,500 â†’ $1,300/ELL gap</strong>`
                : `English Language Learners. TBIP funding adequate for current population.`,
            status: d.el > 0.15 ? 'High' : d.el > 0.08 ? 'Moderate' : 'Low',
            statusType: d.el > 0.15 ? 'warning' : d.el > 0.08 ? 'info' : 'good'
        },
        {
            metric: 'Regionalization',
            value: `${d.cis.toFixed(3)} (${d.cis >= 1.04 ? 'Highest' : d.cis >= 1.02 ? 'Mid-High' : 'Low'})`,
            meaning: d.cis >= 1.04
                ? `Teacher salary adjustment factor. <strong>Maximum factor</strong>`
                : `Teacher salary adjustment factor. <strong>${((1.04 - d.cis) * 100).toFixed(1)}% below maximum</strong> - competitive disadvantage.`,
            status: d.cis >= 1.04 ? 'Adequate' : d.cis >= 1.02 ? 'Mid-Range' : 'Disadvantaged',
            statusType: d.cis >= 1.04 ? 'good' : d.cis >= 1.02 ? 'warning' : 'critical'
        },
        {
            metric: 'Local Levy',
            value: getLocalLevyValue(d, levy250),
            meaning: getLocalLevyMeaning(d, levy250),
            status: getLocalLevyStatus(d),
            statusType: getLocalLevyStatusType(d)
        }
    ];
    
    const tbody = document.getElementById('interpretationBody');
    tbody.innerHTML = rows.map(r => `
        <tr>
            <td style="font-weight: 600; color: var(--text-primary); white-space: nowrap;">${r.metric}</td>
            <td style="white-space: nowrap;">${r.value}</td>
            <td style="color: #ccc; line-height: 1.6;">${r.meaning}</td>
            <td style="text-align: right;"><span class="status-badge ${r.statusType}">${r.status}</span></td>
        </tr>
    `).join('');
}

function updateGapBreakdown() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    const baseFunding = 12500;
    
    // Update total gap display
    document.getElementById('totalGapValue').textContent = '-$' + gap.total.toLocaleString();
    document.getElementById('totalShortfall').textContent = '$' + (gap.total * d.t).toLocaleString();
    
    // Calculate values for each category (Gap = Need - Current)
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    
    // Get poverty weight slider value for Need calculation
    const povertyWeightPercent = parseInt(document.getElementById('povertyWeightSlider').value) || 0;
    
    // Poverty: Current = $0, Need = based on slider %
    const povertyCurrent = 0;
    const povertyNeed = Math.round(baseFunding * (povertyWeightPercent / 100) * d.li);
    const povertyGap = povertyNeed - povertyCurrent;
    document.getElementById('poverty-current').textContent = '$' + povertyCurrent.toLocaleString();
    document.getElementById('poverty-need').textContent = '$' + povertyNeed.toLocaleString();
    document.getElementById('poverty-gap').textContent = povertyGap > 0 ? '-$' + povertyGap.toLocaleString() : '$0';
    document.getElementById('poverty-gap').className = 'gap-value ' + (povertyGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // SpEd: Current = funded up to 15.5%, Need = full actual rate
    const spedCurrent = Math.round(baseFunding * Math.min(d.sp, 0.155) * 2.5);
    const spedNeed = Math.round(baseFunding * d.sp * 2.5);
    const spedGap = spedNeed - spedCurrent;
    document.getElementById('sped-current').textContent = '$' + spedCurrent.toLocaleString();
    document.getElementById('sped-need').textContent = '$' + spedNeed.toLocaleString();
    document.getElementById('sped-gap').textContent = spedGap > 0 ? '-$' + spedGap.toLocaleString() : '$0';
    document.getElementById('sped-gap').className = 'gap-value ' + (spedGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // ELL: Current = TBIP $1,200, Need = actual $2,500
    const ellCurrent = Math.round(1200 * d.el);
    const ellNeed = Math.round(2500 * d.el);
    const ellGap = ellNeed - ellCurrent;
    document.getElementById('ell-current').textContent = '$' + ellCurrent.toLocaleString();
    document.getElementById('ell-need').textContent = '$' + ellNeed.toLocaleString();
    document.getElementById('ell-gap').textContent = ellGap > 0 ? '-$' + ellGap.toLocaleString() : '$0';
    document.getElementById('ell-gap').className = 'gap-value ' + (ellGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // Regionalization: Current = district CIS, Need = max 1.04
    const regionCurrent = Math.round(baseFunding * (d.cis - 1));
    const regionNeed = Math.round(baseFunding * 0.04);
    const regionGap = regionNeed - regionCurrent;
    document.getElementById('region-current').textContent = '$' + regionCurrent.toLocaleString();
    document.getElementById('region-need').textContent = '$' + regionNeed.toLocaleString();
    document.getElementById('region-gap').textContent = regionGap > 0 ? '-$' + regionGap.toLocaleString() : '$0';
    document.getElementById('region-gap').className = 'gap-value ' + (regionGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // Local Levy: Current = what district can collect, Need = $2,500 target
    const leaCurrent = d.lea === 'rate' ? Math.round(Math.min(levy250, 2500)) : 2500;
    const leaNeed = 2500;
    const leaGap = leaNeed - leaCurrent;
    document.getElementById('lea-current').textContent = '$' + leaCurrent.toLocaleString();
    document.getElementById('lea-need').textContent = '$' + leaNeed.toLocaleString();
    document.getElementById('lea-gap').textContent = leaGap > 0 ? '-$' + leaGap.toLocaleString() : '$0';
    document.getElementById('lea-gap').className = 'gap-value ' + (leaGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // MSOC: Current = frozen $1,533, Need = inflation-adjusted $1,980
    const msocCurrent = 1533;
    const msocNeed = 1980;
    const msocGap = msocNeed - msocCurrent;
    document.getElementById('msoc-current').textContent = '$' + msocCurrent.toLocaleString();
    document.getElementById('msoc-need').textContent = '$' + msocNeed.toLocaleString();
    document.getElementById('msoc-gap').textContent = '-$' + msocGap.toLocaleString();
    document.getElementById('msoc-gap').className = 'gap-value gap-negative';
    
    // Set slider impacts (descriptions)
    document.getElementById('poverty-impact').textContent = `${(d.li*100).toFixed(1)}% FRL rate. WA provides $0 extra for low-income students.`;
    document.getElementById('sped-impact').textContent = d.sp > 0.155 
        ? `${(d.sp*100).toFixed(1)}% SpEd rate â€” ${((d.sp-0.155)*100).toFixed(1)}% above 15.5% cap`
        : `${(d.sp*100).toFixed(1)}% SpEd rate â€” within 15.5% cap`;
    document.getElementById('ell-impact').textContent = `${(d.el*100).toFixed(1)}% ELL. TBIP: $1,200/student vs $2,500 actual cost`;
    document.getElementById('region-impact').textContent = `CIS factor: ${d.cis.toFixed(3)}. ${d.cis < 1.04 ? 'Below max 1.040' : 'At maximum 1.040'}`;
    document.getElementById('lea-impact').textContent = d.lea === 'rate' 
        ? `Rate-capped: $${Math.round(levy250).toLocaleString()}/student at $2.50/1000 rate`
        : `Levy cap limits collection. Voter-approved exceeds cap.`;
    document.getElementById('msoc-impact').textContent = 'Frozen at $1,533 since 2018. Inflation-adjusted: $1,980';
    
    // Set district-specific default slider values
    setDistrictSliderDefaults(d);

    // Initialize new gap display (with null checks)
    const newGapEl = document.getElementById('newGapValue');
    if (newGapEl) newGapEl.textContent = '-$' + gap.total.toLocaleString();
    const reformRedEl = document.getElementById('reformReduction');
    if (reformRedEl) reformRedEl.textContent = '0%';
}

function setDistrictSliderDefaults(d) {
    // Set slider defaults based on actual district needs
    
    // Poverty weight: 20% (national average)
    document.getElementById('povertyWeightSlider').value = 20;
    document.getElementById('povertyWeightValue').textContent = '20%';
    
    // SpEd cap: Set to district's actual SpEd rate
    const spedDefault = Math.round(d.sp * 1000); // 0.171 â†’ 171
    document.getElementById('spedCapSlider').value = Math.max(155, Math.min(250, spedDefault));
    document.getElementById('spedCapValue').textContent = (d.sp * 100).toFixed(1) + '%';
    
    // ELL funding: $2,500 (actual cost per ELL student)
    document.getElementById('ellFundingSlider').value = 2500;
    document.getElementById('ellFundingValue').textContent = '$2,500';
    
    // Regionalization: Set to district's actual CIS factor
    const regionDefault = Math.round(d.cis * 100);
    document.getElementById('regionMinSlider').value = regionDefault;
    document.getElementById('regionMinValue').textContent = d.cis.toFixed(2);
    
    // LEA threshold: Set to district's voter-approved per-student amount
    const voterData = VOTER_APPROVED_DATA[d.n];
    let leaDefault = 2500; // Default to levy cap
    if (voterData) {
        const perStudentApproved = Math.round(voterData.approved / d.t);
        leaDefault = Math.min(5000, Math.max(2021, perStudentApproved));
    }
    document.getElementById('leaThresholdSlider').value = leaDefault;
    document.getElementById('leaThresholdValue').textContent = '$' + leaDefault.toLocaleString();
    
    // MSOC: $1,980 (inflation-adjusted value)
    document.getElementById('msocSlider').value = 1980;
    document.getElementById('msocValue').textContent = '$1,980';
    
    // Apply reforms with defaults
    updateGapWithReforms();
}

function updateGapWithReforms() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const baseFunding = 12500;
    
    // Get slider values
    const povertyWeight = parseInt(document.getElementById('povertyWeightSlider').value) / 100;
    const spedCap = parseInt(document.getElementById('spedCapSlider').value) / 1000;
    const ellFunding = parseInt(document.getElementById('ellFundingSlider').value);
    const regionMin = parseInt(document.getElementById('regionMinSlider').value) / 100;
    const leaThreshold = parseInt(document.getElementById('leaThresholdSlider').value);
    const msocAmount = parseInt(document.getElementById('msocSlider').value);
    
    // Update slider display values
    document.getElementById('povertyWeightValue').textContent = Math.round(povertyWeight * 100) + '%';
    document.getElementById('spedCapValue').textContent = (spedCap * 100).toFixed(1) + '%';
    document.getElementById('ellFundingValue').textContent = '$' + ellFunding.toLocaleString();
    document.getElementById('regionMinValue').textContent = regionMin.toFixed(2);
    document.getElementById('leaThresholdValue').textContent = '$' + leaThreshold.toLocaleString();
    document.getElementById('msocValue').textContent = '$' + msocAmount.toLocaleString();
    
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    
    // ===== POVERTY =====
    // Current = $0 (WA provides nothing), Need = slider % based
    const povertyCurrent = 0;
    const povertyNeed = Math.round(baseFunding * povertyWeight * d.li);
    const povertyGap = povertyNeed - povertyCurrent;
    document.getElementById('poverty-current').textContent = '$' + povertyCurrent.toLocaleString();
    document.getElementById('poverty-need').textContent = '$' + povertyNeed.toLocaleString();
    document.getElementById('poverty-gap').textContent = povertyGap > 0 ? '-$' + povertyGap.toLocaleString() : '$0';
    document.getElementById('poverty-gap').className = 'gap-value ' + (povertyGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('poverty-impact').innerHTML = `<span style="color: var(--accent-green);">$${baseFunding.toLocaleString()} Ã— ${Math.round(povertyWeight*100)}% Ã— ${(d.li*100).toFixed(1)}% FRL = <strong>$${povertyNeed.toLocaleString()}</strong></span>`;
    
    // ===== SPED =====
    // Current = funded at 15.5% cap, Need = funded at slider cap
    // Gap = (slider% - 15.5%) Ã— baseFunding Ã— 2.5
    const spedCurrentRate = 0.155; // WA cap is always 15.5%
    const spedSliderRate = spedCap; // Slider value
    const spedCurrent = Math.round(baseFunding * spedCurrentRate * 2.5);
    const spedNeed = Math.round(baseFunding * spedSliderRate * 2.5);
    const spedGap = spedNeed - spedCurrent;
    document.getElementById('sped-current').textContent = '$' + spedCurrent.toLocaleString();
    document.getElementById('sped-need').textContent = '$' + spedNeed.toLocaleString();
    document.getElementById('sped-gap').textContent = spedGap > 0 ? '-$' + spedGap.toLocaleString() : '$0';
    document.getElementById('sped-gap').className = 'gap-value ' + (spedGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation: slider% - 15.5% cap
    const spedExtra = spedSliderRate - spedCurrentRate;
    document.getElementById('sped-impact').innerHTML = spedGap > 0
        ? `<span style="color: var(--accent-green);">$${baseFunding.toLocaleString()} Ã— ${(spedExtra*100).toFixed(1)}% Ã— 2.5 = <strong>$${spedGap.toLocaleString()}</strong> (${(spedSliderRate*100).toFixed(1)}% slider - 15.5% cap)</span>`
        : `<span style="color: var(--accent-green);">Slider ${(spedSliderRate*100).toFixed(1)}% = Cap 15.5% â†’ <strong>No gap</strong></span>`;
    
    // ===== ELL =====
    // Current = TBIP $1,200, Need = slider funding amount
    const ellCurrent = Math.round(1200 * d.el);
    const ellNeed = Math.round(ellFunding * d.el);
    const ellGap = ellNeed - ellCurrent;
    document.getElementById('ell-current').textContent = '$' + ellCurrent.toLocaleString();
    document.getElementById('ell-need').textContent = '$' + ellNeed.toLocaleString();
    document.getElementById('ell-gap').textContent = ellGap > 0 ? '-$' + ellGap.toLocaleString() : '$0';
    document.getElementById('ell-gap').className = 'gap-value ' + (ellGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('ell-impact').innerHTML = `<span style="color: var(--accent-green);">($${ellFunding.toLocaleString()} - $1,200) Ã— ${(d.el*100).toFixed(1)}% ELL = <strong>$${ellGap.toLocaleString()}</strong></span>`;
    
    // ===== REGIONALIZATION =====
    // Current = $12,500 Ã— (CIS - 1.00), Need = $12,500 Ã— (slider - 1.00)
    const regionCurrent = Math.round(baseFunding * (d.cis - 1));
    const effectiveCIS = Math.max(d.cis, regionMin);
    const regionNeed = Math.round(baseFunding * (regionMin - 1));
    const regionGap = regionNeed - regionCurrent;
    document.getElementById('region-current').textContent = '$' + regionCurrent.toLocaleString();
    document.getElementById('region-need').textContent = '$' + regionNeed.toLocaleString();
    document.getElementById('region-gap').textContent = regionGap > 0 ? '-$' + regionGap.toLocaleString() : '$0';
    document.getElementById('region-gap').className = 'gap-value ' + (regionGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('region-impact').innerHTML = `<span style="color: var(--accent-green);">Current: $${baseFunding.toLocaleString()} Ã— (${d.cis.toFixed(2)} - 1.00) = <strong>$${regionCurrent.toLocaleString()}</strong> | Need: $${baseFunding.toLocaleString()} Ã— (${regionMin.toFixed(2)} - 1.00) = <strong>$${regionNeed.toLocaleString()}</strong></span>`;
    
    // ===== LOCAL LEVY =====
    // Revenue-capped (Bellevue): Current = $2,500 (levy cap limits), Need = slider (voter-approved)
    // Rate-capped (Yakima): Current = what district can collect at max rate, Need = slider threshold
    const leaCurrent = d.lea === 'revenue' ? 2500 : Math.round(Math.min(levy250, 2500));
    const leaNeed = leaThreshold; // Need = slider value (voter-approved per student)
    const leaGap = leaNeed - leaCurrent;
    document.getElementById('lea-current').textContent = '$' + leaCurrent.toLocaleString();
    document.getElementById('lea-need').textContent = '$' + leaNeed.toLocaleString();
    document.getElementById('lea-gap').textContent = leaGap > 0 ? '-$' + leaGap.toLocaleString() : '$0';
    document.getElementById('lea-gap').className = 'gap-value ' + (leaGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    const voterData = VOTER_APPROVED_DATA[d.n];
    if (d.lea === 'revenue') {
        // Revenue-capped: Levy cap blocks collection
        document.getElementById('lea-impact').innerHTML = `<span style="color: var(--accent-green);">Voter-approved $${leaNeed.toLocaleString()}/student - Levy Cap $2,500 = <strong>-$${leaGap.toLocaleString()}</strong> cannot collect</span>`;
    } else {
        // Rate-capped: Low property value limits collection
        document.getElementById('lea-impact').innerHTML = `<span style="color: var(--accent-green);">$${leaNeed.toLocaleString()} target - $${leaCurrent.toLocaleString()} collectible = <strong>$${leaGap.toLocaleString()}</strong> LEA needed</span>`;
    }
    
    // ===== MSOC =====
    // Current = frozen $1,533, Need = slider amount
    const msocCurrent = 1533;
    const msocNeed = msocAmount;
    const msocGap = msocNeed - msocCurrent;
    document.getElementById('msoc-current').textContent = '$' + msocCurrent.toLocaleString();
    document.getElementById('msoc-need').textContent = '$' + msocNeed.toLocaleString();
    document.getElementById('msoc-gap').textContent = msocGap > 0 ? '-$' + msocGap.toLocaleString() : '$0';
    document.getElementById('msoc-gap').className = 'gap-value ' + (msocGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('msoc-impact').innerHTML = `<span style="color: var(--accent-green);">$${msocNeed.toLocaleString()} - $1,533 frozen = <strong>$${msocGap.toLocaleString()}</strong> per student</span>`;
    
    // ===== REFORM BENEFIT CALCULATION =====
    // Benefit = (Current slider funding) - (Reset/Baseline slider funding)
    // At Reset, all benefits should be $0

    // Baseline values (Reset state)
    const baselinePoverty = 0; // 0% weight
    const baselineSpedRate = 0.155; // 15.5% cap
    const baselineEll = 1200; // $1,200 TBIP
    const baselineRegion = 1.00; // 1.00 minimum
    const baselineMsoc = 1533; // $1,533 frozen

    // Calculate benefits (slider value - baseline value)
    const povertyBenefit = Math.round(baseFunding * povertyWeight * d.li) - Math.round(baseFunding * 0 * d.li);
    const spedBenefit = Math.round(baseFunding * (spedCap - baselineSpedRate) * 2.5);
    const ellBenefit = Math.round((ellFunding - baselineEll) * d.el);
    const regionBenefit = Math.max(0, Math.round(baseFunding * (regionMin - baselineRegion)));
    const msocBenefit = msocAmount - baselineMsoc;

    // LEA benefit: only count if slider is above the reset value
    const voterPerStudent = voterData ? Math.min(5000, Math.max(2021, Math.round(voterData.approved / d.t))) : 2500;
    const leaBaseline = voterPerStudent; // Reset sets LEA to voter-approved
    const leaBenefit = Math.max(0, leaThreshold - leaBaseline);

    // Total reform benefit
    const totalReformBenefit = Math.max(0, povertyBenefit) + Math.max(0, spedBenefit) + Math.max(0, ellBenefit) + regionBenefit + leaBenefit + Math.max(0, msocBenefit);

    // Calculate maximum possible benefit (all sliders at max vs baseline)
    const maxPovertyBenefit = Math.round(baseFunding * 0.30 * d.li); // 30% weight max
    const maxSpedBenefit = Math.round(baseFunding * (0.25 - 0.155) * 2.5); // 25% - 15.5%
    const maxEllBenefit = Math.round((2500 - 1200) * d.el); // $2,500 - $1,200
    const maxRegionBenefit = Math.round(baseFunding * (1.04 - 1.00)); // 1.04 - 1.00
    const maxMsocBenefit = 1980 - 1533; // $1,980 - $1,533
    const maxTotalBenefit = maxPovertyBenefit + maxSpedBenefit + maxEllBenefit + maxRegionBenefit + maxMsocBenefit;

    // Update total displays - show reform benefit as positive value
    const newGapValueEl = document.getElementById('newGapValue');
    if (newGapValueEl) {
        newGapValueEl.textContent = totalReformBenefit > 0 ? '+$' + totalReformBenefit.toLocaleString() : '$0';
    }

    const reformReductionEl = document.getElementById('reformReduction');
    if (reformReductionEl) {
        const benefitPercent = maxTotalBenefit > 0
            ? Math.round((totalReformBenefit / maxTotalBenefit) * 100)
            : 0;
        reformReductionEl.textContent = benefitPercent + '% of max';
    }
}

function updateGapDisplay(category, newGap, originalGap) {
    const elem = document.getElementById(category + '-gap');
    if (newGap < originalGap) {
        elem.innerHTML = newGap > 0 
            ? `-$${newGap.toLocaleString()} <span style="color: var(--accent-green); font-size: 0.8em;">(â†“$${(originalGap - newGap).toLocaleString()})</span>`
            : `<span style="color: var(--accent-green);">$0 âœ“</span>`;
        elem.className = 'gap-value ' + (newGap > 0 ? 'gap-negative' : 'gap-positive');
    } else {
        elem.textContent = newGap > 0 ? '-$' + newGap.toLocaleString() : '$0';
        elem.className = 'gap-value ' + (newGap > 0 ? 'gap-negative' : 'gap-positive');
    }
}

function applyPreset(preset) {
    const d = currentDistrict;
    if (!d) return;
    
    // LEAëŠ” í•­ìƒ ì´ˆê¸°ê°’(voter-approved) ìœ ì§€
    const voterData = VOTER_APPROVED_DATA[d.n];
    let leaFixed = 2500;
    if (voterData) {
        leaFixed = Math.min(5000, Math.max(2021, Math.round(voterData.approved / d.t)));
    }
    
    switch(preset) {
        case 'reset':
            document.getElementById('povertyWeightSlider').value = 0;
            document.getElementById('spedCapSlider').value = 155;
            document.getElementById('ellFundingSlider').value = 1200;
            document.getElementById('regionMinSlider').value = 100;
            document.getElementById('leaThresholdSlider').value = leaFixed; // ê³ ì •
            document.getElementById('msocSlider').value = 1533;
            break;
            
        case 'moderate':
            document.getElementById('povertyWeightSlider').value = 15;
            document.getElementById('spedCapSlider').value = 175;
            document.getElementById('ellFundingSlider').value = 1800;
            document.getElementById('regionMinSlider').value = 102;
            document.getElementById('leaThresholdSlider').value = leaFixed; // ê³ ì •
            document.getElementById('msocSlider').value = 1750;
            break;
            
        case 'aggressive':
            document.getElementById('povertyWeightSlider').value = 30;
            document.getElementById('spedCapSlider').value = 250;
            document.getElementById('ellFundingSlider').value = 2500;
            document.getElementById('regionMinSlider').value = 104;
            document.getElementById('leaThresholdSlider').value = leaFixed; // ê³ ì •
            document.getElementById('msocSlider').value = 1980;
            break;
            
        case 'district':
            setDistrictSliderDefaults(d);
            return; // setDistrictSliderDefaults already calls updateGapWithReforms
    }
    
    updateGapWithReforms();
}

function updateComparisonChart() {
    if (!currentDistrict) return;
    if (!allDistrictsForYear || allDistrictsForYear.length === 0) return;

    const svg = document.getElementById('scatterSvg');
    const container = document.getElementById('comparisonChart');
    if (!container || !svg) return;

    // Use minimum width if container is not visible
    const containerWidth = container.clientWidth || 600;
    const width = Math.max(200, containerWidth - 40);
    const height = 360;
    const margin = { top: 20, right: 30, bottom: 50, left: 70 };
    const plotWidth = Math.max(100, width - margin.left - margin.right);
    const plotHeight = height - margin.top - margin.bottom;
    
    const xAxis = document.getElementById('chartXAxis').value;
    const xLabel = xAxis === 'lowIncome' ? 'Low-Income %' : xAxis === 'ell' ? 'ELL %' : 'SpEd %';
    
    // Calculate gaps for all districts
    const plotData = allDistrictsForYear.map(d => ({
        name: d.n,
        x: xAxis === 'lowIncome' ? d.li : xAxis === 'ell' ? d.el : d.sp,
        y: calculateFundingGap(d).total,
        enrollment: d.t,
        isSelected: d.n === currentDistrict.n
    }));
    
    // Calculate linear regression
    const n = plotData.length;
    const sumX = plotData.reduce((sum, d) => sum + d.x, 0);
    const sumY = plotData.reduce((sum, d) => sum + d.y, 0);
    const sumXY = plotData.reduce((sum, d) => sum + d.x * d.y, 0);
    const sumXX = plotData.reduce((sum, d) => sum + d.x * d.x, 0);
    const sumYY = plotData.reduce((sum, d) => sum + d.y * d.y, 0);
    
    const denominator = n * sumXX - sumX * sumX;
    const slope = denominator !== 0 ? (n * sumXY - sumX * sumY) / denominator : 0;
    const intercept = (sumY - slope * sumX) / n;
    
    // Calculate RÂ²
    const meanY = sumY / n;
    const ssTotal = plotData.reduce((sum, d) => sum + Math.pow(d.y - meanY, 2), 0);
    const ssResidual = plotData.reduce((sum, d) => sum + Math.pow(d.y - (slope * d.x + intercept), 2), 0);
    const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;
    
    // Set proper axis ranges with minimum values
    const xMax = Math.max(0.9, Math.max(...plotData.map(d => d.x)) * 1.1);
    const yMax = Math.max(5000, Math.max(...plotData.map(d => d.y)) * 1.1);
    
    const scaleX = x => margin.left + (x / xMax) * plotWidth;
    const scaleY = y => margin.top + plotHeight - (y / yMax) * plotHeight;
    const scaleR = e => Math.max(4, Math.min(20, Math.sqrt(e / 1000) * 3));
    
    // Trendline endpoints (clipped to plot area)
    const trendX1 = 0;
    const trendY1 = Math.max(0, Math.min(yMax, intercept));
    const trendX2 = xMax;
    const trendY2 = Math.max(0, Math.min(yMax, slope * xMax + intercept));
    
    let svgContent = `
        <defs>
            <linearGradient id="dotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#4facfe;stop-opacity:0.8"/>
                <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:0.6"/>
            </linearGradient>
            <clipPath id="plotArea">
                <rect x="${margin.left}" y="${margin.top}" width="${plotWidth}" height="${plotHeight}"/>
            </clipPath>
        </defs>
        
        <!-- Grid lines -->
        <g class="grid">
            ${[0, 0.25, 0.5, 0.75, 1].map(t => `
                <line x1="${margin.left}" y1="${scaleY(t * yMax)}" x2="${width - margin.right}" y2="${scaleY(t * yMax)}" stroke="rgba(255,255,255,0.05)"/>
            `).join('')}
        </g>
        
        <!-- Axes -->
        <g class="axis">
            <line x1="${margin.left}" y1="${margin.top + plotHeight}" x2="${width - margin.right}" y2="${margin.top + plotHeight}" stroke="rgba(255,255,255,0.3)"/>
            <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotHeight}" stroke="rgba(255,255,255,0.3)"/>
        </g>
        
        <!-- Trendline (clipped) -->
        <g clip-path="url(#plotArea)">
            <line x1="${scaleX(trendX1)}" y1="${scaleY(trendY1)}" 
                  x2="${scaleX(trendX2)}" y2="${scaleY(trendY2)}" 
                  stroke="#feca57" stroke-width="2" stroke-dasharray="8,4" opacity="0.8"/>
        </g>
        
        <!-- RÂ² label -->
        <rect x="${width - margin.right - 95}" y="${margin.top + 5}" width="90" height="45" rx="6" fill="rgba(0,0,0,0.6)" stroke="rgba(254,202,87,0.5)"/>
        <text x="${width - margin.right - 50}" y="${margin.top + 25}" text-anchor="middle" fill="#feca57" font-size="11" font-weight="600">RÂ² = ${rSquared.toFixed(3)}</text>
        <text x="${width - margin.right - 50}" y="${margin.top + 42}" text-anchor="middle" fill="#888" font-size="9">${rSquared > 0.7 ? 'Strong' : rSquared > 0.4 ? 'Moderate' : 'Weak'} correlation</text>
        
        <!-- Axis labels -->
        <text x="${width / 2}" y="${height - 10}" text-anchor="middle" fill="#888" font-size="12">${xLabel}</text>
        <text x="15" y="${height / 2}" text-anchor="middle" fill="#888" font-size="12" transform="rotate(-90, 15, ${height / 2})">Funding Gap ($/student)</text>
        
        <!-- X-axis ticks -->
        ${[0, 0.2, 0.4, 0.6, 0.8].map(v => `
            <text x="${scaleX(v)}" y="${margin.top + plotHeight + 20}" text-anchor="middle" fill="#888" font-size="10">${(v * 100).toFixed(0)}%</text>
        `).join('')}
        
        <!-- Y-axis ticks -->
        ${[0, 1000, 2000, 3000, 4000, 5000].filter(v => v <= yMax).map(v => `
            <text x="${margin.left - 10}" y="${scaleY(v) + 4}" text-anchor="end" fill="#888" font-size="10">$${v.toLocaleString()}</text>
        `).join('')}
    `;
    
    // Draw dots (non-selected first)
    plotData.filter(d => !d.isSelected).forEach(d => {
        svgContent += `
            <circle class="dot" cx="${scaleX(d.x)}" cy="${scaleY(d.y)}" r="${scaleR(d.enrollment)}" 
                    fill="url(#dotGradient)" opacity="0.6"
                    onmouseover="showTooltip(event, '${d.name.replace(/'/g, "\\'")}', ${(d.x * 100).toFixed(1)}, ${d.y}, ${d.enrollment})"
                    onmouseout="hideTooltip()"/>
        `;
    });
    
    // Draw selected district last (on top)
    const selected = plotData.find(d => d.isSelected);
    if (selected) {
        svgContent += `
            <circle class="dot highlighted" cx="${scaleX(selected.x)}" cy="${scaleY(selected.y)}" r="${scaleR(selected.enrollment) + 4}" 
                    fill="#ff6b6b" stroke="white" stroke-width="2"
                    onmouseover="showTooltip(event, '${selected.name.replace(/'/g, "\\'")}', ${(selected.x * 100).toFixed(1)}, ${selected.y}, ${selected.enrollment})"
                    onmouseout="hideTooltip()"/>
            <text x="${scaleX(selected.x)}" y="${scaleY(selected.y) - scaleR(selected.enrollment) - 10}" 
                  text-anchor="middle" fill="#ff6b6b" font-size="11" font-weight="600">${selected.name.split(' ')[0]}</text>
        `;
    }
    
    svg.innerHTML = svgContent;
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
}

function showTooltip(e, name, x, y, enrollment) {
    const tooltip = document.getElementById('tooltip');
    tooltip.innerHTML = `
        <div class="tooltip-title">${name}</div>
        <div class="tooltip-row"><span>Demographic:</span><span>${x}%</span></div>
        <div class="tooltip-row"><span>Funding Gap:</span><span class="gap">-$${y.toLocaleString()}</span></div>
        <div class="tooltip-row"><span>Enrollment:</span><span>${enrollment.toLocaleString()}</span></div>
    `;
    tooltip.style.left = (e.pageX + 15) + 'px';
    tooltip.style.top = (e.pageY - 10) + 'px';
    tooltip.classList.add('visible');
}

function hideTooltip() {
    document.getElementById('tooltip').classList.remove('visible');
}

// ============== FAMILIES TAB ==============
function copyPageLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        const hint = document.getElementById('shareHint');
        hint.textContent = 'âœ“ Link copied!';
        hint.style.color = 'var(--accent-green)';
        setTimeout(() => {
            hint.textContent = 'â†’ Click to copy link';
            hint.style.color = '';
        }, 2000);
    }).catch(() => {
        alert('URL: ' + url);
    });
}

// ============== QUICK GUIDE HELPER FUNCTIONS ==============
function calculateFundingMix(district) {
    // Calculate estimated funding breakdown for a district
    // These are approximations based on district characteristics

    if (!district) {
        // State averages when no district selected
        return { state: 70, local: 22, federal: 8 };
    }

    const d = district;

    // Federal funding is primarily based on low-income % (Title I)
    // Higher low-income = more federal funding (range: 5-15%)
    const federalBase = 5;
    const federalFromPoverty = Math.min(10, d.li * 15);
    const federal = Math.round(federalBase + federalFromPoverty);

    // Local funding depends on LEA status and property wealth
    // Revenue-capped (wealthy) districts rely more on local
    // Rate-capped (poor) districts rely less on local
    let local;
    if (d.lea === 'revenue') {
        // Wealthy districts: higher local contribution (20-30%)
        local = Math.round(20 + (1 - d.li) * 10);
    } else {
        // Poor districts: lower local contribution (12-20%)
        local = Math.round(12 + (1 - d.li) * 8);
    }

    // State makes up the remainder
    const state = 100 - federal - local;

    return { state, local, federal };
}

function updateQuickGuidePieChart(mix, district) {
    // Update pie chart visual
    const pieChart = document.getElementById('pie-chart');
    if (pieChart) {
        const stateEnd = mix.state;
        const localEnd = stateEnd + mix.local;
        pieChart.style.background = `conic-gradient(
            #2563eb 0% ${stateEnd}%,
            #10b981 ${stateEnd}% ${localEnd}%,
            #ffc107 ${localEnd}% 100%
        )`;
    }

    // Update legend percentages
    const statePct = document.getElementById('pie-state-pct');
    const localPct = document.getElementById('pie-local-pct');
    const federalPct = document.getElementById('pie-federal-pct');

    if (statePct) statePct.textContent = mix.state + '%';
    if (localPct) localPct.textContent = mix.local + '%';
    if (federalPct) federalPct.textContent = mix.federal + '%';

    // Calculate and update dollar amounts
    // Use state average enrollment if no district selected
    const stateAvg = STATE_AVERAGES || { enrollment: 3500 };
    const enrollment = district ? district.t : (stateAvg.enrollment || 3500);

    // WA average per-pupil funding is approximately $16,000-$17,000
    const perPupilTotal = 16500;
    const totalFunding = enrollment * perPupilTotal;

    const stateAmt = Math.round(totalFunding * mix.state / 100);
    const localAmt = Math.round(totalFunding * mix.local / 100);
    const federalAmt = Math.round(totalFunding * mix.federal / 100);

    // Format amounts
    function formatAmount(amt) {
        if (amt >= 1000000000) {
            return '$' + (amt / 1000000000).toFixed(1) + 'B';
        } else if (amt >= 1000000) {
            return '$' + (amt / 1000000).toFixed(1) + 'M';
        } else if (amt >= 1000) {
            return '$' + (amt / 1000).toFixed(0) + 'K';
        }
        return '$' + amt.toLocaleString();
    }

    const stateAmtEl = document.getElementById('pie-state-amt');
    const localAmtEl = document.getElementById('pie-local-amt');
    const federalAmtEl = document.getElementById('pie-federal-amt');

    if (stateAmtEl) stateAmtEl.textContent = formatAmount(stateAmt);
    if (localAmtEl) localAmtEl.textContent = formatAmount(localAmt);
    if (federalAmtEl) federalAmtEl.textContent = formatAmount(federalAmt);

    // Update total amount in center of pie chart
    const totalAmtEl = document.getElementById('pie-total-amt');
    if (totalAmtEl) totalAmtEl.textContent = formatAmount(totalFunding);

    // Update aria label
    const pieAria = document.getElementById('pie-chart-aria');
    if (pieAria) {
        pieAria.setAttribute('aria-label',
            `Pie chart showing school funding sources: ${mix.state}% State (${formatAmount(stateAmt)}), ${mix.local}% Local (${formatAmount(localAmt)}), ${mix.federal}% Federal (${formatAmount(federalAmt)})`);
    }
}

function updateQuickGuideProblemSection(district) {
    // Use state averages if no district selected (with fallback values)
    const stateAvg = STATE_AVERAGES || { lowIncome: 0.45, sped: 0.155, ell: 0.12, cis: 1.02 };
    const d = district || {
        n: 'Washington State Average',
        t: 3500,
        li: stateAvg.lowIncome || 0.45,
        sp: stateAvg.sped || 0.155,
        el: stateAvg.ell || 0.12,
        cis: stateAvg.cis || 1.02,
        lea: 'rate',
        av: 10000000000
    };

    const districtLabel = district ? d.n : 'Average WA district';

    // Problem 1: Poverty
    const liPct = document.getElementById('guide-li-pct');
    const povertyBenefit = document.getElementById('guide-poverty-benefit');
    const label1 = document.getElementById('guide-district-label');

    if (liPct) liPct.textContent = (d.li * 100).toFixed(1) + '%';
    if (povertyBenefit) {
        const benefit = Math.round(d.li * d.t * 12500 * 0.2);
        povertyBenefit.textContent = '+$' + benefit.toLocaleString();
    }
    if (label1) label1.textContent = districtLabel;

    // Problem 2: SpEd
    const spedPct = document.getElementById('guide-sped-pct');
    const spedStatus = document.getElementById('guide-sped-status');
    const spedDetail = document.getElementById('guide-sped-detail');
    const label2 = document.getElementById('guide-district-label2');

    if (spedPct) spedPct.textContent = (d.sp * 100).toFixed(1) + '%';
    if (label2) label2.textContent = districtLabel;

    if (d.sp > 0.155) {
        const overPct = ((d.sp - 0.155) * 100).toFixed(1);
        const studentsOver = Math.round((d.sp - 0.155) * d.t);
        const unfundedAmount = studentsOver * 25000;
        if (spedStatus) {
            spedStatus.innerHTML = `${overPct}% OVER the cap!`;
        }
        if (spedDetail) {
            spedDetail.innerHTML = `${studentsOver} students unfunded: +$${unfundedAmount.toLocaleString()}/year needs more funding`;
        }
    } else {
        if (spedStatus) {
            spedStatus.innerHTML = `âœ“ Under the 15.5% cap`;
        }
        if (spedDetail) {
            spedDetail.textContent = '';
        }
    }

    // Problem 3: ELL
    const ellPct = document.getElementById('guide-ell-pct');
    const ellGap = document.getElementById('guide-ell-gap');
    const label3 = document.getElementById('guide-district-label3');

    if (ellPct) ellPct.textContent = (d.el * 100).toFixed(1) + '%';
    if (label3) label3.textContent = districtLabel;
    if (ellGap) {
        const ellStudents = Math.round(d.el * d.t);
        const gap = ellStudents * 1300; // $2,500 - $1,200 = $1,300 gap per ELL
        ellGap.textContent = '+$' + gap.toLocaleString();
    }

    // Problem 4: MSOC
    const msocGap = document.getElementById('guide-msoc-gap');
    const label4 = document.getElementById('guide-district-label4');

    if (label4) label4.textContent = districtLabel;
    if (msocGap) {
        const gap = d.t * 447; // $1,980 - $1,533 = $447 gap per student
        msocGap.textContent = '$' + gap.toLocaleString();
    }

    // Problem 5: Levy
    const levyStatus = document.getElementById('guide-levy-status');
    const label5 = document.getElementById('guide-district-label5');

    if (label5) label5.textContent = districtLabel;
    if (levyStatus) {
        const ppAV = d.av / d.t;
        const levy250 = Math.round(ppAV * 0.0025);

        if (d.lea === 'revenue') {
            // Wealthy district - hit by levy cap
            const voterData = VOTER_APPROVED_DATA[d.n];
            if (voterData) {
                const perStudent = Math.round(voterData.approved / d.t);
                if (perStudent > 2500) {
                    const loss = (perStudent - 2500) * d.t;
                    levyStatus.innerHTML = `Voters approved $${perStudent.toLocaleString()}/student, but levy cap limits to $2,500. Loses $${loss.toLocaleString()}/year!`;
                } else {
                    levyStatus.innerHTML = `âœ“ Levy within cap at $${perStudent.toLocaleString()}/student`;
                }
            } else {
                levyStatus.innerHTML = `High property values allow adequate local funding at ~$${levy250.toLocaleString()}/student.`;
            }
        } else {
            // Poor district - needs LEA
            const leaNeeded = Math.max(0, 2500 - levy250);
            levyStatus.innerHTML = `Low property values only generate $${levy250.toLocaleString()}/student at max rate. Needs $${leaNeeded.toLocaleString()} LEA assistance.`;
        }
    }
}

function updateFamiliesTab() {
    // Always update pie chart and problem section (with state averages if no district)
    console.log('updateFamiliesTab called, currentDistrict:', currentDistrict ? currentDistrict.n : 'none');
    const mix = calculateFundingMix(currentDistrict);
    updateQuickGuidePieChart(mix, currentDistrict);
    updateQuickGuideProblemSection(currentDistrict);

    if (!currentDistrict) {
        document.getElementById('familiesDistrictName').textContent = 'Your District';
        document.getElementById('familiesDistrictStats').innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ‘†</div>
                <p style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 15px;">
                    <strong>Pick your school district above!</strong>
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    We'll show you exactly how much money your child's school is missing.
                </p>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="featured-btn" onclick="selectFeatured('Bellevue School District')" style="padding: 10px 20px; cursor: pointer;">Try Bellevue</button>
                    <button class="featured-btn" onclick="selectFeatured('Yakima School District')" style="padding: 10px 20px; cursor: pointer;">Try Yakima</button>
                    <button class="featured-btn" onclick="selectFeatured('Seattle Public Schools')" style="padding: 10px 20px; cursor: pointer;">Try Seattle</button>
                </div>
            </div>
        `;
        return;
    }
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    const totalGap = gap.total * d.t;
    
    document.getElementById('familiesDistrictName').textContent = d.n;
    
    // Calculate values
    const avgTeacherSalary = 85000;
    const potentialTeachers = Math.round(totalGap / avgTeacherSalary);
    const stateAvgGap = 2718;
    const stateAvgLI = 45.0;
    const stateAvgELL = 12.0;
    
    // LEA status text
    const leaStatus = d.lea === 'revenue' ? 'Revenue-Capped' : 'Rate-Capped';
    const leaSubtext = d.lea === 'revenue' ? 'Levy cap limits collection' : 'Needs LEA assistance';
    
    // SpEd status
    const spedOver = d.sp > 0.155;
    const spedOverAmount = spedOver ? ((d.sp - 0.155) * 100).toFixed(1) : 0;
    
    // Regionalization status
    const regionStatus = d.cis >= 1.04 ? 'At maximum' : d.cis >= 1.02 ? 'Above average' : 'Below average';
    
    document.getElementById('familiesDistrictStats').innerHTML = `
        <div class="families-metrics-grid">
            <!-- Row 1 -->
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ’¸</span>
                    <span class="metric-title">Total Funding Gap</span>
                </div>
                <div class="metric-value">-$${(totalGap / 1000000).toFixed(1)}M</div>
                <div class="metric-subtext">${d.t.toLocaleString()} students Ã— $${gap.total.toLocaleString()}</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦</span>
                    <span class="metric-title">Enrollment</span>
                </div>
                <div class="metric-value">${d.t.toLocaleString()}</div>
                <div class="metric-subtext">${d.c} County</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ’°</span>
                    <span class="metric-title">Per-Student Gap</span>
                </div>
                <div class="metric-value">-$${gap.total.toLocaleString()}</div>
                <div class="metric-subtext">State avg: -$${stateAvgGap.toLocaleString()}</div>
            </div>

            <!-- Row 2 -->
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ“Š</span>
                    <span class="metric-title">Low-Income %</span>
                </div>
                <div class="metric-value">${(d.li * 100).toFixed(1)}%</div>
                <div class="metric-subtext">State avg: ${stateAvgLI}%</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">â™¿</span>
                    <span class="metric-title">SpEd %</span>
                </div>
                <div class="metric-value">${(d.sp * 100).toFixed(1)}%</div>
                <div class="metric-subtext">${spedOver ? spedOverAmount + '% over cap!' : 'Within 15.5% cap'}</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸŒ</span>
                    <span class="metric-title">ELL %</span>
                </div>
                <div class="metric-value">${(d.el * 100).toFixed(1)}%</div>
                <div class="metric-subtext">State avg: ${stateAvgELL}%</div>
            </div>

            <!-- Row 3 -->
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ¦</span>
                    <span class="metric-title">LEA Status</span>
                </div>
                <div class="metric-value" style="font-size: 1.4rem;">${leaStatus}</div>
                <div class="metric-subtext">${leaSubtext}</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ—ºï¸</span>
                    <span class="metric-title">Regionalization</span>
                </div>
                <div class="metric-value">${d.cis.toFixed(2)}</div>
                <div class="metric-subtext">${regionStatus}</div>
            </div>

            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon">ðŸ“¦</span>
                    <span class="metric-title">MSOC</span>
                </div>
                <div class="metric-value">$1,533</div>
                <div class="metric-subtext">Frozen since 2018</div>
            </div>
        </div>

        <div style="margin-top: 25px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px;">
            <p style="font-size: 1.1rem; line-height: 1.8; margin: 0;">
                <strong>ðŸ’¡ What does this mean?</strong> Your district is missing <strong>$${gap.total.toLocaleString()}</strong> per student every year.
                That's <strong>$${(totalGap / 1000000).toFixed(1)} million</strong> total â€” enough to hire <strong>${potentialTeachers} more teachers</strong>!
            </p>
        </div>
    `;
}

// ============== PROBLEMS TAB ==============
function updateProblemsTab() {
    if (!currentDistrict) {
        document.getElementById('problemDistrictName').textContent = 'your district';
        return;
    }
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    document.getElementById('problemDistrictName').textContent = d.n;
    
    // Problem 1: Poverty
    document.getElementById('problem1Impact').textContent = '$' + gap.components.poverty.toLocaleString() + ' unfunded';
    document.getElementById('problem1Solution').textContent = '+$' + Math.round(d.li * d.t * 12500 * 0.2).toLocaleString() + ' for your district';
    
    // Problem 2: SpEd
    if (d.sp > 0.155) {
        document.getElementById('problem2Impact').textContent = ((d.sp - 0.155) * 100).toFixed(1) + '% above cap';
    } else {
        document.getElementById('problem2Impact').textContent = 'Under cap âœ“';
    }
    document.getElementById('problem2Solution').textContent = d.sp > 0.155 ? '+$' + Math.round((d.sp - 0.155) * d.t * 25000).toLocaleString() + ' for your district' : 'No additional impact';
    
    // Problem 4: Regionalization
    document.getElementById('problem4Impact').textContent = d.cis.toFixed(2);
    
    // Problem 5: LEA
    document.getElementById('problem5Impact').textContent = d.lea === 'rate' ? 'Rate-Capped (Disadvantaged)' : 'Revenue-Capped';
    
    // Problem 6: Enrollment change (estimated)
    document.getElementById('problem6Impact').textContent = '-3.2% (estimated)';
}

function toggleProblem(card, problemId) {
    const wasExpanded = card.classList.contains('expanded');
    
    // Close all
    document.querySelectorAll('.problem-card').forEach(c => c.classList.remove('expanded'));
    
    // Toggle clicked
    if (!wasExpanded) {
        card.classList.add('expanded');
    }
}

// ============== COMPARE TAB ==============
function updateComparison() {
    if (!currentDistrict) return;
    
    const compareType = document.getElementById('compareToSelect').value;
    const compareDistrictGroup = document.getElementById('compareDistrictGroup');
    
    if (compareType === 'district') {
        compareDistrictGroup.style.display = 'block';
    } else {
        compareDistrictGroup.style.display = 'none';
    }
    
    let compareData;
    let compareName;
    
    if (compareType === 'state') {
        compareName = 'State Average';
        compareData = {
            enrollment: STATE_AVERAGES.enrollment,
            li: STATE_AVERAGES.lowIncome,
            sp: STATE_AVERAGES.sped,
            el: STATE_AVERAGES.ell,
            cis: STATE_AVERAGES.cis,
            gap: STATE_AVERAGES.perPupilGap
        };
    } else if (compareType === 'county') {
        const countyDistricts = allDistrictsForYear.filter(d => d.c === currentDistrict.c);
        compareName = currentDistrict.c + ' County Avg';
        compareData = {
            enrollment: Math.round(countyDistricts.reduce((sum, d) => sum + d.t, 0) / countyDistricts.length),
            li: countyDistricts.reduce((sum, d) => sum + d.li, 0) / countyDistricts.length,
            sp: countyDistricts.reduce((sum, d) => sum + d.sp, 0) / countyDistricts.length,
            el: countyDistricts.reduce((sum, d) => sum + d.el, 0) / countyDistricts.length,
            cis: countyDistricts.reduce((sum, d) => sum + d.cis, 0) / countyDistricts.length,
            gap: Math.round(countyDistricts.reduce((sum, d) => sum + calculateFundingGap(d).total, 0) / countyDistricts.length)
        };
    } else {
        const compareDistrictName = document.getElementById('compareDistrictSelect').value;
        const compareDistrict = allDistrictsForYear.find(d => d.n === compareDistrictName);
        if (compareDistrict) {
            compareName = compareDistrict.n;
            compareData = {
                enrollment: compareDistrict.t,
                li: compareDistrict.li,
                sp: compareDistrict.sp,
                el: compareDistrict.el,
                cis: compareDistrict.cis,
                gap: calculateFundingGap(compareDistrict).total
            };
        } else {
            return;
        }
    }
    
    const d = currentDistrict;
    const myGap = calculateFundingGap(d);
    
    document.getElementById('compareCol1').textContent = d.n.split(' ').slice(0, 2).join(' ');
    document.getElementById('compareCol2').textContent = compareName;
    
    const rows = [
        { metric: 'Enrollment', mine: d.t, theirs: compareData.enrollment, format: 'number' },
        { metric: 'Per-Pupil Gap', mine: myGap.total, theirs: compareData.gap, format: 'currency', inverse: true },
        { metric: 'Low-Income %', mine: d.li, theirs: compareData.li, format: 'percent', inverse: true },
        { metric: 'SpEd %', mine: d.sp, theirs: compareData.sp, format: 'percent' },
        { metric: 'ELL %', mine: d.el, theirs: compareData.el, format: 'percent' },
        { metric: 'CIS Factor', mine: d.cis, theirs: compareData.cis, format: 'decimal' }
    ];
    
    document.getElementById('comparisonBody').innerHTML = rows.map(r => {
        let mineStr, theirsStr, diff, diffClass;
        
        if (r.format === 'number') {
            mineStr = r.mine.toLocaleString();
            theirsStr = r.theirs.toLocaleString();
            diff = r.mine - r.theirs;
            diffClass = '';
        } else if (r.format === 'currency') {
            mineStr = '-$' + r.mine.toLocaleString();
            theirsStr = '-$' + r.theirs.toLocaleString();
            diff = r.mine - r.theirs;
            diffClass = r.inverse ? (diff > 0 ? 'diff-positive' : 'diff-negative') : (diff > 0 ? 'diff-negative' : 'diff-positive');
        } else if (r.format === 'percent') {
            mineStr = (r.mine * 100).toFixed(1) + '%';
            theirsStr = (r.theirs * 100).toFixed(1) + '%';
            diff = (r.mine - r.theirs) * 100;
            diffClass = r.inverse ? (diff > 0 ? 'diff-positive' : 'diff-negative') : '';
        } else {
            mineStr = r.mine.toFixed(2);
            theirsStr = r.theirs.toFixed(2);
            diff = r.mine - r.theirs;
            diffClass = diff > 0 ? 'diff-negative' : '';
        }
        
        const diffStr = r.format === 'percent' ? (diff > 0 ? '+' : '') + diff.toFixed(1) + '%' :
                       r.format === 'currency' ? (diff > 0 ? '+' : '') + '$' + Math.abs(diff).toLocaleString() :
                       r.format === 'decimal' ? (diff > 0 ? '+' : '') + diff.toFixed(2) :
                       (diff > 0 ? '+' : '') + diff.toLocaleString();
        
        return `
            <tr>
                <td style="font-weight: 600;">${r.metric}</td>
                <td>${mineStr}</td>
                <td>${theirsStr}</td>
                <td class="${diffClass}">${diffStr}</td>
            </tr>
        `;
    }).join('');
}

function updateRankings() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const myGap = calculateFundingGap(d).total;
    
    // Sort all districts by gap (descending)
    const sortedByGap = [...allDistrictsForYear]
        .map(dist => ({ name: dist.n, gap: calculateFundingGap(dist).total }))
        .sort((a, b) => b.gap - a.gap);
    
    const gapRank = sortedByGap.findIndex(x => x.name === d.n) + 1;
    const gapPercentile = Math.round((gapRank / sortedByGap.length) * 100);
    
    document.getElementById('gapRank').textContent = `#${gapRank} of ${sortedByGap.length}`;
    document.getElementById('gapRankFill').style.width = gapPercentile + '%';
    document.getElementById('gapRankDesc').textContent = `Worse gap than ${100 - gapPercentile}% of districts`;
    
    // Poverty ranking
    const sortedByPoverty = [...allDistrictsForYear].sort((a, b) => b.li - a.li);
    const povertyRank = sortedByPoverty.findIndex(x => x.n === d.n) + 1;
    const povertyPercentile = Math.round((povertyRank / sortedByPoverty.length) * 100);
    
    document.getElementById('povertyRank').textContent = `#${povertyRank} of ${sortedByPoverty.length}`;
    document.getElementById('povertyRankFill').style.width = povertyPercentile + '%';
    document.getElementById('povertyRankDesc').textContent = `Higher poverty than ${100 - povertyPercentile}% of districts`;
    
    // SpEd ranking
    const sortedBySpEd = [...allDistrictsForYear].sort((a, b) => b.sp - a.sp);
    const spedRank = sortedBySpEd.findIndex(x => x.n === d.n) + 1;
    const spedPercentile = Math.round((spedRank / sortedBySpEd.length) * 100);
    
    document.getElementById('spedRank').textContent = `#${spedRank} of ${sortedBySpEd.length}`;
    document.getElementById('spedRankFill').style.width = spedPercentile + '%';
    document.getElementById('spedRankDesc').textContent = `Higher SpEd % than ${100 - spedPercentile}% of districts`;
}

function comparePreset(type, element) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    }
    
    // For now, just switch to county comparison
    document.getElementById('compareToSelect').value = 'county';
    updateComparison();
}

// ============== SOLUTIONS TAB ==============
function selectYear(year, element) {
    document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    } else {
        // Find the element for the year if not provided
        const items = document.querySelectorAll('.timeline-item');
        const yearIndex = year - 2025;
        if (items[yearIndex]) {
            items[yearIndex].classList.add('active');
        }
    }
    
    const reform = REFORM_POLICIES[year];
    if (!reform) return;
    
    const detail = document.getElementById('yearDetail');
    
    detail.innerHTML = `
        <h3>ðŸ“… ${reform.title}</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Estimated Total Cost: <span style="color: var(--accent-yellow); font-weight: 600;">${reform.cost}</span></p>
        <div class="policy-grid">
            ${reform.policies.map(p => `
                <div class="policy-card priority-${p.priority}">
                    <h4>${p.name}</h4>
                    <p>${p.desc}</p>
                    <div class="cost">Est. Cost: <span>${p.cost}</span></div>
                </div>
            `).join('')}
        </div>
    `;
}

function updateSolutionSimulator() {
    const poverty = parseInt(document.getElementById('solPovertySlider').value);
    const sped = parseInt(document.getElementById('solSpedSlider').value) / 100;
    const lea = parseInt(document.getElementById('solLeaSlider').value);
    
    document.getElementById('solPovertyValue').textContent = poverty + '%';
    document.getElementById('solSpedValue').textContent = (sped * 100).toFixed(1) + '%';
    document.getElementById('solLeaValue').textContent = '$' + lea.toLocaleString();
    
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const baseFunding = 12500;
    
    // Calculate total benefit
    const povertyBenefit = d.li * d.t * baseFunding * (poverty / 100);
    const spedBenefit = d.sp > sped ? 0 : (d.sp > 0.155 ? (Math.min(d.sp, sped) - 0.155) * d.t * 25000 : 0);
    
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    const leaBenefit = d.lea === 'rate' && levy250 < lea ? Math.max(0, lea - Math.max(levy250, 2021)) * d.t : 0;
    
    const totalBenefit = povertyBenefit + spedBenefit + leaBenefit;
    const perStudent = d.t > 0 ? Math.round(totalBenefit / d.t) : 0;
    
    // Rough statewide cost estimate
    const statewideCost = (poverty * 0.25 + (sped - 0.155) * 1.5 + (lea - 2021) * 0.0008).toFixed(1);
    
    document.getElementById('solTotalBenefit').textContent = '+$' + Math.round(totalBenefit).toLocaleString() + '/year';
    document.getElementById('solPerStudent').textContent = '+$' + perStudent.toLocaleString();
    document.getElementById('solStatewideCost').textContent = '$' + statewideCost + 'B';
}

// ============== BRIEF TAB ==============
function updateBrief() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    document.getElementById('briefDistrictName').textContent = d.n;
    document.getElementById('briefYear').textContent = currentYear;
    document.getElementById('briefDate').textContent = new Date().toLocaleDateString();
    
    document.getElementById('briefSummary').innerHTML = `
        ${d.n} serves <strong>${d.t.toLocaleString()}</strong> students in ${d.c} County. 
        Our district faces a per-pupil funding gap of <strong style="color: #ff6b6b;">$${gap.total.toLocaleString()}</strong>, 
        representing a <strong style="color: #ff6b6b;">$${(gap.total * d.t).toLocaleString()}</strong> annual shortfall 
        that directly impacts classroom resources and student outcomes.
    `;
    
    document.getElementById('briefMetrics').innerHTML = `
        <div class="brief-metric"><span class="label">Total Enrollment</span><span class="value">${d.t.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value">${STATE_AVERAGES.enrollment.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">Low-Income Students</span><span class="value">${(d.li * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value">${(STATE_AVERAGES.lowIncome * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">Per-Pupil Funding Gap</span><span class="value gap">-$${gap.total.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value gap">-$${STATE_AVERAGES.perPupilGap.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">Special Education %</span><span class="value">${(d.sp * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">State Cap</span><span class="value">15.5%</span></div>
    `;
    
    // Sort challenges by impact
    const challenges = [
        { name: 'No Poverty Weight', impact: gap.components.poverty },
        { name: 'SpEd 15.5% Cap', impact: gap.components.sped },
        { name: 'MSOC Inflation Freeze', impact: gap.components.msoc },
        { name: 'LEA Inequality', impact: gap.components.lea },
        { name: 'Regionalization Gap', impact: gap.components.region },
        { name: 'ELL Underfunding', impact: gap.components.ell }
    ].filter(c => c.impact > 0).sort((a, b) => b.impact - a.impact).slice(0, 3);
    
    document.getElementById('briefChallenges').innerHTML = challenges.map((c, i) => `
        <li>
            <span class="challenge-title">${i + 1}. ${c.name}</span><br>
            <span class="challenge-impact">Impact: $${(c.impact * d.t).toLocaleString()} annual shortfall ($${c.impact.toLocaleString()}/student)</span>
        </li>
    `).join('');
    
    document.getElementById('briefActions').innerHTML = `
        <li>âœ“ Implement 20% poverty weight â†’ <span class="benefit">+$${Math.round(d.li * d.t * 12500 * 0.2).toLocaleString()}</span> for our district</li>
        <li>âœ“ Raise SpEd cap to 17.5% â†’ <span class="benefit">+$${Math.round(Math.max(0, d.sp - 0.155) * d.t * 25000).toLocaleString()}</span> for our district</li>
        <li>âœ“ Restore MSOC to inflation-adjusted levels â†’ <span class="benefit">+$${Math.round(450 * d.t).toLocaleString()}</span> for our district</li>
    `;
}

function generateBrief() {
    // Find and click the brief tab button
    const briefTabBtn = document.querySelector('.tab-btn:nth-child(5)');
    showTab('brief', briefTabBtn);
}

function printBrief() {
    document.getElementById('tab-brief').classList.add('brief-print');
    window.print();
    document.getElementById('tab-brief').classList.remove('brief-print');
}

function copyBrief() {
    const d = currentDistrict;
    if (!d) {
        alert('Please select a district first.');
        return;
    }
    
    const gap = calculateFundingGap(d);
    
    const text = `
${d.n.toUpperCase()}
K-12 Funding Gap Analysis | Fiscal Year ${currentYear}

EXECUTIVE SUMMARY
${d.n} serves ${d.t.toLocaleString()} students in ${d.c} County. Our district faces a per-pupil funding gap of $${gap.total.toLocaleString()}, representing a $${(gap.total * d.t).toLocaleString()} annual shortfall.

KEY METRICS
- Enrollment: ${d.t.toLocaleString()}
- Low-Income: ${(d.li * 100).toFixed(1)}%
- SpEd: ${(d.sp * 100).toFixed(1)}%
- Per-Pupil Gap: -$${gap.total.toLocaleString()}

Generated by WA K-12 Funding Analysis Tool
${new Date().toLocaleDateString()}
    `.trim();
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Brief copied to clipboard!');
    });
}

// Window resize handler
window.addEventListener('resize', () => {
    if (currentDistrict) {
        updateComparisonChart();
    }
});
</script>
</body>
</html>
