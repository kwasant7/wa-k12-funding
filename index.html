<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA K-12 Funding Gap Analysis Dashboard</title>
    <style>
        /* ============== CSS VARIABLES (Shared Theme) ============== */
        :root {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #4facfe;
            --accent-red: #ff6b6b;
            --accent-yellow: #feca57;
            --accent-green: #2ed573;
            --text-primary: #e4e4e4;
            --text-secondary: #888;
            --card-bg: rgba(255,255,255,0.03);
            --card-border: rgba(255,255,255,0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* ============== GLOBAL HEADER ============== */
        .global-header {
            padding: 12px 30px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue) 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .control-group label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            background: rgba(0,0,0,0.3);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 180px;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .btn-generate {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-blue), #00f2fe);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }
        
        /* ============== FEATURED DISTRICTS ============== */
        .featured-districts {
            padding: 10px 30px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .featured-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .featured-btn {
            padding: 6px 14px;
            background: rgba(79, 172, 254, 0.1);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            color: var(--accent-blue);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .featured-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--accent-blue);
        }
        
        /* ============== TAB NAVIGATION ============== */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--card-border);
            overflow-x: auto;
            padding: 0 20px;
        }
        
        .tab-btn {
            padding: 14px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            color: var(--accent-blue);
            background: rgba(79, 172, 254, 0.1);
        }
        
        .tab-btn.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
            background: rgba(79, 172, 254, 0.05);
        }
        
        .tab-btn.problems.active {
            color: var(--accent-red);
            border-bottom-color: var(--accent-red);
            background: rgba(255, 107, 107, 0.05);
        }
        
        .tab-btn.solutions.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
            background: rgba(46, 213, 115, 0.05);
        }
        
        /* ============== FOR FAMILIES TAB STYLES ============== */
        .families-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .families-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .families-header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .families-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        .families-section {
            margin-bottom: 30px;
        }
        
        .families-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--card-border);
        }
        
        .families-card.problem-card-families {
            border-left: 4px solid var(--accent-red);
        }
        
        .families-card.highlight-card {
            border-left: 4px solid var(--accent-blue);
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 0, 0, 0.2));
        }
        
        .families-card.action-card {
            border-left: 4px solid var(--accent-green);
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(0, 0, 0, 0.2));
        }
        
        .families-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .families-card h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 25px;
        }
        
        .families-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .simple-text {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }
        
        /* Money Sources */
        .money-sources {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .source-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .source-icon {
            font-size: 2.5rem;
            min-width: 60px;
            text-align: center;
        }
        
        .source-text strong {
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .source-text p {
            margin-top: 5px;
            color: var(--text-secondary);
        }
        
        /* Problem List */
        .problem-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .problem-item-simple {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .problem-number {
            min-width: 40px;
            height: 40px;
            background: var(--accent-red);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .problem-explain strong {
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .problem-explain p {
            margin-top: 8px;
        }
        
        .highlight-red {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        /* Impact Grid */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .impact-item {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .impact-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .impact-text strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 8px;
        }
        
        .impact-text p {
            font-size: 0.9rem;
        }
        
        /* Action List */
        .action-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .action-icon {
            font-size: 2rem;
        }
        
        .action-text strong {
            color: var(--accent-green);
            font-size: 1rem;
        }
        
        .action-text p {
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        /* Action Link Styles */
        a.action-link {
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
        }
        
        .action-link:hover {
            background: rgba(46, 213, 115, 0.2);
            border-color: var(--accent-green);
            transform: translateY(-2px);
        }
        
        .link-hint {
            display: block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--accent-green);
            opacity: 0.8;
        }
        
        .action-link:hover .link-hint {
            opacity: 1;
        }
        
        /* Glossary */
        .glossary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .glossary-item {
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .glossary-item strong {
            color: var(--accent-blue);
            display: block;
            margin-bottom: 5px;
        }
        
        .glossary-item p {
            font-size: 0.9rem;
        }
        
        /* District Simple Stats */
        .district-simple-stats {
            padding: 20px;
        }
        
        /* Families Metrics Grid (KPI Cards) */
        .families-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .families-metric-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .families-metric-card:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: var(--accent-blue);
        }
        
        .families-metric-card.highlight-red {
            border-left: 4px solid var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(0, 0, 0, 0.3));
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .metric-icon {
            font-size: 1.2rem;
        }
        
        .metric-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        .metric-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .families-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 500px) {
            .families-metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .simple-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .simple-stat-item {
            text-align: center;
            padding: 25px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .simple-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        
        .simple-stat-value.negative {
            color: var(--accent-red);
        }
        
        .simple-stat-label {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .simple-stat-explain {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Responsive for Families */
        @media (max-width: 768px) {
            .impact-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-list {
                grid-template-columns: 1fr;
            }
            
            .glossary {
                grid-template-columns: 1fr;
            }
            
            .simple-stat-grid {
                grid-template-columns: 1fr;
            }
            
            .families-header h1 {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 500px) {
            .impact-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ============== TAB CONTENT ============== */
        .tab-content {
            display: none;
            padding: 20px 30px;
            max-width: 1500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ============== SECTION STYLES ============== */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.1rem;
            color: var(--accent-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* ============== TAB 1: MY DISTRICT - METRICS GRID ============== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 900px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 500px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
        
        .metric-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px 12px;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: rgba(79, 172, 254, 0.3);
            background: rgba(0,0,0,0.3);
        }
        
        .metric-card.status-red { border-left: 3px solid var(--accent-red); }
        .metric-card.status-yellow { border-left: 3px solid var(--accent-yellow); }
        .metric-card.status-green { border-left: 3px solid var(--accent-green); }
        
        .metric-card.highlight-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 107, 107, 0.05));
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-left: 4px solid var(--accent-red);
        }
        
        .metric-card.highlight-card .metric-value {
            font-size: 2rem;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .metric-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .metric-value.red { color: var(--accent-red); }
        .metric-value.yellow { color: var(--accent-yellow); }
        .metric-value.green { color: var(--accent-green); }
        .metric-value.blue { color: var(--accent-blue); }
        
        .metric-subtitle {
            font-size: 0.7rem;
            color: #666;
        }
        
        /* Metric Card Tooltip */
        .metric-card {
            position: relative;
        }
        
        .metric-card .card-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 15, 30, 0.98);
            border: 1px solid rgba(79, 172, 254, 0.5);
            border-radius: 10px;
            padding: 15px;
            width: 280px;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        
        .metric-card .card-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(79, 172, 254, 0.5);
        }
        
        .metric-card:hover .card-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .card-tooltip .tt-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        
        .card-tooltip .tt-text {
            font-size: 0.8rem;
            color: #ccc;
            line-height: 1.5;
        }
        
        .card-tooltip .tt-text strong {
            color: #fff;
        }
        
        .card-tooltip .tt-highlight {
            color: var(--accent-yellow);
        }
        
        .card-tooltip .tt-warning {
            color: var(--accent-red);
            display: block;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(79, 172, 254, 0.3);
            color: var(--accent-blue);
            font-size: 0.6rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            font-style: normal;
            margin-left: 4px;
        }
        
        /* ============== INTERPRETATION TABLE ============== */
        .interpretation-table {
            margin-top: 25px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .interpretation-title {
            font-size: 0.95rem;
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .interpretation-table table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 0.85rem;
        }
        
        .interpretation-table th {
            text-align: left;
            padding: 12px 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .interpretation-table td {
            padding: 14px 15px;
            background: rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        
        .interpretation-table tr td:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .interpretation-table tr td:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        .interpretation-table tbody tr:hover td {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .status-badge.critical {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }
        
        .status-badge.warning {
            background: rgba(254, 202, 87, 0.15);
            color: var(--accent-yellow);
        }
        
        .status-badge.good {
            background: rgba(46, 213, 115, 0.15);
            color: var(--accent-green);
        }
        
        .status-badge.info {
            background: rgba(79, 172, 254, 0.15);
            color: var(--accent-blue);
        }
        
        /* ============== GAP BREAKDOWN ============== */
        .gap-summary-header {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .gap-summary {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px 40px;
            text-align: center;
        }
        
        .gap-summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .gap-summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-red);
        }
        
        .gap-summary-total {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--card-border);
        }
        
        .gap-summary-total span {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        /* Gap breakdown bars */
        .gap-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .gap-bar-item {
            display: grid;
            grid-template-columns: 140px 1fr 100px;
            align-items: center;
            gap: 15px;
        }
        
        .gap-bar-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .gap-bar-track {
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .gap-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .gap-bar-fill.poverty { background: linear-gradient(90deg, #ff6b6b, #ff8e8e); }
        .gap-bar-fill.sped { background: linear-gradient(90deg, #feca57, #ffdd7f); }
        .gap-bar-fill.lea { background: linear-gradient(90deg, #a55eea, #c77dff); }
        .gap-bar-fill.msoc { background: linear-gradient(90deg, #4facfe, #7fc4ff); }
        .gap-bar-fill.region { background: linear-gradient(90deg, #2ed573, #7bed9f); }
        .gap-bar-fill.ell { background: linear-gradient(90deg, #ff9f43, #ffbe76); }
        
        .gap-bar-value {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
            color: var(--accent-red);
        }
        
        /* Gap Table Styles */
        .gap-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .gap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 0.85rem;
        }
        
        .gap-table th {
            text-align: left;
            padding: 12px 15px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .gap-table th:nth-child(2),
        .gap-table th:nth-child(3),
        .gap-table th:nth-child(4) {
            text-align: right;
        }
        
        .gap-table th:nth-child(5) {
            text-align: left;
            width: 280px;
        }
        
        .gap-table td {
            padding: 14px 15px;
            background: rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        
        .gap-table tr td:first-child {
            border-radius: 8px 0 0 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .gap-table tr td:last-child {
            border-radius: 0 8px 8px 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .gap-table tr td:nth-child(2),
        .gap-table tr td:nth-child(3),
        .gap-table tr td:nth-child(4) {
            text-align: right;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        .gap-table tbody tr:hover td {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .gap-table .current { color: var(--accent-yellow); }
        .gap-table .need { color: var(--accent-blue); }
        .gap-table .gap-positive { color: var(--accent-green); }
        .gap-table .gap-negative { color: var(--accent-red); font-weight: 600; }
        
        .gap-table .category-bar {
            display: inline-block;
            width: 4px;
            height: 20px;
            border-radius: 2px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .gap-table .bar-poverty { background: #ff6b6b; }
        .gap-table .bar-sped { background: #feca57; }
        .gap-table .bar-ell { background: #ff9f43; }
        .gap-table .bar-region { background: #2ed573; }
        .gap-table .bar-lea { background: #a55eea; }
        .gap-table .bar-msoc { background: #4facfe; }
        
        /* ============== GAP + REFORM COMBINED LAYOUT ============== */
        .gap-summary-header {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .gap-summary-header .gap-summary {
            flex: 1;
        }
        
        .gap-reform-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gap-reform-row {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .gap-reform-row:hover {
            background: rgba(79, 172, 254, 0.1);
        }
        
        .gap-reform-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .gap-category {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 140px;
        }
        
        .gap-values {
            display: flex;
            gap: 25px;
        }
        
        .gap-col {
            text-align: right;
            min-width: 80px;
        }
        
        .gap-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .gap-value {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .gap-value.current { color: var(--accent-yellow); }
        .gap-value.need { color: var(--accent-blue); }
        .gap-value.gap-negative { color: var(--accent-red); }
        .gap-value.gap-positive { color: var(--accent-green); }
        
        .gap-reform-slider {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .slider-row .slider-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 100px;
        }
        
        .slider-row input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
        }
        
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        
        .slider-row input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        
        /* Category-specific slider colors */
        .gap-reform-row[data-category="poverty"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }
        .gap-reform-row[data-category="sped"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #feca57, #ffdd7f);
        }
        .gap-reform-row[data-category="ell"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #ff9f43, #ffbe76);
        }
        .gap-reform-row[data-category="region"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }
        .gap-reform-row[data-category="lea"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #a55eea, #c77dff);
        }
        .gap-reform-row[data-category="msoc"] input[type="range"]::-webkit-slider-thumb {
            background: linear-gradient(135deg, #4facfe, #7fc4ff);
        }
        
        /* Firefox slider thumb */
        .slider-row input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .gap-reform-row[data-category="poverty"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }
        .gap-reform-row[data-category="sped"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #feca57, #ffdd7f);
        }
        .gap-reform-row[data-category="ell"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #ff9f43, #ffbe76);
        }
        .gap-reform-row[data-category="region"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
        }
        .gap-reform-row[data-category="lea"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #a55eea, #c77dff);
        }
        .gap-reform-row[data-category="msoc"] input[type="range"]::-moz-range-thumb {
            background: linear-gradient(135deg, #4facfe, #7fc4ff);
        }
        
        .slider-row .slider-value {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--accent-cyan);
            min-width: 60px;
            text-align: right;
            font-weight: 600;
        }
        
        .slider-impact {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding-left: 112px;
        }
        
        .reform-presets {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--card-border);
        }
        
        .preset-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }
        
        @media (max-width: 900px) {
            .gap-summary-header {
                flex-direction: column;
            }
            
            .gap-reform-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .gap-reform-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .slider-impact {
                padding-left: 0;
            }
            
            .reform-presets {
                flex-wrap: wrap;
            }
        }
        
        /* ============== STATEWIDE COMPARISON CHART ============== */
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .chart-container svg {
            width: 100%;
            height: 100%;
        }
        
        .axis text { fill: var(--text-secondary); font-size: 11px; }
        .axis line, .axis path { stroke: rgba(255,255,255,0.2); }
        .grid line { stroke: rgba(255,255,255,0.05); }
        
        .dot {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dot:hover {
            filter: brightness(1.3);
        }
        
        .dot.highlighted {
            stroke: var(--accent-blue);
            stroke-width: 3;
        }
        
        /* ============== REFORM SIMULATOR ============== */
        .simulator-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .simulator-grid { grid-template-columns: 1fr; }
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .slider-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .slider-value {
            font-size: 0.9rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }
        
        .slider-impact {
            font-size: 0.75rem;
            color: var(--accent-green);
            margin-top: 5px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-yellow), #ff9f43);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(254, 202, 87, 0.4);
        }
        
        .reform-result {
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid rgba(46, 213, 115, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .reform-result-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .reform-result-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .reform-comparison {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .reform-item {
            text-align: center;
        }
        
        .reform-item .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .reform-item .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .reform-item .value.before { color: var(--accent-red); }
        .reform-item .value.after { color: var(--accent-green); }
        
        /* ============== TAB 2: PROBLEMS ============== */
        .problems-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .problems-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .problems-grid { grid-template-columns: 1fr; }
        }
        
        .problem-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .problem-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.2);
        }
        
        .problem-card.expanded {
            grid-column: span 3;
        }
        
        @media (max-width: 1200px) {
            .problem-card.expanded { grid-column: span 2; }
        }
        
        @media (max-width: 768px) {
            .problem-card.expanded { grid-column: span 1; }
        }
        
        .problem-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .problem-title {
            font-size: 1.1rem;
            color: var(--accent-red);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .problem-summary {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .problem-impact {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
        }
        
        .problem-impact-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 5px;
        }
        
        .problem-impact-value {
            color: var(--accent-red);
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .problem-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--card-border);
        }
        
        .problem-card.expanded .problem-details {
            display: block;
        }
        
        /* ============== TAB 3: COMPARE ============== */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .compare-container { grid-template-columns: 1fr; }
        }
        
        .compare-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .compare-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preset-btn:hover, .preset-btn.active {
            background: rgba(79, 172, 254, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .comparison-table th {
            text-align: left;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .comparison-table tr:hover {
            background: rgba(79, 172, 254, 0.05);
        }
        
        .diff-positive { color: var(--accent-red); }
        .diff-negative { color: var(--accent-green); }
        
        .ranking-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .ranking-card .rank-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .ranking-card .rank-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .ranking-card .rank-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .ranking-card .rank-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), #00f2fe);
            border-radius: 4px;
        }
        
        .ranking-card .rank-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        /* ============== TAB 4: SOLUTIONS ============== */
        .timeline-container {
            position: relative;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .timeline-line {
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            transform: translateY(-50%);
            border-radius: 2px;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
            padding: 0 5%;
        }
        
        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .timeline-item:hover .timeline-dot {
            transform: scale(1.2);
        }
        
        .timeline-item.active .timeline-dot {
            background: var(--accent-green);
            box-shadow: 0 0 20px rgba(46, 213, 115, 0.5);
        }
        
        .timeline-dot {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(79, 172, 254, 0.3);
            border: 3px solid var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .timeline-year {
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .timeline-session {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .year-detail {
            background: var(--card-bg);
            border: 1px solid rgba(46, 213, 115, 0.3);
            border-radius: 12px;
            padding: 25px;
        }
        
        .year-detail h3 {
            color: var(--accent-green);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .policy-card {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--accent-blue);
        }
        
        .policy-card.priority-high { border-left-color: var(--accent-red); }
        .policy-card.priority-medium { border-left-color: var(--accent-yellow); }
        .policy-card.priority-low { border-left-color: var(--accent-green); }
        
        .policy-card h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .policy-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .policy-card .cost {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--card-border);
            font-size: 0.85rem;
        }
        
        .policy-card .cost span {
            color: var(--accent-yellow);
            font-weight: 600;
        }
        
        /* ============== TAB 5: BRIEF ============== */
        .brief-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            color: #333;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .brief-header {
            text-align: center;
            border-bottom: 3px solid var(--accent-blue);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }
        
        .brief-header h1 {
            color: #1a1a2e;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .brief-header .subtitle {
            color: #666;
            font-size: 0.9rem;
        }
        
        .brief-section {
            margin-bottom: 25px;
        }
        
        .brief-section h2 {
            color: #1a1a2e;
            font-size: 1rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .brief-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .brief-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .brief-metric .label { color: #666; }
        .brief-metric .value { font-weight: 600; color: #333; }
        .brief-metric .value.gap { color: #ff6b6b; }
        
        .brief-challenges {
            list-style: none;
        }
        
        .brief-challenges li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .brief-challenges .challenge-title {
            font-weight: 600;
            color: #333;
        }
        
        .brief-challenges .challenge-impact {
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        .brief-actions {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .brief-actions li {
            padding: 5px 0;
            color: #333;
        }
        
        .brief-actions .benefit {
            color: #2ed573;
            font-weight: 600;
        }
        
        .brief-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
        }
        
        .brief-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .brief-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .brief-btn.print {
            background: var(--accent-blue);
            color: #fff;
        }
        
        .brief-btn.copy {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }
        
        .brief-btn:hover {
            transform: translateY(-2px);
        }
        
        /* ============== TAB 6: ABOUT ============== */
        .about-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .about-grid { grid-template-columns: 1fr; }
        }
        
        .about-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 25px;
        }
        
        .about-card h3 {
            color: var(--accent-blue);
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .about-card p, .about-card li {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .about-card ul {
            list-style: none;
            margin-top: 10px;
        }
        
        .about-card li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .about-card li:before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }
        
        .about-card code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--accent-yellow);
        }
        
        .lea-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .lea-table th, .lea-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }
        
        .lea-table th {
            background: rgba(0,0,0,0.2);
            color: var(--accent-blue);
        }
        
        /* ============== TOOLTIP ============== */
        .tooltip {
            position: absolute;
            background: rgba(10, 15, 30, 0.98);
            border: 1px solid rgba(79, 172, 254, 0.5);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-title {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 4px 0;
            font-size: 0.8rem;
        }
        
        .tooltip-row span:first-child { color: var(--text-secondary); }
        .tooltip-row .gap { color: var(--accent-red); font-weight: 600; }
        
        /* ============== PRINT STYLES ============== */
        @media print {
            body {
                background: #fff;
                color: #333;
            }
            
            .global-header, .featured-districts, .tab-nav, .brief-controls {
                display: none !important;
            }
            
            .tab-content {
                display: none !important;
            }
            
            .tab-content.brief-print {
                display: block !important;
            }
            
            .brief-container {
                box-shadow: none;
                max-width: 100%;
            }
        }
        
        /* ============== LOADING STATE ============== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(79, 172, 254, 0.2);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- GLOBAL HEADER -->
    <header class="global-header">
        <div class="header-left">
            <div class="logo">
                 WA K-12 Funding Gap Analysis
            </div>
        </div>
        <div class="header-controls">
            <div class="control-group">
                <label>County</label>
                <select id="countySelect" onchange="filterByCounty()">
                    <option value="">All Counties</option>
                </select>
            </div>
            <div class="control-group">
                <label>District</label>
                <select id="districtSelect" onchange="selectDistrict()">
                    <option value="">Select a District...</option>
                </select>
            </div>
            <div class="control-group">
                <label>Year</label>
                <select id="yearSelect" onchange="updateYear()">
                    <option value="2024-25" selected>2024-25</option>
                    <option value="2023-24">2023-24</option>
                    <option value="2022-23">2022-23</option>
                    <option value="2021-22">2021-22</option>
                    <option value="2020-21">2020-21</option>
                    <option value="2019-20">2019-20</option>
                </select>
            </div>
            <button class="btn-generate" onclick="generateBrief()">
                 Generate Brief
            </button>
        </div>
    </header>
    
    <!-- FEATURED DISTRICTS -->
    <div class="featured-districts">
        <span class="featured-label"> Quick Access:</span>
        <button class="featured-btn" onclick="selectFeatured('Bellevue School District')">Bellevue SD</button>
        <button class="featured-btn" onclick="selectFeatured('Yakima School District')">Yakima SD</button>
        <button class="featured-btn" onclick="selectFeatured('Seattle Public Schools')">Seattle PS</button>
        <button class="featured-btn" onclick="selectFeatured('Spokane Public Schools')">Spokane PS</button>
    </div>
    
    <!-- TAB NAVIGATION -->
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="showTab('families', this)"> For Families</button>
        <button class="tab-btn" onclick="showTab('mydistrict', this)"> My District</button>
        <button class="tab-btn problems" onclick="showTab('problems', this)"> The 6 Problems</button>
        <button class="tab-btn" onclick="showTab('compare', this)"> Compare</button>
        <button class="tab-btn solutions" onclick="showTab('solutions', this)"> Solutions</button>
        <button class="tab-btn" onclick="showTab('brief', this)"> 1-Page Brief</button>
        <button class="tab-btn" onclick="showTab('about', this)"> About</button>
    </nav>
    
    <!-- TAB 0: FOR FAMILIES (Easy Guide) -->
    <div id="tab-families" class="tab-content active">
        <div class="families-container">
            <div class="families-header">
                <h1> Understanding School Funding</h1>
                <p class="families-subtitle">A simple guide for parents and students</p>
            </div>
            
            <!-- Section 1: The Basics -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon"></div>
                    <h2>Where Does School Money Come From?</h2>
                    <div class="families-content">
                        <div class="money-sources">
                            <div class="source-item">
                                <div class="source-icon"></div>
                                <div class="source-text">
                                    <strong>State Government</strong>
                                    <p>About 70% of school money comes from the state</p>
                                </div>
                            </div>
                            <div class="source-item">
                                <div class="source-icon"></div>
                                <div class="source-text">
                                    <strong>Local Property Taxes</strong>
                                    <p>Your community votes to add extra money through "levies"</p>
                                </div>
                            </div>
                            <div class="source-item">
                                <div class="source-icon"></div>
                                <div class="source-text">
                                    <strong>Federal Government</strong>
                                    <p>A small amount for special programs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: The Problem -->
            <div class="families-section">
                <div class="families-card problem-card-families">
                    <div class="families-icon"></div>
                    <h2>Why Don't Schools Have Enough Money?</h2>
                    <div class="families-content">
                        <p class="simple-text">Washington State has some big problems with how it gives money to schools:</p>
                        
                        <div class="problem-list">
                            <div class="problem-item-simple">
                                <div class="problem-number">1</div>
                                <div class="problem-explain">
                                    <strong>No Extra Help for Poor Families</strong>
                                    <p>Kids from low-income families need extra support. Almost every other state gives extra money for this. <span class="highlight-red">Washington gives $0.</span></p>
                                </div>
                            </div>
                            
                            <div class="problem-item-simple">
                                <div class="problem-number">2</div>
                                <div class="problem-explain">
                                    <strong>Special Education Cap</strong>
                                    <p>The state only pays for special education up to 15.5% of students. If your school has more, <span class="highlight-red">the extra kids get no state funding.</span></p>
                                </div>
                            </div>
                            
                            <div class="problem-item-simple">
                                <div class="problem-number">3</div>
                                <div class="problem-explain">
                                    <strong>Not Enough for English Learners</strong>
                                    <p>Teaching English costs about $2,500 per student. <span class="highlight-red">The state only gives $1,200.</span></p>
                                </div>
                            </div>
                            
                            <div class="problem-item-simple">
                                <div class="problem-number">4</div>
                                <div class="problem-explain">
                                    <strong>Operating Costs Frozen Since 2018</strong>
                                    <p>Money for daily school operations hasn't increased since 2018. <span class="highlight-red">Everything costs more now, but schools get the same $1,533/student.</span></p>
                                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Electricity</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Heating & Gas</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Water</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Insurance</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Textbooks</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Technology</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Cleaning</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Repairs</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Bus Fuel</span>
                                        <span style="background: rgba(79,172,254,0.2); padding: 6px 12px; border-radius: 15px; font-size: 0.85rem;"> Office Supplies</span>
                                    </div>
                                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--accent-yellow);"> Inflation since 2018: +29%  Schools should get $1,980 but still receive $1,533</p>
                                </div>
                            </div>
                            
                            <div class="problem-item-simple">
                                <div class="problem-number">5</div>
                                <div class="problem-explain">
                                    <strong>Unfair Local Levy Rules</strong>
                                    <p>Local levies are supposed to help, but the rules hurt both rich and poor districts:</p>
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: var(--accent-blue);"> Wealthy Districts (like Bellevue):</strong>
                                            <p style="margin-top: 4px;">Voters approved $4,280/student, but the <span class="highlight-red">"Levy Cap" only allows $2,500</span>. They lose $1,780 per student!</p>
                                        </div>
                                        <div>
                                            <strong style="color: var(--accent-yellow);"> Poor Districts (like Yakima):</strong>
                                            <p style="margin-top: 4px;">Low property values mean they can only raise $1,000/student even at maximum tax rate. <span class="highlight-red">State help (LEA) doesn't fill the gap.</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 3: Real Impact -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon"></div>
                    <h2>How Does This Affect Your Child?</h2>
                    <div class="families-content">
                        <div class="impact-grid">
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Bigger Classes</strong>
                                    <p>Fewer teachers means more students per class</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Fewer Programs</strong>
                                    <p>Schools cut art, music, sports, and after-school activities</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Old Buildings</strong>
                                    <p>No money to fix or update school facilities</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Less Technology</strong>
                                    <p>Older computers and fewer learning tools</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Less Help</strong>
                                    <p>Fewer counselors, nurses, and support staff</p>
                                </div>
                            </div>
                            <div class="impact-item">
                                <div class="impact-icon"></div>
                                <div class="impact-text">
                                    <strong>Old Materials</strong>
                                    <p>Outdated textbooks and learning materials</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 4: Your District -->
            <div class="families-section">
                <div class="families-card highlight-card">
                    <div class="families-icon"></div>
                    <h2>What About <span id="familiesDistrictName">Your District</span>?</h2>
                    <div class="families-content">
                        <div class="district-simple-stats" id="familiesDistrictStats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 5: What You Can Do -->
            <div class="families-section">
                <div class="families-card action-card">
                    <div class="families-icon"></div>
                    <h2>What Can You Do?</h2>
                    <div class="families-content">
                        <div class="action-list">
                            <a href="https://www.wastatepta.org/focus-areas/advocacy/" target="_blank" class="action-item action-link">
                                <div class="action-icon"></div>
                                <div class="action-text">
                                    <strong>Vote YES on School Levies</strong>
                                    <p>Local levies help your school get more money</p>
                                    <span class="link-hint"> WA State PTA Advocacy</span>
                                </div>
                            </a>
                            <a href="https://app.leg.wa.gov/districtfinder/" target="_blank" class="action-item action-link">
                                <div class="action-icon"></div>
                                <div class="action-text">
                                    <strong>Contact Your Legislators</strong>
                                    <p>Tell them schools need more state funding</p>
                                    <span class="link-hint"> Find Your WA Legislators</span>
                                </div>
                            </a>
                            <a href="https://www.wssda.org/about-us/calendar/" target="_blank" class="action-item action-link">
                                <div class="action-icon"></div>
                                <div class="action-text">
                                    <strong>Attend School Board Meetings</strong>
                                    <p>Your voice matters in local decisions</p>
                                    <span class="link-hint"> WSSDA Events Calendar</span>
                                </div>
                            </a>
                            <div class="action-item action-link" onclick="copyPageLink()" style="cursor: pointer;">
                                <div class="action-icon"></div>
                                <div class="action-text">
                                    <strong>Share This Information</strong>
                                    <p>Help other parents understand the problem</p>
                                    <span class="link-hint" id="shareHint"> Click to copy link</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 6: Key Terms -->
            <div class="families-section">
                <div class="families-card">
                    <div class="families-icon"></div>
                    <h2>Words to Know</h2>
                    <div class="families-content">
                        <div class="glossary">
                            <div class="glossary-item">
                                <strong>Levy</strong>
                                <p>Extra local taxes that voters approve to help schools</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Per-Pupil Funding</strong>
                                <p>How much money the school gets for each student</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Special Education (SpEd)</strong>
                                <p>Extra help for students with learning differences or disabilities</p>
                            </div>
                            <div class="glossary-item">
                                <strong>ELL (English Language Learner)</strong>
                                <p>Students who are learning English as a new language</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Low-Income / Free & Reduced Lunch</strong>
                                <p>Families who qualify for help with school meals based on income</p>
                            </div>
                            <div class="glossary-item">
                                <strong>Funding Gap</strong>
                                <p>The difference between what schools need and what they actually get</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- TAB 1: MY DISTRICT -->
    <div id="tab-mydistrict" class="tab-content">
        <div id="noDistrictMessage" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 4rem; margin-bottom: 20px;"></div>
            <h2 style="color: var(--accent-blue); margin-bottom: 10px;">Select a District to Begin</h2>
            <p>Choose a district from the dropdown above or use the quick access buttons.</p>
        </div>
        
        <div id="districtContent" style="display: none;">
            <!-- Section 1: District Overview -->
            <section class="section">
                <h2 class="section-title"> District Overview</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Populated by JS -->
                </div>
                
                <div class="interpretation-table" id="interpretationTable">
                    <div class="interpretation-title"> What These Numbers Mean</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 120px;">Metric</th>
                                <th style="width: 200px;">Value</th>
                                <th>Meaning</th>
                                <th style="width: 120px; text-align: right;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="interpretationBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Section 2: Gap Breakdown + Reform Simulator (Combined) -->
            <section class="section">
                <h2 class="section-title"> Funding Gap Breakdown & Reform Simulator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                    Adjust sliders to simulate policy reforms and see real-time impact on funding gaps.
                </p>
                
                <div class="gap-summary-header">
                    <div class="gap-summary">
                        <div class="gap-summary-label">Per-Pupil Funding Gap</div>
                        <div class="gap-summary-value" id="totalGapValue">-$0</div>
                        <div class="gap-summary-total">
                            Total Annual Shortfall: <span id="totalShortfall">$0</span>
                        </div>
                    </div>
                    <div class="gap-summary" style="background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(46, 213, 115, 0.05));">
                        <div class="gap-summary-label" style="color: var(--accent-green);">After Reforms</div>
                        <div class="gap-summary-value" id="newGapValue" style="color: var(--accent-green);">-$0</div>
                        <div class="gap-summary-total">
                            Reduction: <span id="reformReduction" style="color: var(--accent-green);">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="gap-reform-container">
                    <!-- Row 1: Low-Income -->
                    <div class="gap-reform-row" data-category="poverty">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-poverty"></span>
                                <span class="category-icon"></span> Low-Income
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="poverty-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="poverty-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="poverty-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">Poverty Weight</span>
                                <input type="range" id="povertyWeightSlider" min="0" max="35" value="0" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="povertyWeightValue">0%</span>
                            </div>
                            <div class="slider-impact" id="poverty-impact">WA currently provides $0 extra for low-income students</div>
                        </div>
                    </div>
                    
                    <!-- Row 2: SpEd -->
                    <div class="gap-reform-row" data-category="sped">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-sped"></span>
                                <span class="category-icon"></span> SpEd
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="sped-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="sped-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="sped-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">SpEd Cap</span>
                                <input type="range" id="spedCapSlider" min="155" max="250" value="155" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="spedCapValue">15.5%</span>
                            </div>
                            <div class="slider-impact" id="sped-impact">State caps funding at 15.5% SpEd rate</div>
                        </div>
                    </div>
                    
                    <!-- Row 3: ELL -->
                    <div class="gap-reform-row" data-category="ell">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-ell"></span>
                                <span class="category-icon"></span> ELL
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="ell-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="ell-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="ell-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">TBIP Funding</span>
                                <input type="range" id="ellFundingSlider" min="1200" max="2500" value="1200" step="100" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="ellFundingValue">$1,200</span>
                            </div>
                            <div class="slider-impact" id="ell-impact">TBIP provides $1,200/ELL vs $2,500 actual cost</div>
                        </div>
                    </div>
                    
                    <!-- Row 4: Regionalization -->
                    <div class="gap-reform-row" data-category="region">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-region"></span>
                                <span class="category-icon"></span> Regionalization
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="region-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="region-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="region-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">CIS Floor</span>
                                <input type="range" id="regionMinSlider" min="100" max="104" value="100" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="regionMinValue">1.00</span>
                            </div>
                            <div class="slider-impact" id="region-impact">Current CIS ranges from 1.00 to 1.04</div>
                        </div>
                    </div>
                    
                    <!-- Row 5: Local Levy -->
                    <div class="gap-reform-row" data-category="lea">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-lea"></span>
                                <span class="category-icon"></span> Local Levy
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="lea-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="lea-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="lea-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">Voter-Approved</span>
                                <input type="range" id="leaThresholdSlider" min="2021" max="5000" value="2021" step="50" disabled style="opacity: 0.6;">
                                <span class="slider-value" id="leaThresholdValue">$2,021</span>
                            </div>
                            <div class="slider-impact" id="lea-impact">Fixed at voter-approved amount</div>
                        </div>
                    </div>
                    
                    <!-- Row 6: MSOC -->
                    <div class="gap-reform-row" data-category="msoc">
                        <div class="gap-reform-info">
                            <div class="gap-category">
                                <span class="category-bar bar-msoc"></span>
                                <span class="category-icon"></span> MSOC
                            </div>
                            <div class="gap-values">
                                <div class="gap-col">
                                    <div class="gap-label">Current</div>
                                    <div class="gap-value current" id="msoc-current">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Need</div>
                                    <div class="gap-value need" id="msoc-need">$0</div>
                                </div>
                                <div class="gap-col">
                                    <div class="gap-label">Gap</div>
                                    <div class="gap-value gap-negative" id="msoc-gap">-$0</div>
                                </div>
                            </div>
                        </div>
                        <div class="gap-reform-slider">
                            <div class="slider-row">
                                <span class="slider-label">MSOC Amount</span>
                                <input type="range" id="msocSlider" min="1533" max="2200" value="1533" step="50" oninput="updateGapWithReforms()">
                                <span class="slider-value" id="msocValue">$1,533</span>
                            </div>
                            <div class="slider-impact" id="msoc-impact">Frozen since 2018, should be ~$1,980</div>
                        </div>
                    </div>
                </div>
                
                <div class="reform-presets">
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">Quick Presets:</span>
                    <button class="preset-btn" onclick="applyPreset('reset')"> Reset</button>
                    <button class="preset-btn" onclick="applyPreset('moderate')"> Moderate Reform</button>
                    <button class="preset-btn" onclick="applyPreset('aggressive')"> Full Equity</button>
                    <button class="preset-btn" onclick="applyPreset('district')"> District-Optimized</button>
                </div>
            </section>
            
            <!-- Section 3: Statewide Comparison -->
            <section class="section">
                <div class="section-header-row">
                    <h2 class="section-title"> Statewide Comparison</h2>
                    <div class="control-group">
                        <select id="chartXAxis" onchange="updateComparisonChart()">
                            <option value="lowIncome">Low-Income % (X-Axis)</option>
                            <option value="ell">ELL % (X-Axis)</option>
                            <option value="sped">SpEd % (X-Axis)</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" id="comparisonChart">
                    <svg id="scatterSvg"></svg>
                </div>
            </section>
        </div>
    </div>
    
    <!-- TAB 2: THE 6 PROBLEMS -->
    <div id="tab-problems" class="tab-content">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--accent-red); margin-bottom: 10px;"> 6 Structural Problems in WA's Funding Model</h2>
            <p style="color: var(--text-secondary);">Click each card to see detailed analysis and impact on <span id="problemDistrictName">your district</span></p>
        </div>
        
        <div class="problems-grid" id="problemsGrid">
            <!-- Problem 1: No Poverty Weight -->
            <div class="problem-card" onclick="toggleProblem(this, 1)">
                <div class="problem-icon"></div>
                <div class="problem-title">No Poverty Weight</div>
                <div class="problem-summary">
                    Washington is 1 of only 3 states without additional funding for low-income students.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Impact on Your District</div>
                    <div class="problem-impact-value" id="problem1Impact">$0 unfunded</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Low-income students require additional support services, smaller class sizes, and intervention programs. 
                        Without a poverty weight, high-poverty districts must fund these with local levies, creating systematic inequality.
                    </p>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong style="color: var(--accent-yellow);">If WA adopted a 20% poverty weight:</strong>
                        <div id="problem1Solution" style="color: var(--accent-green); font-size: 1.2rem; margin-top: 10px;">+$0 for your district</div>
                    </div>
                </div>
            </div>
            
            <!-- Problem 2: SpEd Cap -->
            <div class="problem-card" onclick="toggleProblem(this, 2)">
                <div class="problem-icon"></div>
                <div class="problem-title">SpEd 15.5% Cap</div>
                <div class="problem-summary">
                    State funding is capped at 15.5% regardless of actual special education population.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Impact on Your District</div>
                    <div class="problem-impact-value" id="problem2Impact">0% above cap</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Many districts serve SpEd populations well above 15.5%. Each student above the cap costs $25,000+ annually 
                        but receives no state funding, forcing districts to cut general education programs.
                    </p>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong style="color: var(--accent-yellow);">If cap raised to 17.5%:</strong>
                        <div id="problem2Solution" style="color: var(--accent-green); font-size: 1.2rem; margin-top: 10px;">+$0 for your district</div>
                    </div>
                </div>
            </div>
            
            <!-- Problem 3: MSOC Freeze -->
            <div class="problem-card" onclick="toggleProblem(this, 3)">
                <div class="problem-icon"></div>
                <div class="problem-title">MSOC Frozen Since 2018</div>
                <div class="problem-summary">
                    Materials, Supplies, Operating Costs haven't kept pace with inflation since McCleary.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Statewide Impact</div>
                    <div class="problem-impact-value">~$350M shortfall</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Insurance premiums have risen 100%+, utilities 50%+, but MSOC allocations remain at 2018 levels.
                        This silent erosion forces districts to cut classroom spending to pay fixed costs.
                    </p>
                </div>
            </div>
            
            <!-- Problem 4: Regionalization -->
            <div class="problem-card" onclick="toggleProblem(this, 4)">
                <div class="problem-icon"></div>
                <div class="problem-title">Regressive Regionalization</div>
                <div class="problem-summary">
                    Cost-of-living factors (CIS/CLS) don't reflect actual regional cost differences.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Your District's CIS Factor</div>
                    <div class="problem-impact-value" id="problem4Impact">1.00</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Districts with CIS below 1.04 receive less funding per staff position despite needing competitive 
                        salaries to attract teachers. This creates hiring disadvantages for suburban and rural districts.
                    </p>
                </div>
            </div>
            
            <!-- Problem 5: LEA Inequality -->
            <div class="problem-card" onclick="toggleProblem(this, 5)">
                <div class="problem-icon"></div>
                <div class="problem-title">LEA Inequality</div>
                <div class="problem-summary">
                    Property-poor districts can't raise equivalent local revenue even at maximum levy rates.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">LEA Status</div>
                    <div class="problem-impact-value" id="problem5Impact">Loading...</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Local Effort Assistance (LEA) attempts to equalize, but thresholds have lagged behind inflation.
                        HB 2049 increases the threshold to $2,227.84 in 2026, helping but not fully solving the gap.
                    </p>
                    <table class="lea-table">
                        <tr><th>Year</th><th>Threshold</th><th>Policy</th></tr>
                        <tr><td>2025</td><td>$2,021</td><td>Seattle CPI</td></tr>
                        <tr><td>2026</td><td>$2,227.84</td><td>HB 2049: IPD+$200</td></tr>
                        <tr><td>2027</td><td>$2,547.35</td><td>Projected</td></tr>
                    </table>
                </div>
            </div>
            
            <!-- Problem 6: Enrollment Decline -->
            <div class="problem-card" onclick="toggleProblem(this, 6)">
                <div class="problem-icon"></div>
                <div class="problem-title">Enrollment Decline Cliff</div>
                <div class="problem-summary">
                    No "hold harmless" provision - funding drops immediately with enrollment.
                </div>
                <div class="problem-impact">
                    <div class="problem-impact-label">Your Enrollment Change</div>
                    <div class="problem-impact-value" id="problem6Impact">0%</div>
                </div>
                <div class="problem-details">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Fixed costs (buildings, staff contracts) don't scale linearly with enrollment. 
                        A 5% enrollment decline doesn't mean 5% fewer teachers are needed, but funding drops exactly 5%.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAB 3: COMPARE -->
    <div id="tab-compare" class="tab-content">
        <section class="section">
            <h2 class="section-title"> District Comparison</h2>
            
            <div class="compare-selector">
                <div class="control-group">
                    <label>Compare To</label>
                    <select id="compareToSelect" onchange="updateComparison()">
                        <option value="state">State Average</option>
                        <option value="county">County Average</option>
                        <option value="district">Specific District</option>
                    </select>
                </div>
                <div class="control-group" id="compareDistrictGroup" style="display: none;">
                    <label>Select District</label>
                    <select id="compareDistrictSelect" onchange="updateComparison()"></select>
                </div>
                <div class="compare-presets">
                    <button class="preset-btn" onclick="comparePreset('size', this)">Similar Size</button>
                    <button class="preset-btn" onclick="comparePreset('demographics', this)">Similar Demographics</button>
                    <button class="preset-btn" onclick="comparePreset('county', this)">Same County</button>
                </div>
            </div>
        </section>
        
        <div class="compare-container">
            <section class="section">
                <h3 class="section-title">Side-by-Side Metrics</h3>
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th id="compareCol1">Your District</th>
                            <th id="compareCol2">State Average</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </section>
            
            <div class="rankings-sidebar">
                <div class="ranking-card">
                    <div class="rank-label">Funding Gap Ranking</div>
                    <div class="rank-value" id="gapRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="gapRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="gapRankDesc">Select a district</div>
                </div>
                
                <div class="ranking-card">
                    <div class="rank-label">Low-Income % Ranking</div>
                    <div class="rank-value" id="povertyRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="povertyRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="povertyRankDesc">Select a district</div>
                </div>
                
                <div class="ranking-card">
                    <div class="rank-label">SpEd % Ranking</div>
                    <div class="rank-value" id="spedRank">#-- of 295</div>
                    <div class="rank-bar"><div class="rank-fill" id="spedRankFill" style="width: 0%"></div></div>
                    <div class="rank-desc" id="spedRankDesc">Select a district</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAB 4: SOLUTIONS -->
    <div id="tab-solutions" class="tab-content">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: var(--accent-green); margin-bottom: 10px;"> 5-Year Reform Roadmap</h2>
            <p style="color: var(--text-secondary);">Click a year to see proposed policy changes</p>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-line"></div>
            <div class="timeline">
                <div class="timeline-item active" onclick="selectYear(2025, this)">
                    <div class="timeline-dot">Y1</div>
                    <div class="timeline-year">2025</div>
                    <div class="timeline-session">Long Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2026, this)">
                    <div class="timeline-dot">Y2</div>
                    <div class="timeline-year">2026</div>
                    <div class="timeline-session">Short Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2027, this)">
                    <div class="timeline-dot">Y3</div>
                    <div class="timeline-year">2027</div>
                    <div class="timeline-session">Long Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2028, this)">
                    <div class="timeline-dot">Y4</div>
                    <div class="timeline-year">2028</div>
                    <div class="timeline-session">Short Session</div>
                </div>
                <div class="timeline-item" onclick="selectYear(2029, this)">
                    <div class="timeline-dot">Y5</div>
                    <div class="timeline-year">2029</div>
                    <div class="timeline-session">Long Session</div>
                </div>
            </div>
        </div>
        
        <div class="year-detail" id="yearDetail">
            <h3> Year 1 (2025): Emergency Repairs</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Estimated Total Cost: <span style="color: var(--accent-yellow); font-weight: 600;">$1.2B</span></p>
            <div class="policy-grid" id="policyGrid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <section class="section" style="margin-top: 30px;">
            <h2 class="section-title"> Policy Simulator</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Adjust parameters to see the combined impact on your district</p>
            
            <div class="simulator-grid">
                <div class="sliders-container">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Poverty Weight</span>
                            <span class="slider-value" id="solPovertyValue">0%</span>
                        </div>
                        <input type="range" id="solPovertySlider" min="0" max="30" value="20" oninput="updateSolutionSimulator()">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">SpEd Cap Increase</span>
                            <span class="slider-value" id="solSpedValue">15.5%</span>
                        </div>
                        <input type="range" id="solSpedSlider" min="155" max="200" value="175" oninput="updateSolutionSimulator()">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">LEA Threshold</span>
                            <span class="slider-value" id="solLeaValue">$2,228</span>
                        </div>
                        <input type="range" id="solLeaSlider" min="2021" max="3500" value="2228" step="50" oninput="updateSolutionSimulator()">
                    </div>
                </div>
                
                <div class="reform-result">
                    <div class="reform-result-label">Total Benefit to Your District</div>
                    <div class="reform-result-value" id="solTotalBenefit">+$0/year</div>
                    <div class="reform-comparison">
                        <div class="reform-item">
                            <div class="label">Per Student</div>
                            <div class="value after" id="solPerStudent">+$0</div>
                        </div>
                        <div class="reform-item">
                            <div class="label">Statewide Cost</div>
                            <div class="value" style="color: var(--accent-yellow);" id="solStatewideCost">$0B</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- TAB 5: 1-PAGE BRIEF -->
    <div id="tab-brief" class="tab-content">
        <div class="brief-controls">
            <button class="brief-btn print" onclick="printBrief()"> Print Brief</button>
            <button class="brief-btn copy" onclick="copyBrief()"> Copy Text</button>
        </div>
        
        <div class="brief-container" id="briefContainer">
            <div class="brief-header">
                <h1 id="briefDistrictName">Select a District</h1>
                <div class="subtitle">K-12 Funding Gap Analysis | Fiscal Year <span id="briefYear">2024-25</span></div>
            </div>
            
            <div class="brief-section">
                <h2>Executive Summary</h2>
                <p id="briefSummary">Select a district to generate a funding analysis brief.</p>
            </div>
            
            <div class="brief-section">
                <h2>Key Metrics</h2>
                <div class="brief-metrics" id="briefMetrics">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="brief-section">
                <h2>Top 3 Funding Challenges</h2>
                <ol class="brief-challenges" id="briefChallenges">
                    <!-- Populated by JS -->
                </ol>
            </div>
            
            <div class="brief-section">
                <h2>Recommended Policy Actions</h2>
                <ul class="brief-actions" id="briefActions">
                    <!-- Populated by JS -->
                </ul>
            </div>
            
            <div class="brief-section">
                <h2>Contact</h2>
                <p style="color: #666;">
                    Superintendent: _______________________________<br>
                    Email: _______________________________<br>
                    Phone: _______________________________
                </p>
            </div>
            
            <div class="brief-footer">
                Generated by WA K-12 Funding Analysis Tool<br>
                Data Source: OSPI Prototypical School Funding Model<br>
                <span id="briefDate"></span>
            </div>
        </div>
    </div>
    
    <!-- TAB 6: ABOUT -->
    <div id="tab-about" class="tab-content">
        <div class="about-grid">
            <div class="about-card">
                <h3> Research Overview</h3>
                <p>
                    This dashboard was developed as part of a research project analyzing 
                    structural inequities in Washington State's K-12 education funding model.
                </p>
                <ul>
                    <li><strong>Research Question:</strong> How do the six structural flaws in Washington's prototypical funding model create systematic disadvantages for high-poverty and rural school districts?</li>
                    <li><strong>Researcher:</strong> William Park</li>
                    <li><strong>School:</strong> Interlake High School, Bellevue School District</li>
                    <li><strong>Submission:</strong> Regeneron Science Talent Search 2027</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3> Methodology</h3>
                <p><strong>Data Collection:</strong></p>
                <ul>
                    <li>Primary source: OSPI Prototypical School Funding Model (2019-2025)</li>
                    <li>Enrollment data: OSPI Report Card</li>
                    <li>Demographic data: OSPI Student Demographics</li>
                    <li>Cost of living indices: Bureau of Labor Statistics</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Analysis Framework:</strong></p>
                <ul>
                    <li>Funding gap = Adequate funding (McCleary-based) - Actual state allocation</li>
                    <li>Per-pupil calculations normalized by enrollment</li>
                    <li>Correlation analysis: Demographics vs Funding Gap</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3> LEA Threshold Values</h3>
                <p>Local Effort Assistance thresholds by year:</p>
                <table class="lea-table">
                    <tr><th>Year</th><th>Threshold</th><th>Policy Basis</th></tr>
                    <tr><td>2025</td><td>$2,021</td><td>Seattle CPI adjustment</td></tr>
                    <tr><td>2026</td><td>$2,227.84</td><td>HB 2049: IPD + $200</td></tr>
                    <tr><td>2027</td><td>$2,547.35</td><td>Projected</td></tr>
                    <tr><td>2028</td><td>$2,599.57</td><td>Projected</td></tr>
                    <tr><td>2029</td><td>$2,654.16</td><td>Projected</td></tr>
                    <tr><td>2030</td><td>$2,704.32</td><td>Projected</td></tr>
                </table>
            </div>
            
            <div class="about-card">
                <h3> Data Sources & Citations</h3>
                <ul>
                    <li><strong>Office of Superintendent of Public Instruction (OSPI)</strong> - Prototypical School Funding Model</li>
                    <li><strong>Washington State Legislature</strong> - HB 2049 (LEA threshold adjustments)</li>
                    <li><strong>McCleary v. State of Washington</strong> - Adequacy baseline</li>
                    <li><strong>Bureau of Labor Statistics</strong> - Seattle-Tacoma-Bellevue CPI</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3> Limitations</h3>
                <ul>
                    <li>Data represents state funding only; federal and local sources vary</li>
                    <li>"Adequate" funding based on McCleary estimates, not universal standard</li>
                    <li>Projections assume current policy framework continues</li>
                    <li>Individual district circumstances may vary significantly</li>
                </ul>
            </div>
            
            <div class="about-card">
                <h3> Open Source</h3>
                <p>
                    This tool is open source and available for replication and improvement.
                </p>
                <ul>
                    <li><strong>License:</strong> MIT</li>
                    <li>Contributions and feedback welcome</li>
                    <li>Built with HTML5, CSS3, and vanilla JavaScript</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- TOOLTIP -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-content"></div>
    </div>

<script>
// ============== DISTRICT DATA ==============
// Embedded district data (subset for demonstration - full data would include all 295+ districts)
const DISTRICTS = [
  {"d":"17001","n":"Auburn School District","c":"King","y":"2024-25","t":16458,"li":0.502,"el":0.131,"sp":0.162,"cis":1.04,"lea":"revenue","av":18500000000},
  {"d":"17001","n":"Auburn School District","c":"King","y":"2023-24","t":16721,"li":0.489,"el":0.125,"sp":0.158,"cis":1.04,"lea":"revenue","av":17800000000},
  {"d":"17405","n":"Bellevue School District","c":"King","y":"2024-25","t":18456,"li":0.142,"el":0.198,"sp":0.171,"cis":1.04,"lea":"revenue","av":95000000000},
  {"d":"17405","n":"Bellevue School District","c":"King","y":"2023-24","t":18723,"li":0.138,"el":0.192,"sp":0.168,"cis":1.04,"lea":"revenue","av":92000000000},
  {"d":"17001","n":"Federal Way Public Schools","c":"King","y":"2024-25","t":21845,"li":0.628,"el":0.195,"sp":0.165,"cis":1.04,"lea":"revenue","av":15200000000},
  {"d":"17210","n":"Federal Way Public Schools","c":"King","y":"2023-24","t":22156,"li":0.615,"el":0.188,"sp":0.162,"cis":1.04,"lea":"revenue","av":14800000000},
  {"d":"17001","n":"Kent School District","c":"King","y":"2024-25","t":24789,"li":0.558,"el":0.215,"sp":0.159,"cis":1.04,"lea":"revenue","av":22500000000},
  {"d":"17415","n":"Kent School District","c":"King","y":"2023-24","t":25123,"li":0.545,"el":0.208,"sp":0.156,"cis":1.04,"lea":"revenue","av":21800000000},
  {"d":"17001","n":"Lake Washington School District","c":"King","y":"2024-25","t":29856,"li":0.118,"el":0.145,"sp":0.148,"cis":1.04,"lea":"revenue","av":85000000000},
  {"d":"17414","n":"Lake Washington School District","c":"King","y":"2023-24","t":30125,"li":0.112,"el":0.138,"sp":0.145,"cis":1.04,"lea":"revenue","av":82000000000},
  {"d":"17001","n":"Seattle Public Schools","c":"King","y":"2024-25","t":49234,"li":0.328,"el":0.125,"sp":0.178,"cis":1.04,"lea":"revenue","av":285000000000},
  {"d":"17001","n":"Seattle Public Schools","c":"King","y":"2023-24","t":50125,"li":0.315,"el":0.118,"sp":0.175,"cis":1.04,"lea":"revenue","av":275000000000},
  {"d":"32081","n":"Spokane Public Schools","c":"Spokane","y":"2024-25","t":27845,"li":0.562,"el":0.085,"sp":0.175,"cis":1.02,"lea":"rate","av":18500000000},
  {"d":"32081","n":"Spokane Public Schools","c":"Spokane","y":"2023-24","t":28156,"li":0.548,"el":0.078,"sp":0.172,"cis":1.02,"lea":"rate","av":17800000000},
  {"d":"27403","n":"Tacoma Public Schools","c":"Pierce","y":"2024-25","t":26458,"li":0.598,"el":0.165,"sp":0.182,"cis":1.03,"lea":"rate","av":22000000000},
  {"d":"27403","n":"Tacoma Public Schools","c":"Pierce","y":"2023-24","t":27125,"li":0.585,"el":0.158,"sp":0.178,"cis":1.03,"lea":"rate","av":21200000000},
  {"d":"39007","n":"Yakima School District","c":"Yakima","y":"2024-25","t":15234,"li":0.795,"el":0.358,"sp":0.148,"cis":1.00,"lea":"rate","av":5800000000},
  {"d":"39007","n":"Yakima School District","c":"Yakima","y":"2023-24","t":15456,"li":0.782,"el":0.345,"sp":0.145,"cis":1.00,"lea":"rate","av":5600000000},
  {"d":"06114","n":"Vancouver Public Schools","c":"Clark","y":"2024-25","t":22156,"li":0.485,"el":0.125,"sp":0.168,"cis":1.03,"lea":"rate","av":19500000000},
  {"d":"06114","n":"Vancouver Public Schools","c":"Clark","y":"2023-24","t":22589,"li":0.472,"el":0.118,"sp":0.165,"cis":1.03,"lea":"rate","av":18800000000},
  {"d":"17408","n":"Renton School District","c":"King","y":"2024-25","t":15125,"li":0.512,"el":0.218,"sp":0.155,"cis":1.04,"lea":"revenue","av":28500000000},
  {"d":"17408","n":"Renton School District","c":"King","y":"2023-24","t":15356,"li":0.498,"el":0.205,"sp":0.152,"cis":1.04,"lea":"revenue","av":27200000000},
  {"d":"17410","n":"Northshore School District","c":"King","y":"2024-25","t":20845,"li":0.165,"el":0.125,"sp":0.152,"cis":1.04,"lea":"revenue","av":52000000000},
  {"d":"17410","n":"Northshore School District","c":"King","y":"2023-24","t":21125,"li":0.158,"el":0.118,"sp":0.148,"cis":1.04,"lea":"revenue","av":50000000000},
  {"d":"17411","n":"Issaquah School District","c":"King","y":"2024-25","t":21234,"li":0.098,"el":0.085,"sp":0.142,"cis":1.04,"lea":"revenue","av":72000000000},
  {"d":"17411","n":"Issaquah School District","c":"King","y":"2023-24","t":21589,"li":0.092,"el":0.078,"sp":0.138,"cis":1.04,"lea":"revenue","av":69000000000},
  {"d":"27401","n":"Puyallup School District","c":"Pierce","y":"2024-25","t":22458,"li":0.385,"el":0.095,"sp":0.158,"cis":1.03,"lea":"rate","av":28500000000},
  {"d":"27401","n":"Puyallup School District","c":"Pierce","y":"2023-24","t":22856,"li":0.372,"el":0.088,"sp":0.155,"cis":1.03,"lea":"rate","av":27500000000}
];

// State averages for comparison
const STATE_AVERAGES = {
    enrollment: 3500,
    lowIncome: 0.45,
    sped: 0.155,
    ell: 0.12,
    perPupilGap: 2718,
    leaRate: 1847,
    cis: 1.02
};

// LEA Thresholds
const LEA_THRESHOLDS = {
    '2025': 2021,
    '2026': 2227.84,
    '2027': 2547.35,
    '2028': 2599.57,
    '2029': 2654.16,
    '2030': 2704.32
};

// Policy reform data by year
const REFORM_POLICIES = {
    2025: {
        title: "Year 1 (2025): Emergency Repairs",
        cost: "$1.2B",
        policies: [
            { name: "SpEd Cap  17.5%", desc: "Raise special education funding cap to better reflect actual populations", cost: "$450M", priority: "high" },
            { name: "MSOC Inflation Catch-up", desc: "Restore MSOC to inflation-adjusted 2018 levels", cost: "$350M", priority: "high" },
            { name: "LEA Threshold Increase", desc: "Implement HB 2049 threshold adjustment", cost: "$200M", priority: "medium" },
            { name: "Hold Harmless (1-year)", desc: "Protect declining enrollment districts for one year", cost: "$200M", priority: "medium" }
        ]
    },
    2026: {
        title: "Year 2 (2026): Foundation Building",
        cost: "$600M",
        policies: [
            { name: "5% Poverty Weight Pilot", desc: "Begin phased poverty weight implementation", cost: "$400M", priority: "high" },
            { name: "Regionalization Floor 1.01", desc: "Set minimum CIS factor at 1.01", cost: "$200M", priority: "medium" }
        ]
    },
    2027: {
        title: "Year 3 (2027): Expansion",
        cost: "$1.5B",
        policies: [
            { name: "Poverty Weight  15%", desc: "Increase poverty weight to 15%", cost: "$800M", priority: "high" },
            { name: "SpEd Cap  18.5%", desc: "Further raise special education cap", cost: "$300M", priority: "high" },
            { name: "ELL Enhancement", desc: "Increase TBIP funding per student", cost: "$200M", priority: "medium" },
            { name: "Transportation Adequacy", desc: "Update transportation funding formula", cost: "$200M", priority: "low" }
        ]
    },
    2028: {
        title: "Year 4 (2028): Refinement",
        cost: "$400M",
        policies: [
            { name: "Poverty Weight  18%", desc: "Continue poverty weight phase-in", cost: "$300M", priority: "high" },
            { name: "Formula Review", desc: "Comprehensive formula adequacy study", cost: "$100M", priority: "medium" }
        ]
    },
    2029: {
        title: "Year 5 (2029): Full Implementation",
        cost: "$1.0B",
        policies: [
            { name: "Poverty Weight  20%", desc: "Full poverty weight implementation", cost: "$500M", priority: "high" },
            { name: "SpEd Uncapped", desc: "Remove SpEd cap entirely - fund actual populations", cost: "$300M", priority: "high" },
            { name: "Regionalization Reform", desc: "Update CIS/CLS to reflect actual costs", cost: "$200M", priority: "medium" }
        ]
    }
};

// Current state
let currentDistrict = null;
let currentYear = '2024-25';
let allDistrictsForYear = [];

// ============== INITIALIZATION ==============
document.addEventListener('DOMContentLoaded', function() {
    populateCountySelect();
    populateDistrictSelect();
    updateYear();
    
    // Set default district to Bellevue on page load
    setTimeout(() => {
        selectFeatured('Bellevue School District');
    }, 100);
});

function populateCountySelect() {
    const counties = [...new Set(DISTRICTS.map(d => d.c))].sort();
    const select = document.getElementById('countySelect');
    counties.forEach(county => {
        const option = document.createElement('option');
        option.value = county;
        option.textContent = county;
        select.appendChild(option);
    });
}

function populateDistrictSelect(county = '') {
    const select = document.getElementById('districtSelect');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Select a District...</option>';
    
    const year = document.getElementById('yearSelect').value;
    let districts = DISTRICTS.filter(d => d.y === year);
    
    if (county) {
        districts = districts.filter(d => d.c === county);
    }
    
    // Get unique districts by name
    const uniqueDistricts = [];
    const seen = new Set();
    districts.forEach(d => {
        if (!seen.has(d.n)) {
            seen.add(d.n);
            uniqueDistricts.push(d);
        }
    });
    
    uniqueDistricts.sort((a, b) => a.n.localeCompare(b.n));
    
    uniqueDistricts.forEach(d => {
        const option = document.createElement('option');
        option.value = d.n;
        option.textContent = d.n;
        select.appendChild(option);
    });
    
    // Also populate compare district select
    const compareSelect = document.getElementById('compareDistrictSelect');
    if (compareSelect) {
        compareSelect.innerHTML = '<option value="">Select...</option>';
        uniqueDistricts.forEach(d => {
            const option = document.createElement('option');
            option.value = d.n;
            option.textContent = d.n;
            compareSelect.appendChild(option);
        });
    }
    
    // Restore selection if still valid
    if (currentValue && uniqueDistricts.some(d => d.n === currentValue)) {
        select.value = currentValue;
    }
}

function filterByCounty() {
    const county = document.getElementById('countySelect').value;
    populateDistrictSelect(county);
}

function updateYear() {
    currentYear = document.getElementById('yearSelect').value;
    allDistrictsForYear = DISTRICTS.filter(d => d.y === currentYear);
    populateDistrictSelect(document.getElementById('countySelect').value);
    if (currentDistrict) {
        selectDistrict();
    }
}

function selectDistrict() {
    const districtName = document.getElementById('districtSelect').value;
    if (!districtName) {
        currentDistrict = null;
        document.getElementById('noDistrictMessage').style.display = 'block';
        document.getElementById('districtContent').style.display = 'none';
        return;
    }
    
    currentDistrict = DISTRICTS.find(d => d.n === districtName && d.y === currentYear);
    if (!currentDistrict) {
        // Try to find any year
        currentDistrict = DISTRICTS.find(d => d.n === districtName);
    }
    
    if (currentDistrict) {
        document.getElementById('noDistrictMessage').style.display = 'none';
        document.getElementById('districtContent').style.display = 'block';
        updateAllDisplays();
    }
}

function selectFeatured(districtName) {
    document.getElementById('countySelect').value = '';
    populateDistrictSelect();
    document.getElementById('districtSelect').value = districtName;
    selectDistrict();
}

// ============== LOCAL LEVY HELPER FUNCTIONS ==============
const VOTER_APPROVED_DATA = {
    'Bellevue School District': { taxRate: 0.75, approved: 79000000 },
    'Yakima School District': { taxRate: 2.50, approved: 21500000 },
    'Seattle Public Schools': { taxRate: 0.75, approved: 225000000 },
    'Spokane Public Schools': { taxRate: 2.50, approved: 95000000 },
    'Lake Washington School District': { taxRate: 1.03, approved: 94400000 },
    'Issaquah School District': { taxRate: 1.42, approved: 67000000 },
    'Tacoma School District': { taxRate: 2.50, approved: 58000000 },
    'Highline School District': { taxRate: 2.46, approved: 67988856 },
    'Kent School District': { taxRate: 1.72, approved: 79300000 },
    'Federal Way School District': { taxRate: 1.86, approved: 45000000 },
    'Auburn School District': { taxRate: 2.50, approved: 51841820 },
    'Renton School District': { taxRate: 1.23, approved: 43272122 },
    'Northshore School District': { taxRate: 1.40, approved: 67500000 },
    'Mercer Island School District': { taxRate: 1.00, approved: 12000000 },
};

function getLocalLevyValue(d, levy250) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const actualTaxRate = voterData ? voterData.taxRate : (d.lea === 'revenue' ? 0.75 : 2.50);
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const levyCap = 2500;
    const overCap = perStudentApproved ? perStudentApproved > levyCap : false;
    
    if (voterData) {
        return `$${actualTaxRate.toFixed(2)}/1000 <span style="color: ${overCap ? 'var(--accent-red)' : 'var(--accent-green)'};">(${overCap ? 'Levy Cap Hit' : 'Under Cap'})</span>`;
    } else {
        return `$${actualTaxRate.toFixed(2)}/1000 <span style="color: var(--accent-yellow);">(Est.)</span>`;
    }
}

function getLocalLevyMeaning(d, levy250) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const actualTaxRate = voterData ? voterData.taxRate : (d.lea === 'revenue' ? 0.75 : 2.50);
    const voterApproved = voterData ? voterData.approved : null;
    const perStudentApproved = voterApproved ? Math.round(voterApproved / d.t) : null;
    const levyCap = 2500;
    const overCap = perStudentApproved ? perStudentApproved > levyCap : false;
    const lossPerStudent = overCap ? perStudentApproved - levyCap : 0;
    const totalLoss = lossPerStudent * d.t;
    
    if (overCap) {
        return `<strong style="color: var(--accent-blue);">Voter-approved: $${perStudentApproved.toLocaleString()}/student</strong> but <span style="color: var(--accent-yellow);"><strong>Levy Cap = $${levyCap.toLocaleString()}</strong></span>. Using only <strong>$${actualTaxRate.toFixed(2)}/1000</strong> rate. <span style="color: var(--accent-red);"><strong>Cannot collect $${totalLoss.toLocaleString()}</strong> (${Math.round(totalLoss/voterApproved*100)}% of approved)</span>`;
    } else if (d.lea === 'rate') {
        return `<strong style="color: var(--accent-red);">Already at max rate ($2.50/1000)</strong> but only generates <strong>$${Math.round(levy250).toLocaleString()}/student</strong>. Below $2,500 target  state provides <strong style="color: var(--accent-blue);">$${Math.round(Math.max(0, 2500 - levy250)).toLocaleString()} LEA</strong>.`;
    } else {
        return `Voter-approved levy within cap limits. Generates <strong>$${Math.round(levy250).toLocaleString()}/student</strong>.`;
    }
}

function getLocalLevyStatus(d) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const overCap = perStudentApproved ? perStudentApproved > 2500 : false;
    
    if (overCap) return 'Over Cap';
    if (d.lea === 'rate') return 'Needs LEA';
    return 'Under Cap';
}

function getLocalLevyStatusType(d) {
    const voterData = VOTER_APPROVED_DATA[d.n] || null;
    const perStudentApproved = voterData ? Math.round(voterData.approved / d.t) : null;
    const overCap = perStudentApproved ? perStudentApproved > 2500 : false;
    
    if (overCap) return 'critical';
    if (d.lea === 'rate') return 'warning';
    return 'good';
}

// ============== TAB NAVIGATION ==============
function showTab(tabId, btnElement) {
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (btnElement) {
        btnElement.classList.add('active');
    }
    
    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    
    // Special updates for certain tabs
    if (tabId === 'mydistrict') {
        // Re-render chart after tab becomes visible (needs slight delay for DOM)
        setTimeout(() => {
            updateComparisonChart();
        }, 50);
    } else if (tabId === 'problems') {
        updateProblemsTab();
    } else if (tabId === 'compare') {
        updateComparison();
    } else if (tabId === 'solutions') {
        selectYear(2025);
    } else if (tabId === 'brief') {
        updateBrief();
    }
}

// ============== CALCULATIONS ==============
function calculateFundingGap(district) {
    if (!district) return { total: 0, components: {} };
    
    const baseFunding = 12500; // Base per-pupil funding
    
    // Poverty gap (no poverty weight in WA)
    const povertyGap = district.li > 0.4 ? (district.li - 0.4) * baseFunding * 0.35 : district.li * baseFunding * 0.15;
    
    // SpEd gap (15.5% cap)
    const spedGap = district.sp > 0.155 ? (district.sp - 0.155) * baseFunding * 2.5 : 0;
    
    // ELL gap
    const ellGap = district.el > 0.05 ? (district.el - 0.05) * baseFunding * 0.3 : 0;
    
    // Regionalization gap
    const regionGap = (1.04 - district.cis) * baseFunding * 0.45;
    
    // LEA gap
    const ppAV = district.av / district.t;
    const levy250 = ppAV * 0.0025;
    const leaGap = district.lea === 'rate' ? Math.max(0, 2784 - levy250) : 0;
    
    // MSOC (flat estimate)
    const msocGap = 450; // ~$450 per student due to inflation freeze
    
    const total = povertyGap + spedGap + ellGap + Math.max(0, regionGap) + leaGap + msocGap;
    
    return {
        total: Math.round(total),
        components: {
            poverty: Math.round(povertyGap),
            sped: Math.round(spedGap),
            ell: Math.round(ellGap),
            region: Math.round(Math.max(0, regionGap)),
            lea: Math.round(leaGap),
            msoc: Math.round(msocGap)
        }
    };
}

// ============== UPDATE DISPLAYS ==============
function updateAllDisplays() {
    if (!currentDistrict) return;
    
    updateMetricsGrid();
    updateInterpretationTable();
    updateGapBreakdown();
    updateComparisonChart();
    updateRankings();
    updateFamiliesTab();
}

function updateMetricsGrid() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    // Calculate some derived values
    const enrollmentTrend = d.t > STATE_AVERAGES.enrollment ? 'Large' : d.t > 1000 ? 'Medium' : 'Small';
    const regionGap = (1.04 - d.cis) * 100;
    const msocShortfall = gap.components.msoc;
    const totalGap = gap.total * d.t;
    
    const metrics = [
        {
            label: ' Total Funding Gap',
            value: '-$' + (totalGap >= 1000000 ? (totalGap / 1000000).toFixed(1) + 'M' : totalGap.toLocaleString()),
            subtitle: `${d.t.toLocaleString()} students  $${gap.total.toLocaleString()}`,
            status: 'red',
            statusClass: 'status-red highlight-card',
            tooltip: {
                title: 'Total Annual Funding Gap',
                text: `This district faces a <strong style="color: var(--accent-red);">$${totalGap.toLocaleString()}</strong> annual funding shortfall.<br><br>Calculated as:<br> Enrollment: ${d.t.toLocaleString()} students<br> Per-pupil gap: $${gap.total.toLocaleString()}<br><br>This gap directly impacts classroom resources, teacher retention, and student outcomes.`,
                warning: 'This amount represents funding the district SHOULD receive but DOES NOT under current state formulas.'
            }
        },
        {
            label: ' Enrollment',
            value: d.t.toLocaleString(),
            subtitle: `${d.c} County`,
            status: 'blue',
            statusClass: '',
            tooltip: {
                title: 'Total Student Enrollment',
                text: `<strong>${d.t.toLocaleString()}</strong> students enrolled in ${currentYear}.<br><br>District size affects economies of scale, administrative costs, and bargaining power for contracts.`,
                highlight: `State average: ${STATE_AVERAGES.enrollment.toLocaleString()} students`
            }
        },
        {
            label: ' Per-Pupil Gap',
            value: '-$' + gap.total.toLocaleString(),
            subtitle: `State avg: -$${STATE_AVERAGES.perPupilGap.toLocaleString()}`,
            status: gap.total > STATE_AVERAGES.perPupilGap ? 'red' : 'yellow',
            statusClass: gap.total > STATE_AVERAGES.perPupilGap ? 'status-red' : 'status-yellow',
            tooltip: {
                title: 'Per-Pupil Funding Gap',
                text: `The difference between <strong>adequate funding</strong> (McCleary baseline) and <strong>actual state allocation</strong>.<br><br>Total annual shortfall: <strong style="color: var(--accent-red);">$${totalGap.toLocaleString()}</strong>`,
                warning: gap.total > STATE_AVERAGES.perPupilGap ? 'Above state average gap - this district is more underfunded than typical.' : null
            }
        },
        {
            label: ' Low-Income %',
            value: (d.li * 100).toFixed(1) + '%',
            subtitle: `State avg: ${(STATE_AVERAGES.lowIncome * 100).toFixed(1)}%`,
            status: d.li > STATE_AVERAGES.lowIncome ? 'red' : 'green',
            statusClass: d.li > STATE_AVERAGES.lowIncome ? 'status-red' : 'status-green',
            tooltip: {
                title: 'Free/Reduced Lunch Eligible',
                text: `<strong>${(d.li * 100).toFixed(1)}%</strong> of students qualify for free or reduced-price lunch.<br><br>Washington is <strong>1 of only 3 states</strong> that provides NO additional funding for low-income students (no "poverty weight").`,
                warning: d.li > 0.5 ? 'High-poverty district receiving no additional state support for student needs.' : null
            }
        },
        {
            label: ' SpEd %',
            value: (d.sp * 100).toFixed(1) + '%',
            subtitle: d.sp > 0.155 ? `${((d.sp - 0.155) * 100).toFixed(1)}% over cap!` : 'Under 15.5% cap',
            status: d.sp > 0.155 ? 'red' : 'green',
            statusClass: d.sp > 0.155 ? 'status-red' : 'status-green',
            tooltip: {
                title: 'Special Education Population',
                text: `<strong>${(d.sp * 100).toFixed(1)}%</strong> of students receive special education services.<br><br>State funding is <strong>capped at 15.5%</strong>. Students above this cap cost ~$25,000/year but receive <strong>$0 state funding</strong>.`,
                warning: d.sp > 0.155 ? `${Math.round((d.sp - 0.155) * d.t)} students above cap = $${Math.round((d.sp - 0.155) * d.t * 25000).toLocaleString()} unfunded annually.` : null
            }
        },
        {
            label: ' ELL %',
            value: (d.el * 100).toFixed(1) + '%',
            subtitle: `State avg: ${(STATE_AVERAGES.ell * 100).toFixed(1)}%`,
            status: d.el > STATE_AVERAGES.ell * 1.5 ? 'yellow' : 'blue',
            statusClass: d.el > STATE_AVERAGES.ell * 1.5 ? 'status-yellow' : '',
            tooltip: {
                title: 'English Language Learners',
                text: `<strong>${(d.el * 100).toFixed(1)}%</strong> of students are English Language Learners.<br><br>TBIP (Transitional Bilingual Instruction Program) funding may not cover actual costs for districts with high ELL populations.`,
                highlight: d.el > 0.2 ? 'High ELL population requires additional instructional support.' : null
            }
        },
        {
            label: ' LEA Status',
            value: d.lea === 'rate' ? 'Rate-Capped' : 'Revenue-Capped',
            subtitle: d.lea === 'rate' ? 'Needs LEA support' : 'Self-sufficient',
            status: d.lea === 'rate' ? 'yellow' : 'green',
            statusClass: d.lea === 'rate' ? 'status-yellow' : 'status-green',
            tooltip: {
                title: 'Local Effort Assistance Status',
                text: d.lea === 'rate' 
                    ? `<strong>Rate-Capped (Low Wealth):</strong> Even at maximum levy rate (2.50/$1000), this district cannot generate sufficient local revenue.<br><br>Receives LEA state assistance to partially close the gap.`
                    : `<strong>Revenue-Capped (High Wealth):</strong> Property values are high enough to generate local revenue at lower levy rates.<br><br>Constrained by the $2,500/student levy cap, not property values.`,
                highlight: `2025 LEA threshold: $2,021  2026: $2,227.84 (HB 2049)`
            }
        },
        {
            label: ' Regionalization',
            value: d.cis.toFixed(2),
            subtitle: d.cis >= 1.04 ? 'At maximum' : `${regionGap.toFixed(1)}% below max`,
            status: d.cis >= 1.04 ? 'green' : d.cis >= 1.02 ? 'yellow' : 'red',
            statusClass: d.cis >= 1.04 ? 'status-green' : d.cis >= 1.02 ? 'status-yellow' : 'status-red',
            tooltip: {
                title: 'CIS (Comparable Insurance Salary) Factor',
                text: `Regional cost adjustment factor: <strong>${d.cis.toFixed(2)}</strong><br><br>Ranges from 1.00 to 1.04. Higher factors provide more funding per staff position to account for regional cost-of-living differences.<br><br>Maximum factor (1.04) applies to Seattle/King County area.`,
                warning: d.cis < 1.02 ? `This district receives ${regionGap.toFixed(1)}% less per staff position than high-cost regions - may struggle to compete for teachers.` : null
            }
        },
        {
            label: ' MSOC',
            value: '$1,533',
            subtitle: 'Per Student Funding',
            status: 'blue',
            statusClass: '',
            tooltip: {
                title: 'Materials, Supplies & Operating Costs',
                text: `MSOC allocations have been <strong>frozen at $1,533/student since 2018</strong> (post-McCleary).<br><br>Meanwhile, actual costs have risen dramatically:<br> Insurance: +100%<br> Utilities: +50%<br> Supplies: +35%<br><br>This creates a silent erosion of classroom spending.`,
                warning: `If adjusted for inflation, MSOC should be ~$1,980/student - a $${(447 * d.t).toLocaleString()} annual shortfall for this district.`
            }
        }
    ];
    
    const grid = document.getElementById('metricsGrid');
    grid.innerHTML = metrics.map(m => `
        <div class="metric-card ${m.statusClass}">
            <div class="metric-label">${m.label}<i class="info-icon">?</i></div>
            <div class="metric-value ${m.status}">${m.value}</div>
            <div class="metric-subtitle">${m.subtitle}</div>
            <div class="card-tooltip">
                <div class="tt-title">${m.tooltip.title}</div>
                <div class="tt-text">
                    ${m.tooltip.text}
                    ${m.tooltip.highlight ? `<span class="tt-highlight"><br><br>${m.tooltip.highlight}</span>` : ''}
                    ${m.tooltip.warning ? `<span class="tt-warning"> ${m.tooltip.warning}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function updateInterpretationTable() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    // Calculate derived values
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    const ellGapPerStudent = d.el > 0.05 ? 1300 : 0;
    
    // Find prior year enrollment for comparison
    const priorYearMap = {
        '2024-25': '2023-24',
        '2023-24': '2022-23',
        '2022-23': '2021-22',
        '2021-22': '2020-21',
        '2020-21': '2019-20'
    };
    const priorYear = priorYearMap[currentYear];
    const priorYearData = DISTRICTS.find(dist => dist.n === d.n && dist.y === priorYear);
    
    let enrollmentChange = 0;
    let enrollmentChangePercent = 0;
    let enrollmentChangeText = '';
    
    if (priorYearData) {
        enrollmentChange = d.t - priorYearData.t;
        enrollmentChangePercent = ((enrollmentChange / priorYearData.t) * 100).toFixed(1);
        const sign = enrollmentChange >= 0 ? '+' : '';
        enrollmentChangeText = `(${sign}${enrollmentChange.toLocaleString()}, ${sign}${enrollmentChangePercent}%)`;
    }
    
    // Calculate percentile rankings
    const sortedByPoverty = [...allDistrictsForYear].sort((a, b) => b.li - a.li);
    const povertyRank = sortedByPoverty.findIndex(x => x.n === d.n) + 1;
    const povertyPercentile = Math.round((1 - povertyRank / sortedByPoverty.length) * 100);
    
    const sortedByELL = [...allDistrictsForYear].sort((a, b) => b.el - a.el);
    const ellRank = sortedByELL.findIndex(x => x.n === d.n) + 1;
    const ellPercentile = Math.round((ellRank / sortedByELL.length) * 100);
    
    // Determine enrollment status
    let enrollmentStatus = 'Stable';
    let enrollmentStatusType = 'info';
    if (enrollmentChange > 0) {
        enrollmentStatus = 'Growing';
        enrollmentStatusType = 'good';
    } else if (enrollmentChange < -100 || enrollmentChangePercent < -2) {
        enrollmentStatus = 'Declining';
        enrollmentStatusType = 'critical';
    } else if (enrollmentChange < 0) {
        enrollmentStatus = 'Slight Decline';
        enrollmentStatusType = 'warning';
    }
    
    const rows = [
        {
            metric: 'Enrollment',
            value: `${d.t.toLocaleString()} <span style="color: ${enrollmentChange >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${enrollmentChangeText}</span>`,
            meaning: enrollmentChange >= 0 
                ? `Total students. Increased ${Math.abs(enrollmentChange).toLocaleString()} from prior year`
                : `Total students. Decreased ${Math.abs(enrollmentChange).toLocaleString()} from prior year. <strong style="color: var(--accent-red);">Funding drops immediately with enrollment</strong>`,
            status: enrollmentStatus,
            statusType: enrollmentStatusType
        },
        {
            metric: 'Low-Income',
            value: `${(d.li * 100).toFixed(1)}% <span style="color: var(--accent-yellow);">(Top ${povertyPercentile}%)</span>`,
            meaning: `Low-income student rate. Top ${povertyPercentile}% in state. <strong style="color: var(--accent-red);">No Poverty Weight  $0 extra funding</strong>`,
            status: d.li > 0.5 ? 'High' : d.li > 0.3 ? 'Moderate' : 'Low',
            statusType: d.li > 0.5 ? 'critical' : d.li > 0.3 ? 'warning' : 'good'
        },
        {
            metric: 'SpEd %',
            value: d.sp > 0.155 
                ? `${(d.sp * 100).toFixed(1)}% <span style="color: var(--accent-red);">(+${((d.sp - 0.155) * 100).toFixed(1)}% Over Cap)</span>`
                : `${(d.sp * 100).toFixed(1)}% <span style="color: var(--accent-green);">(Under Cap)</span>`,
            meaning: d.sp > 0.155 
                ? `Your rate: <strong>${(d.sp * 100).toFixed(1)}%</strong> vs State cap: <strong>15.5%</strong>. <span style="color: var(--accent-red);"><strong>${((d.sp - 0.155) * 100).toFixed(1)}% above cap</strong> = ${Math.round((d.sp - 0.155) * d.t)} students UNFUNDED (~$25K each)</span>`
                : `Your rate: <strong>${(d.sp * 100).toFixed(1)}%</strong> vs State cap: <strong>15.5%</strong>. <span style="color: var(--accent-green);">All SpEd students fully funded.</span>`,
            status: d.sp > 0.155 ? 'Over Cap' : 'Under Cap',
            statusType: d.sp > 0.155 ? 'critical' : 'good'
        },
        {
            metric: 'ELL %',
            value: `${(d.el * 100).toFixed(1)}% <span style="color: var(--accent-yellow);">(Top ${ellPercentile}%)</span>`,
            meaning: d.el > 0.1 
                ? `English Language Learners. Top ${ellPercentile}% in state. <strong style="color: var(--accent-yellow);">TBIP ~$1,200 vs actual cost ~$2,500  $1,300/ELL gap</strong>`
                : `English Language Learners. TBIP funding adequate for current population.`,
            status: d.el > 0.15 ? 'High' : d.el > 0.08 ? 'Moderate' : 'Low',
            statusType: d.el > 0.15 ? 'warning' : d.el > 0.08 ? 'info' : 'good'
        },
        {
            metric: 'Regionalization',
            value: `${d.cis.toFixed(3)} <span style="color: ${d.cis >= 1.04 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">(${d.cis >= 1.04 ? 'Highest' : d.cis >= 1.02 ? 'Mid-High' : 'Low'})</span>`,
            meaning: d.cis >= 1.04 
                ? `Teacher salary adjustment factor. <strong style="color: var(--accent-green);">Maximum factor</strong>`
                : `Teacher salary adjustment factor. <strong style="color: var(--accent-yellow);">${((1.04 - d.cis) * 100).toFixed(1)}% below maximum</strong> - competitive disadvantage.`,
            status: d.cis >= 1.04 ? 'Adequate' : d.cis >= 1.02 ? 'Mid-Range' : 'Disadvantaged',
            statusType: d.cis >= 1.04 ? 'good' : d.cis >= 1.02 ? 'warning' : 'critical'
        },
        {
            metric: 'Local Levy',
            value: getLocalLevyValue(d, levy250),
            meaning: getLocalLevyMeaning(d, levy250),
            status: getLocalLevyStatus(d),
            statusType: getLocalLevyStatusType(d)
        }
    ];
    
    const tbody = document.getElementById('interpretationBody');
    tbody.innerHTML = rows.map(r => `
        <tr>
            <td style="font-weight: 600; color: var(--text-primary); white-space: nowrap;">${r.metric}</td>
            <td style="color: var(--accent-yellow); white-space: nowrap;">${r.value}</td>
            <td style="color: #ccc; line-height: 1.6;">${r.meaning}</td>
            <td style="text-align: right;"><span class="status-badge ${r.statusType}">${r.statusType === 'good' ? '' : r.statusType === 'warning' ? '' : r.statusType === 'critical' ? '' : ''} ${r.status}</span></td>
        </tr>
    `).join('');
}

function updateGapBreakdown() {
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    const baseFunding = 12500;
    
    // Update total gap display
    document.getElementById('totalGapValue').textContent = '-$' + gap.total.toLocaleString();
    document.getElementById('totalShortfall').textContent = '$' + (gap.total * d.t).toLocaleString();
    
    // Calculate values for each category (Gap = Need - Current)
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    
    // Get poverty weight slider value for Need calculation
    const povertyWeightPercent = parseInt(document.getElementById('povertyWeightSlider').value) || 0;
    
    // Poverty: Current = $0, Need = based on slider %
    const povertyCurrent = 0;
    const povertyNeed = Math.round(baseFunding * (povertyWeightPercent / 100) * d.li);
    const povertyGap = povertyNeed - povertyCurrent;
    document.getElementById('poverty-current').textContent = '$' + povertyCurrent.toLocaleString();
    document.getElementById('poverty-need').textContent = '$' + povertyNeed.toLocaleString();
    document.getElementById('poverty-gap').textContent = povertyGap > 0 ? '-$' + povertyGap.toLocaleString() : '$0';
    document.getElementById('poverty-gap').className = 'gap-value ' + (povertyGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // SpEd: Current = funded up to 15.5%, Need = full actual rate
    const spedCurrent = Math.round(baseFunding * Math.min(d.sp, 0.155) * 2.5);
    const spedNeed = Math.round(baseFunding * d.sp * 2.5);
    const spedGap = spedNeed - spedCurrent;
    document.getElementById('sped-current').textContent = '$' + spedCurrent.toLocaleString();
    document.getElementById('sped-need').textContent = '$' + spedNeed.toLocaleString();
    document.getElementById('sped-gap').textContent = spedGap > 0 ? '-$' + spedGap.toLocaleString() : '$0';
    document.getElementById('sped-gap').className = 'gap-value ' + (spedGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // ELL: Current = TBIP $1,200, Need = actual $2,500
    const ellCurrent = Math.round(1200 * d.el);
    const ellNeed = Math.round(2500 * d.el);
    const ellGap = ellNeed - ellCurrent;
    document.getElementById('ell-current').textContent = '$' + ellCurrent.toLocaleString();
    document.getElementById('ell-need').textContent = '$' + ellNeed.toLocaleString();
    document.getElementById('ell-gap').textContent = ellGap > 0 ? '-$' + ellGap.toLocaleString() : '$0';
    document.getElementById('ell-gap').className = 'gap-value ' + (ellGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // Regionalization: Current = district CIS, Need = max 1.04
    const regionCurrent = Math.round(baseFunding * (d.cis - 1));
    const regionNeed = Math.round(baseFunding * 0.04);
    const regionGap = regionNeed - regionCurrent;
    document.getElementById('region-current').textContent = '$' + regionCurrent.toLocaleString();
    document.getElementById('region-need').textContent = '$' + regionNeed.toLocaleString();
    document.getElementById('region-gap').textContent = regionGap > 0 ? '-$' + regionGap.toLocaleString() : '$0';
    document.getElementById('region-gap').className = 'gap-value ' + (regionGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // Local Levy: Current = what district can collect, Need = $2,500 target
    const leaCurrent = d.lea === 'rate' ? Math.round(Math.min(levy250, 2500)) : 2500;
    const leaNeed = 2500;
    const leaGap = leaNeed - leaCurrent;
    document.getElementById('lea-current').textContent = '$' + leaCurrent.toLocaleString();
    document.getElementById('lea-need').textContent = '$' + leaNeed.toLocaleString();
    document.getElementById('lea-gap').textContent = leaGap > 0 ? '-$' + leaGap.toLocaleString() : '$0';
    document.getElementById('lea-gap').className = 'gap-value ' + (leaGap > 0 ? 'gap-negative' : 'gap-positive');
    
    // MSOC: Current = frozen $1,533, Need = inflation-adjusted $1,980
    const msocCurrent = 1533;
    const msocNeed = 1980;
    const msocGap = msocNeed - msocCurrent;
    document.getElementById('msoc-current').textContent = '$' + msocCurrent.toLocaleString();
    document.getElementById('msoc-need').textContent = '$' + msocNeed.toLocaleString();
    document.getElementById('msoc-gap').textContent = '-$' + msocGap.toLocaleString();
    document.getElementById('msoc-gap').className = 'gap-value gap-negative';
    
    // Set slider impacts (descriptions)
    document.getElementById('poverty-impact').textContent = `${(d.li*100).toFixed(1)}% FRL rate. WA provides $0 extra for low-income students.`;
    document.getElementById('sped-impact').textContent = d.sp > 0.155 
        ? `${(d.sp*100).toFixed(1)}% SpEd rate  ${((d.sp-0.155)*100).toFixed(1)}% above 15.5% cap`
        : `${(d.sp*100).toFixed(1)}% SpEd rate  within 15.5% cap`;
    document.getElementById('ell-impact').textContent = `${(d.el*100).toFixed(1)}% ELL. TBIP: $1,200/student vs $2,500 actual cost`;
    document.getElementById('region-impact').textContent = `CIS factor: ${d.cis.toFixed(3)}. ${d.cis < 1.04 ? 'Below max 1.040' : 'At maximum 1.040'}`;
    document.getElementById('lea-impact').textContent = d.lea === 'rate' 
        ? `Rate-capped: $${Math.round(levy250).toLocaleString()}/student at $2.50/1000 rate`
        : `Levy cap limits collection. Voter-approved exceeds cap.`;
    document.getElementById('msoc-impact').textContent = 'Frozen at $1,533 since 2018. Inflation-adjusted: $1,980';
    
    // Set district-specific default slider values
    setDistrictSliderDefaults(d);
    
    // Initialize new gap display
    document.getElementById('newGapValue').textContent = '-$' + gap.total.toLocaleString();
    document.getElementById('reformReduction').textContent = '0%';
}

function setDistrictSliderDefaults(d) {
    // Set slider defaults based on actual district needs
    
    // Poverty weight: 20% (national average)
    document.getElementById('povertyWeightSlider').value = 20;
    document.getElementById('povertyWeightValue').textContent = '20%';
    
    // SpEd cap: Set to district's actual SpEd rate
    const spedDefault = Math.round(d.sp * 1000); // 0.171  171
    document.getElementById('spedCapSlider').value = Math.max(155, Math.min(250, spedDefault));
    document.getElementById('spedCapValue').textContent = (d.sp * 100).toFixed(1) + '%';
    
    // ELL funding: $2,500 (actual cost per ELL student)
    document.getElementById('ellFundingSlider').value = 2500;
    document.getElementById('ellFundingValue').textContent = '$2,500';
    
    // Regionalization: Set to district's actual CIS factor
    const regionDefault = Math.round(d.cis * 100);
    document.getElementById('regionMinSlider').value = regionDefault;
    document.getElementById('regionMinValue').textContent = d.cis.toFixed(2);
    
    // LEA threshold: Set to district's voter-approved per-student amount
    const voterData = VOTER_APPROVED_DATA[d.n];
    let leaDefault = 2500; // Default to levy cap
    if (voterData) {
        const perStudentApproved = Math.round(voterData.approved / d.t);
        leaDefault = Math.min(5000, Math.max(2021, perStudentApproved));
    }
    document.getElementById('leaThresholdSlider').value = leaDefault;
    document.getElementById('leaThresholdValue').textContent = '$' + leaDefault.toLocaleString();
    
    // MSOC: $1,980 (inflation-adjusted value)
    document.getElementById('msocSlider').value = 1980;
    document.getElementById('msocValue').textContent = '$1,980';
    
    // Apply reforms with defaults
    updateGapWithReforms();
}

function updateGapWithReforms() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const baseFunding = 12500;
    
    // Get slider values
    const povertyWeight = parseInt(document.getElementById('povertyWeightSlider').value) / 100;
    const spedCap = parseInt(document.getElementById('spedCapSlider').value) / 1000;
    const ellFunding = parseInt(document.getElementById('ellFundingSlider').value);
    const regionMin = parseInt(document.getElementById('regionMinSlider').value) / 100;
    const leaThreshold = parseInt(document.getElementById('leaThresholdSlider').value);
    const msocAmount = parseInt(document.getElementById('msocSlider').value);
    
    // Update slider display values
    document.getElementById('povertyWeightValue').textContent = Math.round(povertyWeight * 100) + '%';
    document.getElementById('spedCapValue').textContent = (spedCap * 100).toFixed(1) + '%';
    document.getElementById('ellFundingValue').textContent = '$' + ellFunding.toLocaleString();
    document.getElementById('regionMinValue').textContent = regionMin.toFixed(2);
    document.getElementById('leaThresholdValue').textContent = '$' + leaThreshold.toLocaleString();
    document.getElementById('msocValue').textContent = '$' + msocAmount.toLocaleString();
    
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    
    // ===== POVERTY =====
    // Current = $0 (WA provides nothing), Need = slider % based
    const povertyCurrent = 0;
    const povertyNeed = Math.round(baseFunding * povertyWeight * d.li);
    const povertyGap = povertyNeed - povertyCurrent;
    document.getElementById('poverty-current').textContent = '$' + povertyCurrent.toLocaleString();
    document.getElementById('poverty-need').textContent = '$' + povertyNeed.toLocaleString();
    document.getElementById('poverty-gap').textContent = povertyGap > 0 ? '-$' + povertyGap.toLocaleString() : '$0';
    document.getElementById('poverty-gap').className = 'gap-value ' + (povertyGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('poverty-impact').innerHTML = `<span style="color: var(--accent-green);">$${baseFunding.toLocaleString()}  ${Math.round(povertyWeight*100)}%  ${(d.li*100).toFixed(1)}% FRL = <strong>$${povertyNeed.toLocaleString()}</strong></span>`;
    
    // ===== SPED =====
    // Current = funded at 15.5% cap, Need = funded at slider cap
    // Gap = (slider% - 15.5%)  baseFunding  2.5
    const spedCurrentRate = 0.155; // WA cap is always 15.5%
    const spedSliderRate = spedCap; // Slider value
    const spedCurrent = Math.round(baseFunding * spedCurrentRate * 2.5);
    const spedNeed = Math.round(baseFunding * spedSliderRate * 2.5);
    const spedGap = spedNeed - spedCurrent;
    document.getElementById('sped-current').textContent = '$' + spedCurrent.toLocaleString();
    document.getElementById('sped-need').textContent = '$' + spedNeed.toLocaleString();
    document.getElementById('sped-gap').textContent = spedGap > 0 ? '-$' + spedGap.toLocaleString() : '$0';
    document.getElementById('sped-gap').className = 'gap-value ' + (spedGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation: slider% - 15.5% cap
    const spedExtra = spedSliderRate - spedCurrentRate;
    document.getElementById('sped-impact').innerHTML = spedGap > 0
        ? `<span style="color: var(--accent-green);">$${baseFunding.toLocaleString()}  ${(spedExtra*100).toFixed(1)}%  2.5 = <strong>$${spedGap.toLocaleString()}</strong> (${(spedSliderRate*100).toFixed(1)}% slider - 15.5% cap)</span>`
        : `<span style="color: var(--accent-green);">Slider ${(spedSliderRate*100).toFixed(1)}% = Cap 15.5%  <strong>No gap</strong></span>`;
    
    // ===== ELL =====
    // Current = TBIP $1,200, Need = slider funding amount
    const ellCurrent = Math.round(1200 * d.el);
    const ellNeed = Math.round(ellFunding * d.el);
    const ellGap = ellNeed - ellCurrent;
    document.getElementById('ell-current').textContent = '$' + ellCurrent.toLocaleString();
    document.getElementById('ell-need').textContent = '$' + ellNeed.toLocaleString();
    document.getElementById('ell-gap').textContent = ellGap > 0 ? '-$' + ellGap.toLocaleString() : '$0';
    document.getElementById('ell-gap').className = 'gap-value ' + (ellGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('ell-impact').innerHTML = `<span style="color: var(--accent-green);">($${ellFunding.toLocaleString()} - $1,200)  ${(d.el*100).toFixed(1)}% ELL = <strong>$${ellGap.toLocaleString()}</strong></span>`;
    
    // ===== REGIONALIZATION =====
    // Current = $12,500  (CIS - 1.00), Need = $12,500  (slider - 1.00)
    const regionCurrent = Math.round(baseFunding * (d.cis - 1));
    const effectiveCIS = Math.max(d.cis, regionMin);
    const regionNeed = Math.round(baseFunding * (regionMin - 1));
    const regionGap = regionNeed - regionCurrent;
    document.getElementById('region-current').textContent = '$' + regionCurrent.toLocaleString();
    document.getElementById('region-need').textContent = '$' + regionNeed.toLocaleString();
    document.getElementById('region-gap').textContent = regionGap > 0 ? '-$' + regionGap.toLocaleString() : '$0';
    document.getElementById('region-gap').className = 'gap-value ' + (regionGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('region-impact').innerHTML = `<span style="color: var(--accent-green);">Current: $${baseFunding.toLocaleString()}  (${d.cis.toFixed(2)} - 1.00) = <strong>$${regionCurrent.toLocaleString()}</strong> | Need: $${baseFunding.toLocaleString()}  (${regionMin.toFixed(2)} - 1.00) = <strong>$${regionNeed.toLocaleString()}</strong></span>`;
    
    // ===== LOCAL LEVY =====
    // Revenue-capped (Bellevue): Current = $2,500 (levy cap limits), Need = slider (voter-approved)
    // Rate-capped (Yakima): Current = what district can collect at max rate, Need = slider threshold
    const leaCurrent = d.lea === 'revenue' ? 2500 : Math.round(Math.min(levy250, 2500));
    const leaNeed = leaThreshold; // Need = slider value (voter-approved per student)
    const leaGap = leaNeed - leaCurrent;
    document.getElementById('lea-current').textContent = '$' + leaCurrent.toLocaleString();
    document.getElementById('lea-need').textContent = '$' + leaNeed.toLocaleString();
    document.getElementById('lea-gap').textContent = leaGap > 0 ? '-$' + leaGap.toLocaleString() : '$0';
    document.getElementById('lea-gap').className = 'gap-value ' + (leaGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    const voterData = VOTER_APPROVED_DATA[d.n];
    if (d.lea === 'revenue') {
        // Revenue-capped: Levy cap blocks collection
        document.getElementById('lea-impact').innerHTML = `<span style="color: var(--accent-green);">Voter-approved $${leaNeed.toLocaleString()}/student - Levy Cap $2,500 = <strong>-$${leaGap.toLocaleString()}</strong> cannot collect</span>`;
    } else {
        // Rate-capped: Low property value limits collection
        document.getElementById('lea-impact').innerHTML = `<span style="color: var(--accent-green);">$${leaNeed.toLocaleString()} target - $${leaCurrent.toLocaleString()} collectible = <strong>$${leaGap.toLocaleString()}</strong> LEA needed</span>`;
    }
    
    // ===== MSOC =====
    // Current = frozen $1,533, Need = slider amount
    const msocCurrent = 1533;
    const msocNeed = msocAmount;
    const msocGap = msocNeed - msocCurrent;
    document.getElementById('msoc-current').textContent = '$' + msocCurrent.toLocaleString();
    document.getElementById('msoc-need').textContent = '$' + msocNeed.toLocaleString();
    document.getElementById('msoc-gap').textContent = msocGap > 0 ? '-$' + msocGap.toLocaleString() : '$0';
    document.getElementById('msoc-gap').className = 'gap-value ' + (msocGap > 0 ? 'gap-negative' : 'gap-positive');
    // Calculation explanation
    document.getElementById('msoc-impact').innerHTML = `<span style="color: var(--accent-green);">$${msocNeed.toLocaleString()} - $1,533 frozen = <strong>$${msocGap.toLocaleString()}</strong> per student</span>`;
    
    // Calculate totals
    const totalCurrentGap = povertyGap + spedGap + ellGap + regionGap + leaGap + msocGap;
    const originalTotal = calculateFundingGap(d).total;
    
    // Update total displays
    document.getElementById('newGapValue').textContent = totalCurrentGap > 0 ? '-$' + totalCurrentGap.toLocaleString() : '$0';
    
    // Calculate reduction from baseline (slider at minimum values)
    const baselinePovertyGap = 0; // At 0% weight
    const baselineSpedGap = Math.round(Math.max(0, d.sp - 0.155) * baseFunding * 2.5);
    const baselineEllGap = Math.round((2500 - 1200) * d.el);
    const baselineRegionGap = Math.round((1.04 - d.cis) * baseFunding);
    const baselineLeaGap = d.lea === 'rate' ? Math.max(0, Math.round(2500 - levy250)) : 0;
    const baselineMsocGap = 1980 - 1533;
    const baselineTotal = baselinePovertyGap + baselineSpedGap + baselineEllGap + Math.max(0, baselineRegionGap) + baselineLeaGap + baselineMsocGap;
    
    const reduction = baselineTotal > 0 
        ? Math.round((totalCurrentGap / baselineTotal) * 100)
        : 0;
    document.getElementById('reformReduction').textContent = (100 - reduction) + '% closed';
}

function updateGapDisplay(category, newGap, originalGap) {
    const elem = document.getElementById(category + '-gap');
    if (newGap < originalGap) {
        elem.innerHTML = newGap > 0 
            ? `-$${newGap.toLocaleString()} <span style="color: var(--accent-green); font-size: 0.8em;">($${(originalGap - newGap).toLocaleString()})</span>`
            : `<span style="color: var(--accent-green);">$0 </span>`;
        elem.className = 'gap-value ' + (newGap > 0 ? 'gap-negative' : 'gap-positive');
    } else {
        elem.textContent = newGap > 0 ? '-$' + newGap.toLocaleString() : '$0';
        elem.className = 'gap-value ' + (newGap > 0 ? 'gap-negative' : 'gap-positive');
    }
}

function applyPreset(preset) {
    const d = currentDistrict;
    if (!d) return;
    
    // LEA  (voter-approved) 
    const voterData = VOTER_APPROVED_DATA[d.n];
    let leaFixed = 2500;
    if (voterData) {
        leaFixed = Math.min(5000, Math.max(2021, Math.round(voterData.approved / d.t)));
    }
    
    switch(preset) {
        case 'reset':
            document.getElementById('povertyWeightSlider').value = 0;
            document.getElementById('spedCapSlider').value = 155;
            document.getElementById('ellFundingSlider').value = 1200;
            document.getElementById('regionMinSlider').value = 100;
            document.getElementById('leaThresholdSlider').value = leaFixed; // 
            document.getElementById('msocSlider').value = 1533;
            break;
            
        case 'moderate':
            document.getElementById('povertyWeightSlider').value = 15;
            document.getElementById('spedCapSlider').value = 175;
            document.getElementById('ellFundingSlider').value = 1800;
            document.getElementById('regionMinSlider').value = 102;
            document.getElementById('leaThresholdSlider').value = leaFixed; // 
            document.getElementById('msocSlider').value = 1750;
            break;
            
        case 'aggressive':
            document.getElementById('povertyWeightSlider').value = 30;
            document.getElementById('spedCapSlider').value = 250;
            document.getElementById('ellFundingSlider').value = 2500;
            document.getElementById('regionMinSlider').value = 104;
            document.getElementById('leaThresholdSlider').value = leaFixed; // 
            document.getElementById('msocSlider').value = 1980;
            break;
            
        case 'district':
            setDistrictSliderDefaults(d);
            return; // setDistrictSliderDefaults already calls updateGapWithReforms
    }
    
    updateGapWithReforms();
}

function updateComparisonChart() {
    if (!currentDistrict) return;
    if (!allDistrictsForYear || allDistrictsForYear.length === 0) return;
    
    const svg = document.getElementById('scatterSvg');
    const container = document.getElementById('comparisonChart');
    const width = container.clientWidth - 40;
    const height = 360;
    const margin = { top: 20, right: 30, bottom: 50, left: 70 };
    const plotWidth = width - margin.left - margin.right;
    const plotHeight = height - margin.top - margin.bottom;
    
    const xAxis = document.getElementById('chartXAxis').value;
    const xLabel = xAxis === 'lowIncome' ? 'Low-Income %' : xAxis === 'ell' ? 'ELL %' : 'SpEd %';
    
    // Calculate gaps for all districts
    const plotData = allDistrictsForYear.map(d => ({
        name: d.n,
        x: xAxis === 'lowIncome' ? d.li : xAxis === 'ell' ? d.el : d.sp,
        y: calculateFundingGap(d).total,
        enrollment: d.t,
        isSelected: d.n === currentDistrict.n
    }));
    
    // Calculate linear regression
    const n = plotData.length;
    const sumX = plotData.reduce((sum, d) => sum + d.x, 0);
    const sumY = plotData.reduce((sum, d) => sum + d.y, 0);
    const sumXY = plotData.reduce((sum, d) => sum + d.x * d.y, 0);
    const sumXX = plotData.reduce((sum, d) => sum + d.x * d.x, 0);
    const sumYY = plotData.reduce((sum, d) => sum + d.y * d.y, 0);
    
    const denominator = n * sumXX - sumX * sumX;
    const slope = denominator !== 0 ? (n * sumXY - sumX * sumY) / denominator : 0;
    const intercept = (sumY - slope * sumX) / n;
    
    // Calculate R
    const meanY = sumY / n;
    const ssTotal = plotData.reduce((sum, d) => sum + Math.pow(d.y - meanY, 2), 0);
    const ssResidual = plotData.reduce((sum, d) => sum + Math.pow(d.y - (slope * d.x + intercept), 2), 0);
    const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;
    
    // Set proper axis ranges with minimum values
    const xMax = Math.max(0.9, Math.max(...plotData.map(d => d.x)) * 1.1);
    const yMax = Math.max(5000, Math.max(...plotData.map(d => d.y)) * 1.1);
    
    const scaleX = x => margin.left + (x / xMax) * plotWidth;
    const scaleY = y => margin.top + plotHeight - (y / yMax) * plotHeight;
    const scaleR = e => Math.max(4, Math.min(20, Math.sqrt(e / 1000) * 3));
    
    // Trendline endpoints (clipped to plot area)
    const trendX1 = 0;
    const trendY1 = Math.max(0, Math.min(yMax, intercept));
    const trendX2 = xMax;
    const trendY2 = Math.max(0, Math.min(yMax, slope * xMax + intercept));
    
    let svgContent = `
        <defs>
            <linearGradient id="dotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#4facfe;stop-opacity:0.8"/>
                <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:0.6"/>
            </linearGradient>
            <clipPath id="plotArea">
                <rect x="${margin.left}" y="${margin.top}" width="${plotWidth}" height="${plotHeight}"/>
            </clipPath>
        </defs>
        
        <!-- Grid lines -->
        <g class="grid">
            ${[0, 0.25, 0.5, 0.75, 1].map(t => `
                <line x1="${margin.left}" y1="${scaleY(t * yMax)}" x2="${width - margin.right}" y2="${scaleY(t * yMax)}" stroke="rgba(255,255,255,0.05)"/>
            `).join('')}
        </g>
        
        <!-- Axes -->
        <g class="axis">
            <line x1="${margin.left}" y1="${margin.top + plotHeight}" x2="${width - margin.right}" y2="${margin.top + plotHeight}" stroke="rgba(255,255,255,0.3)"/>
            <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotHeight}" stroke="rgba(255,255,255,0.3)"/>
        </g>
        
        <!-- Trendline (clipped) -->
        <g clip-path="url(#plotArea)">
            <line x1="${scaleX(trendX1)}" y1="${scaleY(trendY1)}" 
                  x2="${scaleX(trendX2)}" y2="${scaleY(trendY2)}" 
                  stroke="#feca57" stroke-width="2" stroke-dasharray="8,4" opacity="0.8"/>
        </g>
        
        <!-- R label -->
        <rect x="${width - margin.right - 95}" y="${margin.top + 5}" width="90" height="45" rx="6" fill="rgba(0,0,0,0.6)" stroke="rgba(254,202,87,0.5)"/>
        <text x="${width - margin.right - 50}" y="${margin.top + 25}" text-anchor="middle" fill="#feca57" font-size="11" font-weight="600">R = ${rSquared.toFixed(3)}</text>
        <text x="${width - margin.right - 50}" y="${margin.top + 42}" text-anchor="middle" fill="#888" font-size="9">${rSquared > 0.7 ? 'Strong' : rSquared > 0.4 ? 'Moderate' : 'Weak'} correlation</text>
        
        <!-- Axis labels -->
        <text x="${width / 2}" y="${height - 10}" text-anchor="middle" fill="#888" font-size="12">${xLabel}</text>
        <text x="15" y="${height / 2}" text-anchor="middle" fill="#888" font-size="12" transform="rotate(-90, 15, ${height / 2})">Funding Gap ($/student)</text>
        
        <!-- X-axis ticks -->
        ${[0, 0.2, 0.4, 0.6, 0.8].map(v => `
            <text x="${scaleX(v)}" y="${margin.top + plotHeight + 20}" text-anchor="middle" fill="#888" font-size="10">${(v * 100).toFixed(0)}%</text>
        `).join('')}
        
        <!-- Y-axis ticks -->
        ${[0, 1000, 2000, 3000, 4000, 5000].filter(v => v <= yMax).map(v => `
            <text x="${margin.left - 10}" y="${scaleY(v) + 4}" text-anchor="end" fill="#888" font-size="10">$${v.toLocaleString()}</text>
        `).join('')}
    `;
    
    // Draw dots (non-selected first)
    plotData.filter(d => !d.isSelected).forEach(d => {
        svgContent += `
            <circle class="dot" cx="${scaleX(d.x)}" cy="${scaleY(d.y)}" r="${scaleR(d.enrollment)}" 
                    fill="url(#dotGradient)" opacity="0.6"
                    onmouseover="showTooltip(event, '${d.name.replace(/'/g, "\\'")}', ${(d.x * 100).toFixed(1)}, ${d.y}, ${d.enrollment})"
                    onmouseout="hideTooltip()"/>
        `;
    });
    
    // Draw selected district last (on top)
    const selected = plotData.find(d => d.isSelected);
    if (selected) {
        svgContent += `
            <circle class="dot highlighted" cx="${scaleX(selected.x)}" cy="${scaleY(selected.y)}" r="${scaleR(selected.enrollment) + 4}" 
                    fill="#ff6b6b" stroke="white" stroke-width="2"
                    onmouseover="showTooltip(event, '${selected.name.replace(/'/g, "\\'")}', ${(selected.x * 100).toFixed(1)}, ${selected.y}, ${selected.enrollment})"
                    onmouseout="hideTooltip()"/>
            <text x="${scaleX(selected.x)}" y="${scaleY(selected.y) - scaleR(selected.enrollment) - 10}" 
                  text-anchor="middle" fill="#ff6b6b" font-size="11" font-weight="600">${selected.name.split(' ')[0]}</text>
        `;
    }
    
    svg.innerHTML = svgContent;
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
}

function showTooltip(e, name, x, y, enrollment) {
    const tooltip = document.getElementById('tooltip');
    tooltip.innerHTML = `
        <div class="tooltip-title">${name}</div>
        <div class="tooltip-row"><span>Demographic:</span><span>${x}%</span></div>
        <div class="tooltip-row"><span>Funding Gap:</span><span class="gap">-$${y.toLocaleString()}</span></div>
        <div class="tooltip-row"><span>Enrollment:</span><span>${enrollment.toLocaleString()}</span></div>
    `;
    tooltip.style.left = (e.pageX + 15) + 'px';
    tooltip.style.top = (e.pageY - 10) + 'px';
    tooltip.classList.add('visible');
}

function hideTooltip() {
    document.getElementById('tooltip').classList.remove('visible');
}

// ============== FAMILIES TAB ==============
function copyPageLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        const hint = document.getElementById('shareHint');
        hint.textContent = ' Link copied!';
        hint.style.color = 'var(--accent-green)';
        setTimeout(() => {
            hint.textContent = ' Click to copy link';
            hint.style.color = '';
        }, 2000);
    }).catch(() => {
        alert('URL: ' + url);
    });
}

function updateFamiliesTab() {
    if (!currentDistrict) {
        document.getElementById('familiesDistrictName').textContent = 'Your District';
        document.getElementById('familiesDistrictStats').innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                <p style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 15px;">
                    <strong>Pick your school district above!</strong>
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    We'll show you exactly how much money your child's school is missing.
                </p>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="featured-btn" onclick="selectFeatured('Bellevue School District')" style="padding: 10px 20px; cursor: pointer;">Try Bellevue</button>
                    <button class="featured-btn" onclick="selectFeatured('Yakima School District')" style="padding: 10px 20px; cursor: pointer;">Try Yakima</button>
                    <button class="featured-btn" onclick="selectFeatured('Seattle Public Schools')" style="padding: 10px 20px; cursor: pointer;">Try Seattle</button>
                </div>
            </div>
        `;
        return;
    }
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    const totalGap = gap.total * d.t;
    
    document.getElementById('familiesDistrictName').textContent = d.n;
    
    // Calculate values
    const avgTeacherSalary = 85000;
    const potentialTeachers = Math.round(totalGap / avgTeacherSalary);
    const stateAvgGap = 2718;
    const stateAvgLI = 45.0;
    const stateAvgELL = 12.0;
    
    // LEA status text
    const leaStatus = d.lea === 'revenue' ? 'Revenue-Capped' : 'Rate-Capped';
    const leaSubtext = d.lea === 'revenue' ? 'Levy cap limits collection' : 'Needs LEA assistance';
    const leaColor = d.lea === 'revenue' ? 'var(--accent-green)' : 'var(--accent-yellow)';
    
    // SpEd status
    const spedOver = d.sp > 0.155;
    const spedOverAmount = spedOver ? ((d.sp - 0.155) * 100).toFixed(1) : 0;
    
    // Regionalization status
    const regionStatus = d.cis >= 1.04 ? 'At maximum' : d.cis >= 1.02 ? 'Above average' : 'Below average';
    
    document.getElementById('familiesDistrictStats').innerHTML = `
        <div class="families-metrics-grid">
            <!-- Row 1 -->
            <div class="families-metric-card highlight-red">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">Total Funding Gap</span>
                </div>
                <div class="metric-value" style="color: var(--accent-red);">-$${(totalGap / 1000000).toFixed(1)}M</div>
                <div class="metric-subtext">${d.t.toLocaleString()} students  $${gap.total.toLocaleString()}</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">Enrollment</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">${d.t.toLocaleString()}</div>
                <div class="metric-subtext">${d.c} County</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">Per-Student Gap</span>
                </div>
                <div class="metric-value" style="color: var(--accent-red);">-$${gap.total.toLocaleString()}</div>
                <div class="metric-subtext">State avg: -$${stateAvgGap.toLocaleString()}</div>
            </div>
            
            <!-- Row 2 -->
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">Low-Income %</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">${(d.li * 100).toFixed(1)}%</div>
                <div class="metric-subtext">State avg: ${stateAvgLI}%</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">SpEd %</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">${(d.sp * 100).toFixed(1)}%</div>
                <div class="metric-subtext">${spedOver ? spedOverAmount + '% over cap!' : 'Within 15.5% cap'}</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">ELL %</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">${(d.el * 100).toFixed(1)}%</div>
                <div class="metric-subtext">State avg: ${stateAvgELL}%</div>
            </div>
            
            <!-- Row 3 -->
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">LEA Status</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue); font-size: 1.4rem;">${leaStatus}</div>
                <div class="metric-subtext">${leaSubtext}</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">Regionalization</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">${d.cis.toFixed(2)}</div>
                <div class="metric-subtext">${regionStatus}</div>
            </div>
            
            <div class="families-metric-card">
                <div class="metric-header">
                    <span class="metric-icon"></span>
                    <span class="metric-title">MSOC</span>
                </div>
                <div class="metric-value" style="color: var(--accent-blue);">$1,533</div>
                <div class="metric-subtext">Frozen since 2018</div>
            </div>
        </div>
        
        <div style="margin-top: 25px; background: rgba(255,107,107,0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-red);">
            <p style="font-size: 1.1rem; line-height: 1.8; margin: 0;">
                <strong> What does this mean?</strong> Your district is missing <strong>$${gap.total.toLocaleString()}</strong> per student every year. 
                That's <strong>$${(totalGap / 1000000).toFixed(1)} million</strong> total  enough to hire <strong>${potentialTeachers} more teachers</strong>!
            </p>
        </div>
    `;
}

// ============== PROBLEMS TAB ==============
function updateProblemsTab() {
    if (!currentDistrict) {
        document.getElementById('problemDistrictName').textContent = 'your district';
        return;
    }
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    document.getElementById('problemDistrictName').textContent = d.n;
    
    // Problem 1: Poverty
    document.getElementById('problem1Impact').textContent = '$' + gap.components.poverty.toLocaleString() + ' unfunded';
    document.getElementById('problem1Solution').textContent = '+$' + Math.round(d.li * d.t * 12500 * 0.2).toLocaleString() + ' for your district';
    
    // Problem 2: SpEd
    if (d.sp > 0.155) {
        document.getElementById('problem2Impact').textContent = ((d.sp - 0.155) * 100).toFixed(1) + '% above cap';
    } else {
        document.getElementById('problem2Impact').textContent = 'Under cap ';
    }
    document.getElementById('problem2Solution').textContent = d.sp > 0.155 ? '+$' + Math.round((d.sp - 0.155) * d.t * 25000).toLocaleString() + ' for your district' : 'No additional impact';
    
    // Problem 4: Regionalization
    document.getElementById('problem4Impact').textContent = d.cis.toFixed(2);
    
    // Problem 5: LEA
    document.getElementById('problem5Impact').textContent = d.lea === 'rate' ? 'Rate-Capped (Disadvantaged)' : 'Revenue-Capped';
    
    // Problem 6: Enrollment change (estimated)
    document.getElementById('problem6Impact').textContent = '-3.2% (estimated)';
}

function toggleProblem(card, problemId) {
    const wasExpanded = card.classList.contains('expanded');
    
    // Close all
    document.querySelectorAll('.problem-card').forEach(c => c.classList.remove('expanded'));
    
    // Toggle clicked
    if (!wasExpanded) {
        card.classList.add('expanded');
    }
}

// ============== COMPARE TAB ==============
function updateComparison() {
    if (!currentDistrict) return;
    
    const compareType = document.getElementById('compareToSelect').value;
    const compareDistrictGroup = document.getElementById('compareDistrictGroup');
    
    if (compareType === 'district') {
        compareDistrictGroup.style.display = 'block';
    } else {
        compareDistrictGroup.style.display = 'none';
    }
    
    let compareData;
    let compareName;
    
    if (compareType === 'state') {
        compareName = 'State Average';
        compareData = {
            enrollment: STATE_AVERAGES.enrollment,
            li: STATE_AVERAGES.lowIncome,
            sp: STATE_AVERAGES.sped,
            el: STATE_AVERAGES.ell,
            cis: STATE_AVERAGES.cis,
            gap: STATE_AVERAGES.perPupilGap
        };
    } else if (compareType === 'county') {
        const countyDistricts = allDistrictsForYear.filter(d => d.c === currentDistrict.c);
        compareName = currentDistrict.c + ' County Avg';
        compareData = {
            enrollment: Math.round(countyDistricts.reduce((sum, d) => sum + d.t, 0) / countyDistricts.length),
            li: countyDistricts.reduce((sum, d) => sum + d.li, 0) / countyDistricts.length,
            sp: countyDistricts.reduce((sum, d) => sum + d.sp, 0) / countyDistricts.length,
            el: countyDistricts.reduce((sum, d) => sum + d.el, 0) / countyDistricts.length,
            cis: countyDistricts.reduce((sum, d) => sum + d.cis, 0) / countyDistricts.length,
            gap: Math.round(countyDistricts.reduce((sum, d) => sum + calculateFundingGap(d).total, 0) / countyDistricts.length)
        };
    } else {
        const compareDistrictName = document.getElementById('compareDistrictSelect').value;
        const compareDistrict = allDistrictsForYear.find(d => d.n === compareDistrictName);
        if (compareDistrict) {
            compareName = compareDistrict.n;
            compareData = {
                enrollment: compareDistrict.t,
                li: compareDistrict.li,
                sp: compareDistrict.sp,
                el: compareDistrict.el,
                cis: compareDistrict.cis,
                gap: calculateFundingGap(compareDistrict).total
            };
        } else {
            return;
        }
    }
    
    const d = currentDistrict;
    const myGap = calculateFundingGap(d);
    
    document.getElementById('compareCol1').textContent = d.n.split(' ').slice(0, 2).join(' ');
    document.getElementById('compareCol2').textContent = compareName;
    
    const rows = [
        { metric: 'Enrollment', mine: d.t, theirs: compareData.enrollment, format: 'number' },
        { metric: 'Per-Pupil Gap', mine: myGap.total, theirs: compareData.gap, format: 'currency', inverse: true },
        { metric: 'Low-Income %', mine: d.li, theirs: compareData.li, format: 'percent', inverse: true },
        { metric: 'SpEd %', mine: d.sp, theirs: compareData.sp, format: 'percent' },
        { metric: 'ELL %', mine: d.el, theirs: compareData.el, format: 'percent' },
        { metric: 'CIS Factor', mine: d.cis, theirs: compareData.cis, format: 'decimal' }
    ];
    
    document.getElementById('comparisonBody').innerHTML = rows.map(r => {
        let mineStr, theirsStr, diff, diffClass;
        
        if (r.format === 'number') {
            mineStr = r.mine.toLocaleString();
            theirsStr = r.theirs.toLocaleString();
            diff = r.mine - r.theirs;
            diffClass = '';
        } else if (r.format === 'currency') {
            mineStr = '-$' + r.mine.toLocaleString();
            theirsStr = '-$' + r.theirs.toLocaleString();
            diff = r.mine - r.theirs;
            diffClass = r.inverse ? (diff > 0 ? 'diff-positive' : 'diff-negative') : (diff > 0 ? 'diff-negative' : 'diff-positive');
        } else if (r.format === 'percent') {
            mineStr = (r.mine * 100).toFixed(1) + '%';
            theirsStr = (r.theirs * 100).toFixed(1) + '%';
            diff = (r.mine - r.theirs) * 100;
            diffClass = r.inverse ? (diff > 0 ? 'diff-positive' : 'diff-negative') : '';
        } else {
            mineStr = r.mine.toFixed(2);
            theirsStr = r.theirs.toFixed(2);
            diff = r.mine - r.theirs;
            diffClass = diff > 0 ? 'diff-negative' : '';
        }
        
        const diffStr = r.format === 'percent' ? (diff > 0 ? '+' : '') + diff.toFixed(1) + '%' :
                       r.format === 'currency' ? (diff > 0 ? '+' : '') + '$' + Math.abs(diff).toLocaleString() :
                       r.format === 'decimal' ? (diff > 0 ? '+' : '') + diff.toFixed(2) :
                       (diff > 0 ? '+' : '') + diff.toLocaleString();
        
        return `
            <tr>
                <td style="font-weight: 600;">${r.metric}</td>
                <td>${mineStr}</td>
                <td>${theirsStr}</td>
                <td class="${diffClass}">${diffStr}</td>
            </tr>
        `;
    }).join('');
}

function updateRankings() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const myGap = calculateFundingGap(d).total;
    
    // Sort all districts by gap (descending)
    const sortedByGap = [...allDistrictsForYear]
        .map(dist => ({ name: dist.n, gap: calculateFundingGap(dist).total }))
        .sort((a, b) => b.gap - a.gap);
    
    const gapRank = sortedByGap.findIndex(x => x.name === d.n) + 1;
    const gapPercentile = Math.round((gapRank / sortedByGap.length) * 100);
    
    document.getElementById('gapRank').textContent = `#${gapRank} of ${sortedByGap.length}`;
    document.getElementById('gapRankFill').style.width = gapPercentile + '%';
    document.getElementById('gapRankDesc').textContent = `Worse gap than ${100 - gapPercentile}% of districts`;
    
    // Poverty ranking
    const sortedByPoverty = [...allDistrictsForYear].sort((a, b) => b.li - a.li);
    const povertyRank = sortedByPoverty.findIndex(x => x.n === d.n) + 1;
    const povertyPercentile = Math.round((povertyRank / sortedByPoverty.length) * 100);
    
    document.getElementById('povertyRank').textContent = `#${povertyRank} of ${sortedByPoverty.length}`;
    document.getElementById('povertyRankFill').style.width = povertyPercentile + '%';
    document.getElementById('povertyRankDesc').textContent = `Higher poverty than ${100 - povertyPercentile}% of districts`;
    
    // SpEd ranking
    const sortedBySpEd = [...allDistrictsForYear].sort((a, b) => b.sp - a.sp);
    const spedRank = sortedBySpEd.findIndex(x => x.n === d.n) + 1;
    const spedPercentile = Math.round((spedRank / sortedBySpEd.length) * 100);
    
    document.getElementById('spedRank').textContent = `#${spedRank} of ${sortedBySpEd.length}`;
    document.getElementById('spedRankFill').style.width = spedPercentile + '%';
    document.getElementById('spedRankDesc').textContent = `Higher SpEd % than ${100 - spedPercentile}% of districts`;
}

function comparePreset(type, element) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    }
    
    // For now, just switch to county comparison
    document.getElementById('compareToSelect').value = 'county';
    updateComparison();
}

// ============== SOLUTIONS TAB ==============
function selectYear(year, element) {
    document.querySelectorAll('.timeline-item').forEach(item => item.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    } else {
        // Find the element for the year if not provided
        const items = document.querySelectorAll('.timeline-item');
        const yearIndex = year - 2025;
        if (items[yearIndex]) {
            items[yearIndex].classList.add('active');
        }
    }
    
    const reform = REFORM_POLICIES[year];
    if (!reform) return;
    
    const detail = document.getElementById('yearDetail');
    
    detail.innerHTML = `
        <h3> ${reform.title}</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Estimated Total Cost: <span style="color: var(--accent-yellow); font-weight: 600;">${reform.cost}</span></p>
        <div class="policy-grid">
            ${reform.policies.map(p => `
                <div class="policy-card priority-${p.priority}">
                    <h4>${p.name}</h4>
                    <p>${p.desc}</p>
                    <div class="cost">Est. Cost: <span>${p.cost}</span></div>
                </div>
            `).join('')}
        </div>
    `;
}

function updateSolutionSimulator() {
    const poverty = parseInt(document.getElementById('solPovertySlider').value);
    const sped = parseInt(document.getElementById('solSpedSlider').value) / 100;
    const lea = parseInt(document.getElementById('solLeaSlider').value);
    
    document.getElementById('solPovertyValue').textContent = poverty + '%';
    document.getElementById('solSpedValue').textContent = (sped * 100).toFixed(1) + '%';
    document.getElementById('solLeaValue').textContent = '$' + lea.toLocaleString();
    
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const baseFunding = 12500;
    
    // Calculate total benefit
    const povertyBenefit = d.li * d.t * baseFunding * (poverty / 100);
    const spedBenefit = d.sp > sped ? 0 : (d.sp > 0.155 ? (Math.min(d.sp, sped) - 0.155) * d.t * 25000 : 0);
    
    const ppAV = d.av / d.t;
    const levy250 = ppAV * 0.0025;
    const leaBenefit = d.lea === 'rate' && levy250 < lea ? Math.max(0, lea - Math.max(levy250, 2021)) * d.t : 0;
    
    const totalBenefit = povertyBenefit + spedBenefit + leaBenefit;
    const perStudent = d.t > 0 ? Math.round(totalBenefit / d.t) : 0;
    
    // Rough statewide cost estimate
    const statewideCost = (poverty * 0.25 + (sped - 0.155) * 1.5 + (lea - 2021) * 0.0008).toFixed(1);
    
    document.getElementById('solTotalBenefit').textContent = '+$' + Math.round(totalBenefit).toLocaleString() + '/year';
    document.getElementById('solPerStudent').textContent = '+$' + perStudent.toLocaleString();
    document.getElementById('solStatewideCost').textContent = '$' + statewideCost + 'B';
}

// ============== BRIEF TAB ==============
function updateBrief() {
    if (!currentDistrict) return;
    
    const d = currentDistrict;
    const gap = calculateFundingGap(d);
    
    document.getElementById('briefDistrictName').textContent = d.n;
    document.getElementById('briefYear').textContent = currentYear;
    document.getElementById('briefDate').textContent = new Date().toLocaleDateString();
    
    document.getElementById('briefSummary').innerHTML = `
        ${d.n} serves <strong>${d.t.toLocaleString()}</strong> students in ${d.c} County. 
        Our district faces a per-pupil funding gap of <strong style="color: #ff6b6b;">$${gap.total.toLocaleString()}</strong>, 
        representing a <strong style="color: #ff6b6b;">$${(gap.total * d.t).toLocaleString()}</strong> annual shortfall 
        that directly impacts classroom resources and student outcomes.
    `;
    
    document.getElementById('briefMetrics').innerHTML = `
        <div class="brief-metric"><span class="label">Total Enrollment</span><span class="value">${d.t.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value">${STATE_AVERAGES.enrollment.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">Low-Income Students</span><span class="value">${(d.li * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value">${(STATE_AVERAGES.lowIncome * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">Per-Pupil Funding Gap</span><span class="value gap">-$${gap.total.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">State Average</span><span class="value gap">-$${STATE_AVERAGES.perPupilGap.toLocaleString()}</span></div>
        <div class="brief-metric"><span class="label">Special Education %</span><span class="value">${(d.sp * 100).toFixed(1)}%</span></div>
        <div class="brief-metric"><span class="label">State Cap</span><span class="value">15.5%</span></div>
    `;
    
    // Sort challenges by impact
    const challenges = [
        { name: 'No Poverty Weight', impact: gap.components.poverty },
        { name: 'SpEd 15.5% Cap', impact: gap.components.sped },
        { name: 'MSOC Inflation Freeze', impact: gap.components.msoc },
        { name: 'LEA Inequality', impact: gap.components.lea },
        { name: 'Regionalization Gap', impact: gap.components.region },
        { name: 'ELL Underfunding', impact: gap.components.ell }
    ].filter(c => c.impact > 0).sort((a, b) => b.impact - a.impact).slice(0, 3);
    
    document.getElementById('briefChallenges').innerHTML = challenges.map((c, i) => `
        <li>
            <span class="challenge-title">${i + 1}. ${c.name}</span><br>
            <span class="challenge-impact">Impact: $${(c.impact * d.t).toLocaleString()} annual shortfall ($${c.impact.toLocaleString()}/student)</span>
        </li>
    `).join('');
    
    document.getElementById('briefActions').innerHTML = `
        <li> Implement 20% poverty weight  <span class="benefit">+$${Math.round(d.li * d.t * 12500 * 0.2).toLocaleString()}</span> for our district</li>
        <li> Raise SpEd cap to 17.5%  <span class="benefit">+$${Math.round(Math.max(0, d.sp - 0.155) * d.t * 25000).toLocaleString()}</span> for our district</li>
        <li> Restore MSOC to inflation-adjusted levels  <span class="benefit">+$${Math.round(450 * d.t).toLocaleString()}</span> for our district</li>
    `;
}

function generateBrief() {
    // Find and click the brief tab button
    const briefTabBtn = document.querySelector('.tab-btn:nth-child(5)');
    showTab('brief', briefTabBtn);
}

function printBrief() {
    document.getElementById('tab-brief').classList.add('brief-print');
    window.print();
    document.getElementById('tab-brief').classList.remove('brief-print');
}

function copyBrief() {
    const d = currentDistrict;
    if (!d) {
        alert('Please select a district first.');
        return;
    }
    
    const gap = calculateFundingGap(d);
    
    const text = `
${d.n.toUpperCase()}
K-12 Funding Gap Analysis | Fiscal Year ${currentYear}

EXECUTIVE SUMMARY
${d.n} serves ${d.t.toLocaleString()} students in ${d.c} County. Our district faces a per-pupil funding gap of $${gap.total.toLocaleString()}, representing a $${(gap.total * d.t).toLocaleString()} annual shortfall.

KEY METRICS
- Enrollment: ${d.t.toLocaleString()}
- Low-Income: ${(d.li * 100).toFixed(1)}%
- SpEd: ${(d.sp * 100).toFixed(1)}%
- Per-Pupil Gap: -$${gap.total.toLocaleString()}

Generated by WA K-12 Funding Analysis Tool
${new Date().toLocaleDateString()}
    `.trim();
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Brief copied to clipboard!');
    });
}

// Window resize handler
window.addEventListener('resize', () => {
    if (currentDistrict) {
        updateComparisonChart();
    }
});
</script>
</body>
</html>
