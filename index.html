<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive dashboard analyzing Washington State K-12 school funding gaps. Understand problems, explore solutions, and take action.">
    <meta name="keywords" content="Washington, K-12, education funding, school funding gap, McCleary, special education, LEA, poverty weight">
    <title>WA K-12 Funding Gap Analysis</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

    <style>
        /* ============== CSS VARIABLES ============== */
        :root {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --accent-blue: #4facfe;
            --accent-cyan: #00f2fe;
            --accent-red: #ff6b6b;
            --accent-yellow: #feca57;
            --accent-green: #2ed573;
            --accent-purple: #a55eea;
            --text-primary: #e8e8e8;
            --text-secondary: #9a9a9a;
            --card-bg: rgba(255,255,255,0.04);
            --card-border: rgba(255,255,255,0.12);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* ============== ACCESSIBILITY ============== */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-blue);
            color: #000;
            padding: 10px 20px;
            z-index: 1000;
            font-weight: 600;
            text-decoration: none;
        }
        .skip-link:focus { top: 0; }

        *:focus-visible {
            outline: 3px solid var(--accent-blue);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ============== GLOBAL HEADER ============== */
        .global-header {
            padding: 12px 30px;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .control-group label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            background: rgba(0,0,0,0.3);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 180px;
        }

        .control-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* ============== TAB NAVIGATION ============== */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.4);
            border-bottom: 1px solid var(--card-border);
            padding: 15px 20px;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 14px 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(79, 172, 254, 0.15);
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            color: #fff;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-color: transparent;
            box-shadow: 0 5px 25px rgba(79, 172, 254, 0.4);
        }

        .tab-btn.problems.active {
            background: linear-gradient(135deg, var(--accent-red), #ff8e8e);
            box-shadow: 0 5px 25px rgba(255, 107, 107, 0.4);
        }

        .tab-btn.solutions.active {
            background: linear-gradient(135deg, var(--accent-green), #7bed9f);
            box-shadow: 0 5px 25px rgba(46, 213, 115, 0.4);
        }

        .tab-btn.action.active {
            background: linear-gradient(135deg, var(--accent-purple), #c56cf0);
            box-shadow: 0 5px 25px rgba(165, 94, 234, 0.4);
        }

        /* ============== TAB CONTENT ============== */
        .tab-content {
            display: none;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============== SECTIONS ============== */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--accent-blue);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ============== QUICK GUIDE SECTION ============== */
        .quick-guide {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.05));
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .quick-guide h1 {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .quick-guide p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* ============== PIE CHART ============== */
        .pie-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            padding: 20px;
        }

        .pie-chart-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #2563eb 0% 70%,
                #10b981 70% 92%,
                #ffc107 92% 100%
            );
            position: relative;
        }

        .pie-chart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: #1a1a2e;
            border-radius: 50%;
        }

        .pie-chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }

        .pie-chart-center .total-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .pie-chart-center .total-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .legend-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .legend-color.state { background: #2563eb; }
        .legend-color.local { background: #10b981; }
        .legend-color.federal { background: #ffc107; }

        .legend-info strong {
            display: block;
            color: var(--text-primary);
        }

        .legend-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-values {
            margin-left: auto;
            text-align: right;
        }

        .legend-percent {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .legend-percent.state { color: #3b82f6; }
        .legend-percent.local { color: #10b981; }
        .legend-percent.federal { color: #ffc107; }

        .legend-amount {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ============== DISTRICT STATS ============== */
        .district-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--accent-blue);
            background: rgba(79, 172, 254, 0.1);
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-card .value.red { color: var(--accent-red); }
        .stat-card .value.green { color: var(--accent-green); }
        .stat-card .value.blue { color: var(--accent-blue); }
        .stat-card .value.yellow { color: var(--accent-yellow); }

        .stat-card .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* ============== 6 PROBLEMS GRID ============== */
        .problems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .problem-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 16px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .problem-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.2);
        }

        .problem-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .problem-card .title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .problem-card .summary {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .problem-card .impact {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            padding: 12px;
            position: relative;
        }

        .problem-card .impact-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .problem-card .impact-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-red);
        }

        /* Expand icon - top right corner */
        .problem-card .expand-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .problem-card:hover .expand-icon {
            background: rgba(79, 172, 254, 0.3);
            transform: scale(1.1);
        }

        .problem-card .expand-icon::after {
            content: 'Ôºã';
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 700;
            line-height: 1;
            transition: all 0.3s;
        }

        .problem-card:hover .expand-icon::after {
            color: var(--accent-blue);
        }

        .problem-card.expanded .expand-icon {
            background: rgba(255, 107, 107, 0.3);
            transform: rotate(45deg);
        }

        .problem-card.expanded .expand-icon::after {
            color: var(--accent-red);
        }

        .problem-card .details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--card-border);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .problem-card.expanded .details {
            display: block;
        }

        /* ============== SOLUTIONS TIMELINE ============== */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: rgba(255,255,255,0.1);
        }

        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1;
        }

        .timeline-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .timeline-item:hover .timeline-dot,
        .timeline-item.active .timeline-dot {
            background: var(--accent-green);
            border-color: var(--accent-green);
            transform: scale(1.1);
        }

        .timeline-year {
            font-size: 1rem;
            font-weight: 600;
        }

        .timeline-session {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ============== REFORM SLIDERS ============== */
        .slider-group {
            margin-bottom: 25px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .slider-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .slider-value {
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-impact {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ============== GAP BREAKDOWN ============== */
        .gap-reform-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .gap-reform-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }

        .gap-category {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .category-icon {
            font-size: 1.2rem;
        }

        .gap-values {
            display: flex;
            gap: 20px;
        }

        .gap-col {
            text-align: center;
        }

        .gap-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .gap-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .gap-value.gap-negative { color: var(--accent-red); }
        .gap-value.gap-positive { color: var(--accent-green); }

        /* ============== REFORM RESULT ============== */
        .reform-result {
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(46, 213, 115, 0.05));
            border-radius: 16px;
            padding: 30px;
            text-align: center;
        }

        .reform-result-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .reform-result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        /* ============== ACTION TAB ============== */
        .brief-container {
            background: #fff;
            color: #333;
            border-radius: 12px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .brief-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .brief-header h1 {
            font-size: 1.8rem;
            color: #1a1a2e;
        }

        .brief-header .subtitle {
            font-size: 0.9rem;
            color: #666;
        }

        .brief-section {
            margin-bottom: 25px;
        }

        .brief-section h2 {
            font-size: 1.1rem;
            color: #1a1a2e;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .brief-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .brief-metric {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .brief-metric .label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        .brief-metric .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a2e;
        }

        .brief-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .brief-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .brief-btn.print {
            background: var(--accent-blue);
            color: #fff;
        }

        .brief-btn.copy {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
        }

        .brief-btn:hover {
            transform: translateY(-2px);
        }

        /* ============== LEGISLATOR CONTACT ============== */
        .legislator-section {
            background: rgba(165, 94, 234, 0.1);
            border: 1px solid rgba(165, 94, 234, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
        }

        .legislator-section h3 {
            color: var(--accent-purple);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: var(--accent-purple);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(165, 94, 234, 0.4);
        }

        /* ============== EMAIL TEMPLATE ============== */
        .email-template {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .email-template h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .email-template textarea {
            width: 100%;
            min-height: 250px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .email-template textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .copy-template-btn {
            margin-top: 15px;
            padding: 12px 24px;
            background: var(--accent-green);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-template-btn:hover {
            transform: translateY(-2px);
        }

        /* ============== SHARE BUTTONS ============== */
        .share-section {
            margin-top: 30px;
            text-align: center;
        }

        .share-section h4 {
            margin-bottom: 20px;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .share-btn.twitter { background: #1DA1F2; color: #fff; }
        .share-btn.facebook { background: #4267B2; color: #fff; }
        .share-btn.email { background: var(--accent-blue); color: #fff; }
        .share-btn.copy { background: rgba(255,255,255,0.1); color: var(--text-primary); border: 1px solid var(--card-border); }

        .share-btn:hover {
            transform: translateY(-2px);
        }

        /* ============== PRESET BUTTONS ============== */
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .preset-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        /* ============== SCATTER PLOT ============== */
        .scatter-filter-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scatter-filter-btn:hover {
            background: rgba(79, 172, 254, 0.15);
            border-color: var(--accent-blue);
        }

        .scatter-filter-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
            font-weight: 600;
        }

        /* ============== RESPONSIVE ============== */
        @media (max-width: 768px) {
            .global-header {
                padding: 12px 15px;
            }

            .tab-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .gap-reform-row {
                grid-template-columns: 1fr;
            }

            .pie-chart-container {
                flex-direction: column;
            }

            .brief-metrics {
                grid-template-columns: 1fr;
            }

            .brief-container {
                padding: 20px;
            }
        }

        /* ============== TOOLTIP ============== */
        .tooltip {
            position: fixed;
            background: rgba(10, 15, 30, 0.98);
            border: 1px solid var(--accent-blue);
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* ============== LOADING ============== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============== PRINT STYLES ============== */
        @media print {
            body {
                background: #fff;
                color: #000;
            }

            .global-header, .tab-nav, .brief-controls, .share-section, .legislator-section {
                display: none;
            }

            .brief-container {
                box-shadow: none;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- GLOBAL HEADER -->
    <header class="global-header">
        <div class="logo">üéì WA K-12 Funding Gap Analysis</div>
        <div class="header-controls">
            <div class="control-group">
                <label>County</label>
                <select id="countySelect" onchange="filterByCounty()">
                    <option value="">All Counties</option>
                </select>
            </div>
            <div class="control-group">
                <label>District</label>
                <select id="districtSelect" onchange="selectDistrict()">
                    <option value="">Select a District...</option>
                </select>
            </div>
        </div>
    </header>

    <!-- TAB NAVIGATION - 3 TABS -->
    <nav class="tab-nav" role="tablist">
        <button class="tab-btn problems active" onclick="showTab('problems', this)" role="tab" aria-selected="true">
            ‚ö†Ô∏è Problems
        </button>
        <button class="tab-btn solutions" onclick="showTab('solutions', this)" role="tab" aria-selected="false">
            ‚úÖ Solutions
        </button>
        <button class="tab-btn action" onclick="showTab('action', this)" role="tab" aria-selected="false">
            ‚úä Take Action
        </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="main-content">
        <!-- ==================== TAB 1: PROBLEMS ==================== -->
        <div id="tab-problems" class="tab-content active" role="tabpanel">
            <!-- Quick Guide Summary -->
            <div class="quick-guide">
                <h1>üè† Understanding School Funding</h1>
                <p>Washington schools face a $2+ billion funding gap. Here's why your district doesn't have enough money, and what you can do about it.</p>
            </div>

            <!-- Funding Sources Pie Chart -->
            <section class="section">
                <h2 class="section-title">üí∞ Where Does School Money Come From?</h2>
                <div class="pie-chart-container">
                    <div class="pie-chart-wrapper">
                        <div class="pie-chart" id="pieChart"></div>
                        <div class="pie-chart-center">
                            <div class="total-label">Total Budget</div>
                            <div class="total-value" id="pieTotalAmt">$0</div>
                        </div>
                    </div>
                    <div class="pie-legend">
                        <div class="pie-legend-item">
                            <div class="legend-color state">üèõÔ∏è</div>
                            <div class="legend-info">
                                <strong>State Government</strong>
                                <p>Primary funding through state taxes</p>
                            </div>
                            <div class="legend-values">
                                <div class="legend-percent state" id="pieStatePct">70%</div>
                                <div class="legend-amount" id="pieStateAmt">$0</div>
                            </div>
                        </div>
                        <div class="pie-legend-item">
                            <div class="legend-color local">üèòÔ∏è</div>
                            <div class="legend-info">
                                <strong>Local Property Taxes</strong>
                                <p>Voter-approved levies & bonds</p>
                            </div>
                            <div class="legend-values">
                                <div class="legend-percent local" id="pieLocalPct">22%</div>
                                <div class="legend-amount" id="pieLocalAmt">$0</div>
                            </div>
                        </div>
                        <div class="pie-legend-item">
                            <div class="legend-color federal">üá∫üá∏</div>
                            <div class="legend-info">
                                <strong>Federal Government</strong>
                                <p>Title I, special ed, lunch programs</p>
                            </div>
                            <div class="legend-values">
                                <div class="legend-percent federal" id="pieFederalPct">8%</div>
                                <div class="legend-amount" id="pieFederalAmt">$0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- District Stats -->
            <section class="section">
                <h2 class="section-title">üìä <span id="districtNameStats">Your District</span> at a Glance</h2>
                <div class="district-stats-grid" id="districtStatsGrid">
                    <div class="stat-card">
                        <div class="label">Enrollment</div>
                        <div class="value blue" id="statEnrollment">--</div>
                        <div class="subtitle">Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Funding Gap</div>
                        <div class="value red" id="statFundingGap">--</div>
                        <div class="subtitle">Per Student</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Low-Income</div>
                        <div class="value yellow" id="statLowIncome">--</div>
                        <div class="subtitle">FRL Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">SpEd Rate</div>
                        <div class="value" id="statSpEd">--</div>
                        <div class="subtitle">vs 15.5% Cap</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ELL Rate</div>
                        <div class="value blue" id="statELL">--</div>
                        <div class="subtitle">English Learners</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Shortfall</div>
                        <div class="value red" id="statTotalShortfall">--</div>
                        <div class="subtitle">Per Year</div>
                    </div>
                </div>
            </section>

            <!-- 6 Problems -->
            <section class="section">
                <h2 class="section-title">‚ö†Ô∏è 6 Structural Problems in WA's Funding Model</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Click each card to see detailed analysis and impact on your district</p>

                <div class="problems-grid" id="problemsGrid">
                    <!-- Problem 1 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">üí∞</div>
                        <div class="title">No Poverty Weight</div>
                        <div class="summary">Washington is 1 of only 3 states without additional funding for low-income students.</div>
                        <div class="impact">
                            <div class="impact-label">Impact on Your District</div>
                            <div class="impact-value" id="problem1Impact">$0 unfunded</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                Low-income students require additional support services, smaller class sizes, and intervention programs.
                                Without a poverty weight, high-poverty districts must fund these with local levies, creating systematic inequality.
                            </p>
                            <div style="background: rgba(46,213,115,0.1); padding: 15px; border-radius: 8px;">
                                <strong style="color: var(--accent-yellow);">If WA adopted a 20% poverty weight:</strong>
                                <div style="color: var(--accent-green); font-size: 1.2rem; margin-top: 10px;" id="problem1Solution">+$0 for your district</div>
                            </div>
                        </div>
                    </div>

                    <!-- Problem 2 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">‚ôø</div>
                        <div class="title">SpEd 15.5% Cap</div>
                        <div class="summary">State funding is capped at 15.5% regardless of actual special education population.</div>
                        <div class="impact">
                            <div class="impact-label">Impact on Your District</div>
                            <div class="impact-value" id="problem2Impact">0% above cap</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                Many districts serve SpEd populations well above 15.5%. Each student above the cap costs $25,000+ annually
                                but receives no state funding, forcing districts to cut general education programs.
                            </p>
                        </div>
                    </div>

                    <!-- Problem 3 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">üì¶</div>
                        <div class="title">MSOC Frozen Since 2018</div>
                        <div class="summary">Materials, Supplies, Operating Costs haven't kept pace with inflation.</div>
                        <div class="impact">
                            <div class="impact-label">Statewide Impact</div>
                            <div class="impact-value">~$350M shortfall</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary);">
                                Insurance premiums have risen 100%+, utilities 50%+, but MSOC allocations remain at 2018 levels.
                                This silent erosion forces districts to cut classroom spending to pay fixed costs.
                            </p>
                        </div>
                    </div>

                    <!-- Problem 4 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">üó∫Ô∏è</div>
                        <div class="title">Regressive Regionalization</div>
                        <div class="summary">Cost-of-living factors don't reflect actual regional cost differences.</div>
                        <div class="impact">
                            <div class="impact-label">Your District's CIS Factor</div>
                            <div class="impact-value" id="problem4Impact">1.00</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary);">
                                Districts with CIS below 1.04 receive less funding per staff position despite needing competitive
                                salaries to attract teachers.
                            </p>
                        </div>
                    </div>

                    <!-- Problem 5 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">üè¶</div>
                        <div class="title">Levy Paradox</div>
                        <div class="summary">Wealthy districts hit the $2,500 levy cap - voters approve more, but state won't let them collect it.</div>
                        <div class="impact">
                            <div class="impact-label">Your District</div>
                            <div class="impact-value" id="problem5Impact">Loading...</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                <strong>Two types of districts hurt differently:</strong>
                            </p>
                            <div style="background: rgba(255,107,107,0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong style="color: var(--accent-yellow);">üèòÔ∏è Wealthy Districts (Revenue-Capped):</strong>
                                <p style="margin-top: 8px;">Voters approve $3,000+/student levies, but state caps at $2,500. The district <em>could</em> collect more but <strong>isn't allowed to</strong>.</p>
                            </div>
                            <div style="background: rgba(255,202,87,0.1); padding: 15px; border-radius: 8px;">
                                <strong style="color: var(--accent-yellow);">üèöÔ∏è Poor Districts (Rate-Capped):</strong>
                                <p style="margin-top: 8px;">Even at max tax rate ($2.50/1000), low property values can't generate enough. They <em>want</em> to raise more but <strong>can't</strong>.</p>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;" id="problem5Detail">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Problem 6 -->
                    <div class="problem-card" onclick="toggleProblem(this)">
                        <div class="expand-icon"></div>
                        <div class="icon">üìâ</div>
                        <div class="title">Enrollment Decline Cliff</div>
                        <div class="summary">No "hold harmless" provision - funding drops immediately with enrollment.</div>
                        <div class="impact">
                            <div class="impact-label">Your Enrollment Change</div>
                            <div class="impact-value" id="problem6Impact">0%</div>
                        </div>
                        <div class="details">
                            <p style="color: var(--text-secondary);">
                                Fixed costs don't scale linearly with enrollment. A 5% decline doesn't mean 5% fewer teachers needed,
                                but funding drops exactly 5%.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scatter Plot Analysis -->
            <section class="section">
                <h2 class="section-title">üìà Funding Gap Correlation Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">See how funding gaps relate to district characteristics across all WA districts</p>

                <!-- X-axis Filter -->
                <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span style="color: var(--text-secondary);">X-Axis:</span>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="scatter-filter-btn active" data-axis="poverty" onclick="updateScatterAxis('poverty')">Poverty Rate</button>
                        <button class="scatter-filter-btn" data-axis="sped" onclick="updateScatterAxis('sped')">SpEd Rate</button>
                        <button class="scatter-filter-btn" data-axis="ell" onclick="updateScatterAxis('ell')">ELL Rate</button>
                        <button class="scatter-filter-btn" data-axis="enrollment" onclick="updateScatterAxis('enrollment')">Enrollment</button>
                    </div>
                </div>

                <!-- Scatter Plot Container -->
                <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">Y-Axis: Funding Gap ($/student)</span>
                        </div>
                        <div id="scatterR2" style="background: rgba(79,172,254,0.2); padding: 8px 15px; border-radius: 8px;">
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">R¬≤ = </span>
                            <span style="color: var(--accent-cyan); font-weight: 700; font-size: 1.1rem;" id="r2Value">0.00</span>
                        </div>
                    </div>

                    <!-- SVG Scatter Plot -->
                    <div id="scatterPlotContainer" style="width: 100%; height: 350px; position: relative;">
                        <svg id="scatterPlot" width="100%" height="100%" viewBox="0 0 800 350" preserveAspectRatio="xMidYMid meet">
                            <!-- Grid lines -->
                            <g id="gridLines" stroke="rgba(255,255,255,0.1)" stroke-width="1"></g>
                            <!-- Axes -->
                            <line x1="60" y1="300" x2="780" y2="300" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            <line x1="60" y1="20" x2="60" y2="300" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                            <!-- Trend line -->
                            <line id="trendLine" x1="60" y1="300" x2="780" y2="20" stroke="var(--accent-cyan)" stroke-width="2" stroke-dasharray="8,4" opacity="0.8"/>
                            <!-- Data points -->
                            <g id="scatterPoints"></g>
                            <!-- Axis labels -->
                            <g id="xAxisLabels" fill="var(--text-secondary)" font-size="11"></g>
                            <g id="yAxisLabels" fill="var(--text-secondary)" font-size="11"></g>
                            <!-- Axis titles -->
                            <text x="420" y="340" fill="var(--text-secondary)" font-size="12" text-anchor="middle" id="xAxisTitle">Poverty Rate (%)</text>
                            <text x="20" y="160" fill="var(--text-secondary)" font-size="12" text-anchor="middle" transform="rotate(-90, 20, 160)">Funding Gap ($/student)</text>
                        </svg>
                    </div>

                    <!-- Legend -->
                    <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; background: var(--accent-blue); border-radius: 50%;"></div>
                            <span style="color: var(--text-secondary);">Other Districts</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 14px; height: 14px; background: var(--accent-yellow); border-radius: 50%; border: 2px solid #fff;"></div>
                            <span style="color: var(--text-secondary);">Selected District</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 2px; background: var(--accent-cyan); border-radius: 1px;"></div>
                            <span style="color: var(--text-secondary);">Trend Line</span>
                        </div>
                    </div>
                </div>

                <!-- Interpretation -->
                <div id="scatterInterpretation" style="margin-top: 15px; padding: 15px; background: rgba(79,172,254,0.1); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">What does this mean?</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;" id="scatterExplanation">
                        Higher poverty rates correlate with larger funding gaps, showing the systematic disadvantage faced by high-poverty districts.
                    </div>
                </div>
            </section>
        </div>

        <!-- ==================== TAB 2: SOLUTIONS ==================== -->
        <div id="tab-solutions" class="tab-content" role="tabpanel">
            <!-- 2025 Passed Legislation -->
            <section class="section">
                <h2 class="section-title" style="color: var(--accent-green);">‚úÖ 2025 Session: Passed K-12 Funding Bills</h2>
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Washington State Legislature - applies to ALL districts statewide</p>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.85rem;">
                    Source: <a href="https://senatedemocrats.wa.gov/blog/2025/04/27/legislature-passes-budget-to-protect-essential-services-support-k-12-education/" target="_blank" style="color: var(--accent-blue);">WA Senate Democrats</a> |
                    <a href="https://educationvoters.org/resources/bill-tracker/" target="_blank" style="color: var(--accent-blue);">League of Education Voters</a>
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <!-- SB 5263 -->
                    <div style="background: rgba(46,213,115,0.1); border: 1px solid rgba(46,213,115,0.3); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="background: var(--accent-green); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">PASSED</span>
                            <span style="font-weight: 700; font-size: 1.1rem;">SB 5263</span>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">Special Education Funding</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Removes 15.5% cap, increases multiplier to 1.16</p>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">4-Year Investment</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-green);">+$750M</div>
                        </div>
                    </div>

                    <!-- SB 5192 -->
                    <div style="background: rgba(46,213,115,0.1); border: 1px solid rgba(46,213,115,0.3); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="background: var(--accent-green); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">PASSED</span>
                            <span style="font-weight: 700; font-size: 1.1rem;">SB 5192</span>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">MSOC Funding Increase</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Materials, Supplies & Operating Costs adjustment</p>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">New Investment</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-green);">+$213M</div>
                        </div>
                    </div>

                    <!-- HB 2049 -->
                    <div style="background: rgba(46,213,115,0.1); border: 1px solid rgba(46,213,115,0.3); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="background: var(--accent-green); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">PASSED</span>
                            <span style="font-weight: 700; font-size: 1.1rem;">HB 2049</span>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">School Levy Reform</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Gives districts option to ask for more levy support</p>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Effective Date</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-blue);">July 27, 2025</div>
                        </div>
                    </div>

                    <!-- LEA -->
                    <div style="background: rgba(46,213,115,0.1); border: 1px solid rgba(46,213,115,0.3); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="background: var(--accent-blue); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">BUDGET</span>
                            <span style="font-weight: 700; font-size: 1.1rem;">LEA Funding</span>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">Local Effort Assistance</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Helps low-property-value districts raise levy funds</p>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">4-Year Investment</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-green);">+$200M</div>
                        </div>
                    </div>
                </div>

                <!-- Total Investment Summary -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(46,213,115,0.2), rgba(46,213,115,0.05)); border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Total New K-12 Investment (2025-29)</div>
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">$1.4 Billion</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px;">+ 2.5% COLA for 2025-26 | + 2.6% COLA for 2026-27</div>
                </div>
            </section>

            <!-- UW Superintendents' 5-Year Reform Roadmap -->
            <section class="section">
                <h2 class="section-title" style="color: var(--accent-purple);">üìã 5-Year Reform Roadmap</h2>
                <p style="color: var(--text-secondary); margin-bottom: 10px;">UW College of Education & Washington Superintendents Coalition - Statewide policy vision</p>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.85rem;">
                    Source: <a href="https://education.uw.edu/ctp" target="_blank" style="color: var(--accent-blue);">Fujioka, Knight, et al. (Aug 2024) - UW Center for the Study of Teaching and Policy</a>
                </p>

                <!-- Timeline -->
                <div style="position: relative; padding-left: 30px;">
                    <!-- Year 1 -->
                    <div style="position: relative; margin-bottom: 25px; padding: 20px; background: rgba(165,94,234,0.15); border-left: 4px solid var(--accent-purple); border-radius: 0 12px 12px 0;">
                        <div style="position: absolute; left: -42px; top: 20px; width: 24px; height: 24px; background: var(--accent-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">1</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: var(--accent-purple); color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">2025 (Long Session)</span>
                            <span style="font-weight: 700; color: var(--text-primary);">The "Big 3" Ample Funding</span>
                        </div>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 5px;"><strong>Special Education:</strong> Increase multiplier, remove 15.5% cap</li>
                            <li style="margin-bottom: 5px;"><strong>MSOC:</strong> Match inflation for insurance, utilities, etc.</li>
                            <li><strong>Transportation:</strong> Fix formula that penalizes efficiencies</li>
                        </ul>
                    </div>

                    <!-- Year 2 -->
                    <div style="position: relative; margin-bottom: 25px; padding: 20px; background: rgba(79,172,254,0.1); border-left: 4px solid var(--accent-blue); border-radius: 0 12px 12px 0;">
                        <div style="position: absolute; left: -42px; top: 20px; width: 24px; height: 24px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">2</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: var(--accent-blue); color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">2026 (Short Session)</span>
                            <span style="font-weight: 700; color: var(--text-primary);">Groundwork for Equity</span>
                        </div>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 5px;"><strong>Levy/LEA Reform:</strong> Study mechanisms for expanding LEA</li>
                            <li style="margin-bottom: 5px;"><strong>FRL Weight:</strong> Groundwork for income-based student weight (replacing LAP)</li>
                            <li><strong>Prototypical Model:</strong> Study updates for MTSS enrichment</li>
                        </ul>
                    </div>

                    <!-- Year 3 -->
                    <div style="position: relative; margin-bottom: 25px; padding: 20px; background: rgba(165,94,234,0.15); border-left: 4px solid var(--accent-purple); border-radius: 0 12px 12px 0;">
                        <div style="position: absolute; left: -42px; top: 20px; width: 24px; height: 24px; background: var(--accent-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">3</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: var(--accent-purple); color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">2027 (Long Session)</span>
                            <span style="font-weight: 700; color: var(--text-primary);">Investment in Equitable Funding</span>
                        </div>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 5px;"><strong>Levy/LEA Reform:</strong> Implement expanded LEA matching up to levy cap</li>
                            <li style="margin-bottom: 5px;"><strong>FRL Weighted Student Funding:</strong> Adopt income-based weight (20%+ like CA)</li>
                            <li><strong>Prototypical Model:</strong> Update staffing ratios for student needs</li>
                        </ul>
                    </div>

                    <!-- Year 4 -->
                    <div style="position: relative; margin-bottom: 25px; padding: 20px; background: rgba(79,172,254,0.1); border-left: 4px solid var(--accent-blue); border-radius: 0 12px 12px 0;">
                        <div style="position: absolute; left: -42px; top: 20px; width: 24px; height: 24px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">4</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: var(--accent-blue); color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">2028 (Short Session)</span>
                            <span style="font-weight: 700; color: var(--text-primary);">Finalize Student Funding Model</span>
                        </div>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding-left: 20px;">
                            <li>Study transition from resource-based to student-based funding model</li>
                        </ul>
                    </div>

                    <!-- Year 5 -->
                    <div style="position: relative; padding: 20px; background: rgba(46,213,115,0.15); border-left: 4px solid var(--accent-green); border-radius: 0 12px 12px 0;">
                        <div style="position: absolute; left: -42px; top: 20px; width: 24px; height: 24px; background: var(--accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">5</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: var(--accent-green); color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">2029 (Long Session)</span>
                            <span style="font-weight: 700; color: var(--text-primary);">Student-Weighted Funding Formula</span>
                        </div>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 5px;"><strong>Adopt:</strong> Transition to student-based funding model with weights</li>
                            <li><strong>Goal:</strong> Equal educational opportunity for all Washington students</li>
                        </ul>
                    </div>
                </div>

                <!-- Big 5 Summary -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(165,94,234,0.2), rgba(79,172,254,0.1)); border-radius: 12px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; text-align: center;">From "Big 3" to "Big 5" Reform Areas</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; text-align: center;">
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 1.5rem;">üìö</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Special Ed</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 1.5rem;">üöå</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Transportation</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 1.5rem;">üè´</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">MSOC</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 1.5rem;">üí∞</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent-cyan);">LAP/Allocation</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">NEW</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 1.5rem;">üè†</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent-cyan);">LEA/Revenue</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">NEW</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Policy Simulator -->
            <section class="section">
                <h2 class="section-title">üîß Policy Simulator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Adjust parameters to see the impact on <span id="simDistrictName" style="color: var(--accent-blue); font-weight: 600;">your district</span></p>

                <!-- District Stats Panel -->
                <div id="simDistrictStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 15px; background: rgba(79,172,254,0.1); border-radius: 10px; border: 1px solid rgba(79,172,254,0.3);">
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Enrollment</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);" id="simEnrollment">-</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Low-Income</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red);" id="simLowIncome">-</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">SpEd Rate</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-purple);" id="simSpedRate">-</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ELL Rate</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-cyan);" id="simEllRate">-</div>
                    </div>
                </div>

                <div class="preset-buttons">
                    <button class="preset-btn" onclick="applyPreset('reset')">üîÑ Reset</button>
                    <button class="preset-btn" onclick="applyPreset('moderate')">üìä Moderate Reform</button>
                    <button class="preset-btn" onclick="applyPreset('aggressive')">üöÄ Full Equity</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">Poverty Weight</span>
                                <span class="slider-value" id="povertyWeightValue">0%</span>
                            </div>
                            <input type="range" id="povertyWeightSlider" min="0" max="35" value="0" oninput="updateSimulator()">
                            <div class="slider-impact" id="povertyImpact">WA currently provides $0 extra for low-income students</div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">SpEd Cap</span>
                                <span class="slider-value" id="spedCapValue">15.5%</span>
                            </div>
                            <input type="range" id="spedCapSlider" min="155" max="250" value="155" oninput="updateSimulator()">
                            <div class="slider-impact" id="spedImpact">State caps funding at 15.5% SpEd rate</div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">ELL Funding</span>
                                <span class="slider-value" id="ellFundingValue">$1,200</span>
                            </div>
                            <input type="range" id="ellFundingSlider" min="1200" max="2500" value="1200" step="100" oninput="updateSimulator()">
                            <div class="slider-impact" id="ellImpact">TBIP provides $1,200/ELL vs $2,500 actual cost</div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">MSOC Amount</span>
                                <span class="slider-value" id="msocValue">$1,533</span>
                            </div>
                            <input type="range" id="msocSlider" min="1533" max="2200" value="1533" step="50" oninput="updateSimulator()">
                            <div class="slider-impact" id="msocImpact">Frozen since 2018, should be ~$1,980</div>
                        </div>
                    </div>

                    <div class="reform-result">
                        <div class="reform-result-label">Total Benefit to <span id="simDistrictName2">Your District</span></div>
                        <div class="reform-result-value" id="totalBenefit">+$0/year</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Per Student</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: var(--accent-green);" id="perStudentBenefit">+$0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Statewide Cost</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: var(--accent-yellow);" id="statewideCost">$0B</div>
                            </div>
                        </div>
                        <!-- Breakdown by category -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Breakdown by Reform Area:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--accent-red);">Poverty:</span>
                                    <span id="simPovertyGain" style="color: var(--text-primary);">+$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--accent-purple);">SpEd:</span>
                                    <span id="simSpedGain" style="color: var(--text-primary);">+$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--accent-cyan);">ELL:</span>
                                    <span id="simEllGain" style="color: var(--text-primary);">+$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--accent-yellow);">MSOC:</span>
                                    <span id="simMsocGain" style="color: var(--text-primary);">+$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ==================== TAB 3: TAKE ACTION ==================== -->
        <div id="tab-action" class="tab-content" role="tabpanel">
            <!-- 1-Page Brief -->
            <section class="section">
                <h2 class="section-title" style="color: var(--accent-purple);">üìÑ 1-Page Brief for Legislators</h2>

                <div class="brief-controls">
                    <button class="brief-btn print" onclick="printBrief()">üñ®Ô∏è Print Brief</button>
                    <button class="brief-btn copy" onclick="copyBrief()">üìã Copy Text</button>
                </div>

                <div class="brief-container" id="briefContainer">
                    <div class="brief-header">
                        <h1 id="briefDistrictName">Select a District</h1>
                        <div class="subtitle">K-12 Funding Gap Analysis | Fiscal Year 2024-25</div>
                    </div>

                    <div class="brief-section">
                        <h2>Executive Summary</h2>
                        <p id="briefSummary">Select a district to generate a funding analysis brief.</p>
                    </div>

                    <div class="brief-section">
                        <h2>Key Metrics</h2>
                        <div class="brief-metrics" id="briefMetrics">
                            <div class="brief-metric">
                                <div class="label">Enrollment</div>
                                <div class="value" id="briefEnrollment">--</div>
                            </div>
                            <div class="brief-metric">
                                <div class="label">Funding Gap</div>
                                <div class="value" id="briefGap">--</div>
                            </div>
                            <div class="brief-metric">
                                <div class="label">Total Shortfall</div>
                                <div class="value" id="briefShortfall">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="brief-section">
                        <h2>Top 3 Funding Challenges</h2>
                        <ol id="briefChallenges" style="padding-left: 20px; line-height: 1.8;">
                            <li>No poverty weight funding</li>
                            <li>SpEd cap limitations</li>
                            <li>MSOC inflation freeze</li>
                        </ol>
                    </div>

                    <div class="brief-section">
                        <h2>Recommended Policy Actions</h2>
                        <ul id="briefActions" style="padding-left: 20px; line-height: 1.8;">
                            <li>Implement 20% poverty weight</li>
                            <li>Raise SpEd cap to actual rates</li>
                            <li>Inflation-adjust MSOC annually</li>
                        </ul>
                    </div>

                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.8rem; color: #888;">
                        Generated by WA K-12 Funding Analysis Tool | Data Source: OSPI
                    </div>
                </div>
            </section>

            <!-- Contact Legislators -->
            <div class="legislator-section">
                <h3>üìß Contact Your Legislators</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Your voice matters! Tell your legislators that schools need more state funding.</p>

                <a href="https://app.leg.wa.gov/districtfinder/" target="_blank" class="contact-btn">
                    üîç Find Your Legislators
                </a>
                <a href="https://www.wastatepta.org/focus-areas/advocacy/" target="_blank" class="contact-btn" style="background: var(--accent-blue);">
                    üì¢ WA State PTA Advocacy
                </a>

                <div class="email-template">
                    <h4>üìù Email Template</h4>
                    <textarea id="emailTemplate">Dear [Legislator Name],

I am writing as a constituent concerned about K-12 education funding in Washington State.

[DISTRICT NAME] faces a funding gap of [AMOUNT] per student, resulting in an annual shortfall of [TOTAL]. Our district's [X%] low-income students receive no additional state funding support, as Washington is one of only 3 states without a poverty weight in its funding formula.

I urge you to support legislation that:
‚Ä¢ Implements a poverty weight for low-income students
‚Ä¢ Raises the SpEd funding cap from 15.5% to actual district rates
‚Ä¢ Inflation-adjusts MSOC allocations annually

Our students deserve adequate funding. I would welcome the opportunity to discuss this further.

Sincerely,
[Your Name]
[Your Address]</textarea>
                    <button class="copy-template-btn" onclick="copyEmailTemplate()">üìã Copy Template</button>
                </div>
            </div>

            <!-- Share -->
            <div class="share-section">
                <h4>üì¢ Share This Information</h4>
                <div class="share-buttons">
                    <button class="share-btn twitter" onclick="shareTwitter()">üê¶ Twitter</button>
                    <button class="share-btn facebook" onclick="shareFacebook()">üìò Facebook</button>
                    <button class="share-btn email" onclick="shareEmail()">üìß Email</button>
                    <button class="share-btn copy" onclick="copyLink()">üîó Copy Link</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">Loading data...</p>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ============== DATA (EMBEDDED) ==============
        const DISTRICTS = [
            {"d":"17001","n":"Auburn School District","c":"King","y":"2024-25","t":16458,"li":0.502,"el":0.131,"sp":0.162,"cis":1.04,"lea":"revenue","av":18500000000},
            {"d":"17001","n":"Auburn School District","c":"King","y":"2023-24","t":16721,"li":0.489,"el":0.125,"sp":0.158,"cis":1.04,"lea":"revenue","av":17800000000},
            {"d":"17405","n":"Bellevue School District","c":"King","y":"2024-25","t":19856,"li":0.142,"el":0.198,"sp":0.171,"cis":1.04,"lea":"revenue","av":95000000000},
            {"d":"17405","n":"Bellevue School District","c":"King","y":"2023-24","t":19523,"li":0.138,"el":0.192,"sp":0.168,"cis":1.04,"lea":"revenue","av":92000000000},
            {"d":"17001","n":"Federal Way Public Schools","c":"King","y":"2024-25","t":21845,"li":0.628,"el":0.195,"sp":0.165,"cis":1.04,"lea":"revenue","av":15200000000},
            {"d":"17210","n":"Federal Way Public Schools","c":"King","y":"2023-24","t":22156,"li":0.615,"el":0.188,"sp":0.162,"cis":1.04,"lea":"revenue","av":14800000000},
            {"d":"17001","n":"Kent School District","c":"King","y":"2024-25","t":24789,"li":0.558,"el":0.215,"sp":0.159,"cis":1.04,"lea":"revenue","av":22500000000},
            {"d":"17415","n":"Kent School District","c":"King","y":"2023-24","t":25123,"li":0.545,"el":0.208,"sp":0.156,"cis":1.04,"lea":"revenue","av":21800000000},
            {"d":"17001","n":"Lake Washington School District","c":"King","y":"2024-25","t":29856,"li":0.118,"el":0.145,"sp":0.148,"cis":1.04,"lea":"revenue","av":85000000000},
            {"d":"17414","n":"Lake Washington School District","c":"King","y":"2023-24","t":30125,"li":0.112,"el":0.138,"sp":0.145,"cis":1.04,"lea":"revenue","av":82000000000},
            {"d":"17001","n":"Seattle Public Schools","c":"King","y":"2024-25","t":49234,"li":0.328,"el":0.125,"sp":0.178,"cis":1.04,"lea":"revenue","av":285000000000},
            {"d":"17001","n":"Seattle Public Schools","c":"King","y":"2023-24","t":50125,"li":0.315,"el":0.118,"sp":0.175,"cis":1.04,"lea":"revenue","av":275000000000},
            {"d":"32081","n":"Spokane Public Schools","c":"Spokane","y":"2024-25","t":27845,"li":0.562,"el":0.085,"sp":0.175,"cis":1.02,"lea":"rate","av":18500000000},
            {"d":"32081","n":"Spokane Public Schools","c":"Spokane","y":"2023-24","t":28156,"li":0.548,"el":0.078,"sp":0.172,"cis":1.02,"lea":"rate","av":17800000000},
            {"d":"27403","n":"Tacoma Public Schools","c":"Pierce","y":"2024-25","t":26458,"li":0.598,"el":0.165,"sp":0.182,"cis":1.03,"lea":"rate","av":22000000000},
            {"d":"27403","n":"Tacoma Public Schools","c":"Pierce","y":"2023-24","t":27125,"li":0.585,"el":0.158,"sp":0.178,"cis":1.03,"lea":"rate","av":21200000000},
            {"d":"39007","n":"Yakima School District","c":"Yakima","y":"2024-25","t":15234,"li":0.795,"el":0.358,"sp":0.148,"cis":1.00,"lea":"rate","av":5800000000},
            {"d":"39007","n":"Yakima School District","c":"Yakima","y":"2023-24","t":15456,"li":0.782,"el":0.345,"sp":0.145,"cis":1.00,"lea":"rate","av":5600000000},
            {"d":"06114","n":"Vancouver Public Schools","c":"Clark","y":"2024-25","t":22156,"li":0.485,"el":0.125,"sp":0.168,"cis":1.03,"lea":"rate","av":19500000000},
            {"d":"06114","n":"Vancouver Public Schools","c":"Clark","y":"2023-24","t":22589,"li":0.472,"el":0.118,"sp":0.165,"cis":1.03,"lea":"rate","av":18800000000},
            {"d":"17408","n":"Renton School District","c":"King","y":"2024-25","t":15125,"li":0.512,"el":0.218,"sp":0.155,"cis":1.04,"lea":"revenue","av":28500000000},
            {"d":"17408","n":"Renton School District","c":"King","y":"2023-24","t":15356,"li":0.498,"el":0.205,"sp":0.152,"cis":1.04,"lea":"revenue","av":27200000000},
            {"d":"17410","n":"Northshore School District","c":"King","y":"2024-25","t":20845,"li":0.165,"el":0.125,"sp":0.152,"cis":1.04,"lea":"revenue","av":52000000000},
            {"d":"17410","n":"Northshore School District","c":"King","y":"2023-24","t":21125,"li":0.158,"el":0.118,"sp":0.148,"cis":1.04,"lea":"revenue","av":50000000000},
            {"d":"17411","n":"Issaquah School District","c":"King","y":"2024-25","t":21234,"li":0.098,"el":0.085,"sp":0.142,"cis":1.04,"lea":"revenue","av":72000000000},
            {"d":"17411","n":"Issaquah School District","c":"King","y":"2023-24","t":21589,"li":0.092,"el":0.078,"sp":0.138,"cis":1.04,"lea":"revenue","av":69000000000},
            {"d":"27401","n":"Puyallup School District","c":"Pierce","y":"2024-25","t":22458,"li":0.385,"el":0.095,"sp":0.158,"cis":1.03,"lea":"rate","av":28500000000},
            {"d":"27401","n":"Puyallup School District","c":"Pierce","y":"2023-24","t":22856,"li":0.372,"el":0.088,"sp":0.155,"cis":1.03,"lea":"rate","av":27500000000},
            {"d":"17400","n":"Highline School District","c":"King","y":"2024-25","t":17234,"li":0.682,"el":0.312,"sp":0.158,"cis":1.04,"lea":"revenue","av":18200000000},
            {"d":"17400","n":"Highline School District","c":"King","y":"2023-24","t":17589,"li":0.665,"el":0.298,"sp":0.155,"cis":1.04,"lea":"revenue","av":17500000000},
            {"d":"17417","n":"Mercer Island School District","c":"King","y":"2024-25","t":4521,"li":0.042,"el":0.065,"sp":0.128,"cis":1.04,"lea":"revenue","av":22000000000},
            {"d":"17417","n":"Mercer Island School District","c":"King","y":"2023-24","t":4589,"li":0.038,"el":0.058,"sp":0.125,"cis":1.04,"lea":"revenue","av":21000000000},
            {"d":"27416","n":"Bethel School District","c":"Pierce","y":"2024-25","t":18956,"li":0.452,"el":0.078,"sp":0.165,"cis":1.03,"lea":"rate","av":16500000000},
            {"d":"27416","n":"Bethel School District","c":"Pierce","y":"2023-24","t":19234,"li":0.438,"el":0.072,"sp":0.162,"cis":1.03,"lea":"rate","av":15800000000},
            {"d":"31001","n":"Everett School District","c":"Snohomish","y":"2024-25","t":19845,"li":0.425,"el":0.145,"sp":0.162,"cis":1.04,"lea":"revenue","av":24500000000},
            {"d":"31001","n":"Everett School District","c":"Snohomish","y":"2023-24","t":20125,"li":0.412,"el":0.138,"sp":0.158,"cis":1.04,"lea":"revenue","av":23500000000},
            {"d":"31006","n":"Edmonds School District","c":"Snohomish","y":"2024-25","t":18756,"li":0.312,"el":0.165,"sp":0.155,"cis":1.04,"lea":"revenue","av":35000000000},
            {"d":"31006","n":"Edmonds School District","c":"Snohomish","y":"2023-24","t":19125,"li":0.298,"el":0.158,"sp":0.152,"cis":1.04,"lea":"revenue","av":33500000000},
            {"d":"33408","n":"Olympia School District","c":"Thurston","y":"2024-25","t":9845,"li":0.285,"el":0.085,"sp":0.148,"cis":1.02,"lea":"rate","av":12500000000},
            {"d":"33408","n":"Olympia School District","c":"Thurston","y":"2023-24","t":10125,"li":0.272,"el":0.078,"sp":0.145,"cis":1.02,"lea":"rate","av":12000000000},
            {"d":"03083","n":"Richland School District","c":"Benton","y":"2024-25","t":13456,"li":0.328,"el":0.095,"sp":0.152,"cis":1.01,"lea":"rate","av":11500000000},
            {"d":"03083","n":"Richland School District","c":"Benton","y":"2023-24","t":13589,"li":0.315,"el":0.088,"sp":0.148,"cis":1.01,"lea":"rate","av":11000000000},
            {"d":"03017","n":"Kennewick School District","c":"Benton","y":"2024-25","t":18234,"li":0.485,"el":0.185,"sp":0.155,"cis":1.01,"lea":"rate","av":12800000000},
            {"d":"03017","n":"Kennewick School District","c":"Benton","y":"2023-24","t":18456,"li":0.472,"el":0.178,"sp":0.152,"cis":1.01,"lea":"rate","av":12200000000},
            {"d":"11017","n":"Pasco School District","c":"Franklin","y":"2024-25","t":18956,"li":0.725,"el":0.425,"sp":0.142,"cis":1.01,"lea":"rate","av":8500000000},
            {"d":"11017","n":"Pasco School District","c":"Franklin","y":"2023-24","t":18589,"li":0.712,"el":0.412,"sp":0.138,"cis":1.01,"lea":"rate","av":8000000000},
            {"d":"34002","n":"Bellingham School District","c":"Whatcom","y":"2024-25","t":11234,"li":0.348,"el":0.125,"sp":0.165,"cis":1.02,"lea":"rate","av":15500000000},
            {"d":"34002","n":"Bellingham School District","c":"Whatcom","y":"2023-24","t":11456,"li":0.335,"el":0.118,"sp":0.162,"cis":1.02,"lea":"rate","av":14800000000},
            {"d":"21017","n":"Mead School District","c":"Spokane","y":"2024-25","t":10845,"li":0.312,"el":0.045,"sp":0.148,"cis":1.02,"lea":"rate","av":9500000000},
            {"d":"21017","n":"Mead School District","c":"Spokane","y":"2023-24","t":10956,"li":0.298,"el":0.042,"sp":0.145,"cis":1.02,"lea":"rate","av":9000000000},
            {"d":"21081","n":"Central Valley School District","c":"Spokane","y":"2024-25","t":14234,"li":0.385,"el":0.058,"sp":0.158,"cis":1.02,"lea":"rate","av":10500000000},
            {"d":"21081","n":"Central Valley School District","c":"Spokane","y":"2023-24","t":14456,"li":0.372,"el":0.052,"sp":0.155,"cis":1.02,"lea":"rate","av":10000000000}
        ];

        const STATE_AVERAGES = {
            enrollment: 3500,
            lowIncome: 0.45,
            sped: 0.155,
            ell: 0.12,
            perPupilGap: 2718,
            leaRate: 1847,
            cis: 1.02
        };

        let currentDistrict = null;
        let currentYear = '2024-25';

        // Actual voter-approved levy data (total $ approved / enrollment = per student)
        const VOTER_APPROVED_LEVY = {
            'Bellevue School District': { approved: 79000000, perStudent: 4280 },
            'Seattle Public Schools': { approved: 225000000, perStudent: 4571 },
            'Lake Washington School District': { approved: 94400000, perStudent: 3162 },
            'Issaquah School District': { approved: 67000000, perStudent: 3156 },
            'Mercer Island School District': { approved: 12000000, perStudent: 2654 },
            'Northshore School District': { approved: 67500000, perStudent: 3239 },
            'Kent School District': { approved: 79300000, perStudent: 3199 },
            'Renton School District': { approved: 43272122, perStudent: 2861 },
            'Auburn School District': { approved: 51841820, perStudent: 3150 },
            'Federal Way Public Schools': { approved: 45000000, perStudent: 2060 },
            'Highline School District': { approved: 67988856, perStudent: 3945 },
            'Edmonds School District': { approved: 52000000, perStudent: 2772 },
            'Everett School District': { approved: 48000000, perStudent: 2419 },
            'Tacoma Public Schools': { approved: 58000000, perStudent: 2192 },
            'Spokane Public Schools': { approved: 95000000, perStudent: 3412 },
            'Puyallup School District': { approved: 54000000, perStudent: 2404 },
            'Yakima School District': { approved: 21500000, perStudent: 1412 },
            'Vancouver Public Schools': { approved: 42000000, perStudent: 1896 },
            'Pasco School District': { approved: 28000000, perStudent: 1477 },
            'Kennewick School District': { approved: 32000000, perStudent: 1754 },
            'Richland School District': { approved: 25000000, perStudent: 1858 },
            'Bellingham School District': { approved: 28000000, perStudent: 2493 },
            'Olympia School District': { approved: 22000000, perStudent: 2235 },
            'Bethel School District': { approved: 38000000, perStudent: 2005 },
            'Mead School District': { approved: 24000000, perStudent: 2213 },
            'Central Valley School District': { approved: 30000000, perStudent: 2108 }
        };

        // ============== INITIALIZATION ==============
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadingOverlay').classList.add('hidden');

            populateCountySelect();
            populateDistrictSelect();
            // Default to Bellevue
            setTimeout(() => selectFeatured('Bellevue School District'), 100);
        });

        function populateCountySelect() {
            const counties = [...new Set(DISTRICTS.map(d => d.c))].sort();
            const select = document.getElementById('countySelect');
            counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                select.appendChild(option);
            });
        }

        function populateDistrictSelect(county = '') {
            const select = document.getElementById('districtSelect');
            select.innerHTML = '<option value="">Select a District...</option>';

            let districts = DISTRICTS.filter(d => d.y === currentYear);
            if (county) districts = districts.filter(d => d.c === county);

            const unique = [];
            const seen = new Set();
            districts.forEach(d => {
                if (!seen.has(d.n)) {
                    seen.add(d.n);
                    unique.push(d);
                }
            });

            unique.sort((a, b) => a.n.localeCompare(b.n)).forEach(d => {
                const option = document.createElement('option');
                option.value = d.n;
                option.textContent = d.n;
                select.appendChild(option);
            });
        }

        function filterByCounty() {
            populateDistrictSelect(document.getElementById('countySelect').value);
        }

        function selectDistrict() {
            const name = document.getElementById('districtSelect').value;
            if (!name) return;

            currentDistrict = DISTRICTS.find(d => d.n === name && d.y === currentYear);
            if (currentDistrict) updateAllDisplays();
        }

        function selectFeatured(name) {
            document.getElementById('countySelect').value = '';
            populateDistrictSelect();
            document.getElementById('districtSelect').value = name;
            selectDistrict();
        }

        // ============== TAB NAVIGATION ==============
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            btn.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            if (tabId === 'action') updateBrief();
        }

        // ============== CALCULATIONS ==============
        function calculateFundingGap(d) {
            if (!d) return { total: 0, components: {} };

            const base = 12500;
            const povertyGap = d.li > 0.4 ? (d.li - 0.4) * base * 0.35 : d.li * base * 0.15;
            const spedGap = d.sp > 0.155 ? (d.sp - 0.155) * base * 2.5 : 0;
            const ellGap = d.el > 0.05 ? (d.el - 0.05) * base * 0.3 : 0;
            const regionGap = (1.04 - d.cis) * base * 0.45;
            const msocGap = 450;

            const total = povertyGap + spedGap + ellGap + Math.max(0, regionGap) + msocGap;

            return {
                total: Math.round(total),
                components: {
                    poverty: Math.round(povertyGap),
                    sped: Math.round(spedGap),
                    ell: Math.round(ellGap),
                    region: Math.round(Math.max(0, regionGap)),
                    msoc: Math.round(msocGap)
                }
            };
        }

        // ============== UPDATE DISPLAYS ==============
        function updateAllDisplays() {
            if (!currentDistrict) return;
            const d = currentDistrict;
            const gap = calculateFundingGap(d);

            // District name
            document.getElementById('districtNameStats').textContent = d.n;
            document.getElementById('simDistrictName').textContent = d.n;

            // Stats grid
            document.getElementById('statEnrollment').textContent = d.t.toLocaleString();
            document.getElementById('statFundingGap').textContent = '-$' + gap.total.toLocaleString();
            document.getElementById('statLowIncome').textContent = (d.li * 100).toFixed(1) + '%';

            const spedEl = document.getElementById('statSpEd');
            spedEl.textContent = (d.sp * 100).toFixed(1) + '%';
            spedEl.className = 'value ' + (d.sp > 0.155 ? 'red' : 'green');

            document.getElementById('statELL').textContent = (d.el * 100).toFixed(1) + '%';
            document.getElementById('statTotalShortfall').textContent = '-$' + (gap.total * d.t / 1000000).toFixed(1) + 'M';

            // Pie chart
            updatePieChart(d);

            // Problems
            updateProblems(d, gap);

            // Simulator
            updateSimulator();

            // Scatter Plot
            drawScatterPlot();
        }

        function updatePieChart(d) {
            const federal = Math.round(5 + d.li * 15);
            const local = d.lea === 'revenue' ? Math.round(20 + (1 - d.li) * 10) : Math.round(12 + (1 - d.li) * 8);
            const state = 100 - federal - local;

            const pie = document.getElementById('pieChart');
            pie.style.background = `conic-gradient(#2563eb 0% ${state}%, #10b981 ${state}% ${state + local}%, #ffc107 ${state + local}% 100%)`;

            document.getElementById('pieStatePct').textContent = state + '%';
            document.getElementById('pieLocalPct').textContent = local + '%';
            document.getElementById('pieFederalPct').textContent = federal + '%';

            const total = d.t * 16500;
            document.getElementById('pieTotalAmt').textContent = '$' + (total / 1000000).toFixed(1) + 'M';
            document.getElementById('pieStateAmt').textContent = '$' + (total * state / 100 / 1000000).toFixed(1) + 'M';
            document.getElementById('pieLocalAmt').textContent = '$' + (total * local / 100 / 1000000).toFixed(1) + 'M';
            document.getElementById('pieFederalAmt').textContent = '$' + (total * federal / 100 / 1000000).toFixed(1) + 'M';
        }

        function updateProblems(d, gap) {
            // Problem 1: Poverty
            const povertyBenefit = Math.round(d.li * d.t * 12500 * 0.2);
            document.getElementById('problem1Impact').textContent = '$' + povertyBenefit.toLocaleString() + ' unfunded';
            document.getElementById('problem1Solution').textContent = '+$' + povertyBenefit.toLocaleString() + ' for your district';

            // Problem 2: SpEd
            const spedImpactEl = document.getElementById('problem2Impact');
            if (d.sp > 0.155) {
                // Over cap - red (losing money)
                spedImpactEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--accent-red); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">OVER CAP</span>
                        <span style="color: var(--accent-red);">+${((d.sp - 0.155) * 100).toFixed(1)}% unfunded</span>
                    </div>
                `;
            } else {
                // Under cap - green (no loss)
                spedImpactEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--accent-green); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">UNDER CAP</span>
                        <span style="color: var(--accent-green);">${(d.sp * 100).toFixed(1)}% SpEd rate</span>
                    </div>
                `;
            }

            // Problem 4: Regionalization (CIS Factor: 1.04=high, 1.02-1.03=mid, 1.00-1.01=low)
            const cisImpact = document.getElementById('problem4Impact');
            const cis = d.cis;

            if (cis >= 1.04) {
                // High - green (gets full regionalization)
                cisImpact.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--accent-green); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">HIGH</span>
                        <span style="color: var(--accent-green);">${cis.toFixed(2)}</span>
                    </div>
                `;
            } else if (cis >= 1.02) {
                // Mid - yellow
                cisImpact.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--accent-yellow); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">MID</span>
                        <span style="color: var(--accent-yellow);">${cis.toFixed(2)}</span>
                    </div>
                `;
            } else {
                // Low - red (underfunded for regional costs)
                cisImpact.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--accent-red); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">LOW</span>
                        <span style="color: var(--accent-red);">${cis.toFixed(2)}</span>
                    </div>
                `;
            }

            // Problem 5: Levy Paradox - use actual voter-approved data
            const levyImpact = document.getElementById('problem5Impact');
            const levyDetail = document.getElementById('problem5Detail');
            const levyData = VOTER_APPROVED_LEVY[d.n];
            const levyCap = 2500;

            if (levyData) {
                const voterApproved = levyData.perStudent;
                const cannotCollect = Math.max(0, voterApproved - levyCap);
                const totalLoss = cannotCollect * d.t;

                if (cannotCollect > 0) {
                    // Over cap - losing money
                    levyImpact.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--accent-red); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">LEVY CAPPED</span>
                            <span style="color: var(--accent-red);">-$${cannotCollect.toLocaleString()}/student lost</span>
                        </div>
                    `;

                    if (levyDetail) {
                        levyDetail.innerHTML = `
                            <strong>${d.n}</strong> is <span style="color: var(--accent-red);">Over Levy Cap</span><br>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Voters Approved</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-blue);">$${voterApproved.toLocaleString()}/student</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">State Levy Cap</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-red);">$${levyCap.toLocaleString()}/student</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(255,107,107,0.2); border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Cannot Collect (Blocked by State)</div>
                                <strong style="color: var(--accent-red); font-size: 1.4rem;">$${totalLoss.toLocaleString()}/year</strong>
                                <p style="font-size: 0.85rem; margin-top: 8px; color: var(--text-secondary);">Voters said YES, but state law blocks collection above $2,500/student.</p>
                            </div>
                        `;
                    }
                } else {
                    // Under cap = LEA shortfall (can't raise enough locally)
                    const leaShortfall = levyCap - voterApproved;
                    const totalLeaNeeded = leaShortfall * d.t;
                    levyImpact.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--accent-red); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">LEA NEEDED</span>
                            <span style="color: var(--accent-red);">-$${leaShortfall.toLocaleString()}/student short</span>
                        </div>
                    `;

                    if (levyDetail) {
                        levyDetail.innerHTML = `
                            <strong>${d.n}</strong> <span style="color: var(--accent-red);">needs LEA assistance</span><br>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Local Levy Collected</div>
                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-yellow);">$${voterApproved.toLocaleString()}/student</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">State Target (Levy Cap)</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">$${levyCap.toLocaleString()}/student</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(255,107,107,0.2); border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">LEA Shortfall (State Should Fill)</div>
                                <strong style="color: var(--accent-red); font-size: 1.4rem;">-$${leaShortfall.toLocaleString()}/student</strong>
                                <p style="font-size: 0.85rem; margin-top: 8px; color: var(--text-secondary);">District needs $${totalLeaNeeded.toLocaleString()}/year in state LEA funds to match wealthier districts.</p>
                            </div>
                        `;
                    }
                }
            } else {
                // No data - estimate based on LEA type
                if (d.lea === 'rate') {
                    const maxCanRaise = Math.round(d.av / d.t * 0.0025);
                    const shortfall = Math.max(0, levyCap - maxCanRaise);

                    levyImpact.textContent = 'Needs +$' + shortfall.toLocaleString();
                    levyImpact.style.color = 'var(--accent-yellow)';

                    if (levyDetail) {
                        levyDetail.innerHTML = `
                            <strong>${d.n}</strong> is <span style="color: var(--accent-yellow);">Rate-Capped (Low Property Value)</span><br>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Max Rate Can Generate</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">$${maxCanRaise.toLocaleString()}/student</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Target</div>
                                    <div style="font-size: 1.2rem; font-weight: 600;">$${levyCap.toLocaleString()}/student</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,202,87,0.2); border-radius: 6px;">
                                <strong style="color: var(--accent-yellow);">LEA Subsidy Needed: $${(shortfall * d.t).toLocaleString()}/year</strong>
                                <p style="font-size: 0.85rem; margin-top: 5px;">Low property values limit local revenue even at max tax rate.</p>
                            </div>
                        `;
                    }
                } else {
                    levyImpact.textContent = 'Data unavailable';
                    levyImpact.style.color = 'var(--text-secondary)';
                }
            }

            // Problem 6: Enrollment change (compare to previous year)
            const enrollmentImpact = document.getElementById('problem6Impact');
            const prevYearData = DISTRICTS.find(dist => dist.n === d.n && dist.y === '2023-24');

            if (prevYearData) {
                const change = d.t - prevYearData.t;
                const changePercent = ((change / prevYearData.t) * 100).toFixed(1);

                if (change > 0) {
                    // Growing - green
                    enrollmentImpact.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--accent-green); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">GROWING</span>
                            <span style="color: var(--accent-green);">+${changePercent}% (+${change.toLocaleString()})</span>
                        </div>
                    `;
                } else if (change < 0) {
                    // Declining - red
                    enrollmentImpact.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--accent-red); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">DECLINING</span>
                            <span style="color: var(--accent-red);">${changePercent}% (${change.toLocaleString()})</span>
                        </div>
                    `;
                } else {
                    enrollmentImpact.innerHTML = `<span style="color: var(--text-secondary);">No change</span>`;
                }
            } else {
                enrollmentImpact.innerHTML = `<span style="color: var(--text-secondary);">N/A</span>`;
            }
        }

        function toggleProblem(card) {
            card.classList.toggle('expanded');
        }

        // ============== SIMULATOR ==============
        function updateSimulator() {
            if (!currentDistrict) return;
            const d = currentDistrict;
            const base = 12500;

            // Update district stats panel
            document.getElementById('simEnrollment').textContent = d.t.toLocaleString();
            document.getElementById('simLowIncome').textContent = (d.li * 100).toFixed(1) + '%';
            document.getElementById('simSpedRate').textContent = (d.sp * 100).toFixed(1) + '%';
            document.getElementById('simEllRate').textContent = (d.el * 100).toFixed(1) + '%';
            document.getElementById('simDistrictName2').textContent = d.n;

            const povertyWeight = parseInt(document.getElementById('povertyWeightSlider').value) / 100;
            const spedCap = parseInt(document.getElementById('spedCapSlider').value) / 1000;
            const ellFunding = parseInt(document.getElementById('ellFundingSlider').value);
            const msocAmount = parseInt(document.getElementById('msocSlider').value);

            // Update display values
            document.getElementById('povertyWeightValue').textContent = Math.round(povertyWeight * 100) + '%';
            document.getElementById('spedCapValue').textContent = (spedCap * 100).toFixed(1) + '%';
            document.getElementById('ellFundingValue').textContent = '$' + ellFunding.toLocaleString();
            document.getElementById('msocValue').textContent = '$' + msocAmount.toLocaleString();

            // Calculate benefits per student
            const povertyBenefit = Math.round(base * povertyWeight * d.li);
            const spedBenefit = Math.round(base * Math.max(0, d.sp - 0.155) * (spedCap > 0.155 ? 2.5 : 0) * (spedCap - 0.155) / Math.max(d.sp - 0.155, 0.001));
            // Simplified SpEd: if district exceeds cap and cap is raised, they benefit
            const spedBenefitSimple = d.sp > 0.155 ? Math.round(base * Math.min(d.sp - 0.155, spedCap - 0.155) * 2.12) : 0;
            const ellBenefit = Math.round((ellFunding - 1200) * d.el);
            const msocBenefit = msocAmount - 1533;

            // Use simplified SpEd calculation
            const actualSpedBenefit = spedCap > 0.155 && d.sp > 0.155 ? Math.round(base * Math.min(d.sp - 0.155, spedCap - 0.155) * 2.12) : 0;

            const totalPerStudent = povertyBenefit + actualSpedBenefit + ellBenefit + msocBenefit;
            const totalBenefit = totalPerStudent * d.t;

            // Update breakdown
            document.getElementById('simPovertyGain').textContent = '+$' + povertyBenefit.toLocaleString();
            document.getElementById('simSpedGain').textContent = '+$' + actualSpedBenefit.toLocaleString();
            document.getElementById('simEllGain').textContent = '+$' + ellBenefit.toLocaleString();
            document.getElementById('simMsocGain').textContent = '+$' + msocBenefit.toLocaleString();

            document.getElementById('perStudentBenefit').textContent = '+$' + totalPerStudent.toLocaleString();
            document.getElementById('totalBenefit').textContent = '+$' + (totalBenefit / 1000000).toFixed(1) + 'M/year';

            // Update impact descriptions with district-specific info
            const lowIncomeStudents = Math.round(d.t * d.li);
            const ellStudents = Math.round(d.t * d.el);
            document.getElementById('povertyImpact').innerHTML = `<span style="color: var(--accent-red);">${lowIncomeStudents.toLocaleString()}</span> low-income students in ${d.n}`;
            document.getElementById('spedImpact').innerHTML = d.sp > 0.155
                ? `<span style="color: var(--accent-purple);">${(d.sp * 100).toFixed(1)}%</span> SpEd rate exceeds 15.5% cap`
                : `${d.n} is under 15.5% cap`;
            document.getElementById('ellImpact').innerHTML = `<span style="color: var(--accent-cyan);">${ellStudents.toLocaleString()}</span> ELL students in ${d.n}`;
            document.getElementById('msocImpact').textContent = `+$${msocBenefit}/student for all ${d.t.toLocaleString()} students`;

            // Estimate statewide cost
            const statewideCost = totalPerStudent * 1100000; // ~1.1M students
            document.getElementById('statewideCost').textContent = '$' + (statewideCost / 1000000000).toFixed(2) + 'B';
        }

        function applyPreset(preset) {
            switch(preset) {
                case 'reset':
                    document.getElementById('povertyWeightSlider').value = 0;
                    document.getElementById('spedCapSlider').value = 155;
                    document.getElementById('ellFundingSlider').value = 1200;
                    document.getElementById('msocSlider').value = 1533;
                    break;
                case 'moderate':
                    document.getElementById('povertyWeightSlider').value = 15;
                    document.getElementById('spedCapSlider').value = 175;
                    document.getElementById('ellFundingSlider').value = 1800;
                    document.getElementById('msocSlider').value = 1750;
                    break;
                case 'aggressive':
                    document.getElementById('povertyWeightSlider').value = 30;
                    document.getElementById('spedCapSlider').value = 250;
                    document.getElementById('ellFundingSlider').value = 2500;
                    document.getElementById('msocSlider').value = 1980;
                    break;
            }
            updateSimulator();
        }

        // ============== SCATTER PLOT ==============
        let currentScatterAxis = 'poverty';

        function updateScatterAxis(axis) {
            currentScatterAxis = axis;
            // Update button states
            document.querySelectorAll('.scatter-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.axis === axis);
            });
            drawScatterPlot();
        }

        function drawScatterPlot() {
            const svg = document.getElementById('scatterPlot');
            const pointsGroup = document.getElementById('scatterPoints');
            const xLabelsGroup = document.getElementById('xAxisLabels');
            const yLabelsGroup = document.getElementById('yAxisLabels');
            const gridGroup = document.getElementById('gridLines');
            const trendLine = document.getElementById('trendLine');
            const xAxisTitle = document.getElementById('xAxisTitle');

            // Clear previous
            pointsGroup.innerHTML = '';
            xLabelsGroup.innerHTML = '';
            yLabelsGroup.innerHTML = '';
            gridGroup.innerHTML = '';

            // Get 2024-25 data only
            const data2024 = DISTRICTS.filter(d => d.y === '2024-25');

            // Prepare data based on axis
            const axisTitles = {
                poverty: 'Poverty Rate (%)',
                sped: 'SpEd Rate (%)',
                ell: 'ELL Rate (%)',
                enrollment: 'Enrollment (students)'
            };
            xAxisTitle.textContent = axisTitles[currentScatterAxis];

            // Get x and y values
            const getX = (d) => {
                switch(currentScatterAxis) {
                    case 'poverty': return d.li * 100;
                    case 'sped': return d.sp * 100;
                    case 'ell': return d.el * 100;
                    case 'enrollment': return d.t;
                }
            };

            const getY = (d) => calculateFundingGap(d).total;

            // Calculate data points
            const points = data2024.map(d => ({
                x: getX(d),
                y: getY(d),
                name: d.n,
                isSelected: currentDistrict && d.n === currentDistrict.n
            }));

            // Calculate ranges
            const xValues = points.map(p => p.x);
            const yValues = points.map(p => p.y);
            const xMin = Math.min(...xValues) * 0.9;
            const xMax = Math.max(...xValues) * 1.1;
            const yMin = Math.min(...yValues) * 0.9;
            const yMax = Math.max(...yValues) * 1.1;

            // Scale functions
            const scaleX = (val) => 60 + (val - xMin) / (xMax - xMin) * 720;
            const scaleY = (val) => 300 - (val - yMin) / (yMax - yMin) * 280;

            // Draw grid lines
            for (let i = 0; i <= 5; i++) {
                const y = 20 + i * 56;
                gridGroup.innerHTML += `<line x1="60" y1="${y}" x2="780" y2="${y}"/>`;
            }
            for (let i = 0; i <= 6; i++) {
                const x = 60 + i * 120;
                gridGroup.innerHTML += `<line x1="${x}" y1="20" x2="${x}" y2="300"/>`;
            }

            // Draw Y-axis labels
            for (let i = 0; i <= 5; i++) {
                const val = yMin + (yMax - yMin) * (5 - i) / 5;
                const y = 20 + i * 56;
                yLabelsGroup.innerHTML += `<text x="55" y="${y + 4}" text-anchor="end">$${Math.round(val).toLocaleString()}</text>`;
            }

            // Draw X-axis labels
            for (let i = 0; i <= 6; i++) {
                const val = xMin + (xMax - xMin) * i / 6;
                const x = 60 + i * 120;
                const label = currentScatterAxis === 'enrollment'
                    ? Math.round(val / 1000) + 'K'
                    : val.toFixed(1) + '%';
                xLabelsGroup.innerHTML += `<text x="${x}" y="318" text-anchor="middle">${label}</text>`;
            }

            // Linear regression for trend line and R¬≤
            const n = points.length;
            const sumX = points.reduce((a, p) => a + p.x, 0);
            const sumY = points.reduce((a, p) => a + p.y, 0);
            const sumXY = points.reduce((a, p) => a + p.x * p.y, 0);
            const sumX2 = points.reduce((a, p) => a + p.x * p.x, 0);
            const sumY2 = points.reduce((a, p) => a + p.y * p.y, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // R¬≤ calculation
            const meanY = sumY / n;
            const ssTotal = points.reduce((a, p) => a + Math.pow(p.y - meanY, 2), 0);
            const ssResidual = points.reduce((a, p) => a + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
            const r2 = 1 - (ssResidual / ssTotal);

            document.getElementById('r2Value').textContent = r2.toFixed(3);

            // Draw trend line
            const trendY1 = slope * xMin + intercept;
            const trendY2 = slope * xMax + intercept;
            trendLine.setAttribute('x1', scaleX(xMin));
            trendLine.setAttribute('y1', scaleY(trendY1));
            trendLine.setAttribute('x2', scaleX(xMax));
            trendLine.setAttribute('y2', scaleY(trendY2));

            // Draw points (non-selected first, selected last so it's on top)
            const sortedPoints = [...points].sort((a, b) => a.isSelected - b.isSelected);

            sortedPoints.forEach(p => {
                const cx = scaleX(p.x);
                const cy = scaleY(p.y);
                const radius = p.isSelected ? 10 : 6;
                const fill = p.isSelected ? 'var(--accent-yellow)' : 'var(--accent-blue)';
                const stroke = p.isSelected ? '#fff' : 'none';
                const strokeWidth = p.isSelected ? 2 : 0;
                const opacity = p.isSelected ? 1 : 0.7;

                pointsGroup.innerHTML += `
                    <circle cx="${cx}" cy="${cy}" r="${radius}" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" opacity="${opacity}">
                        <title>${p.name}\nX: ${currentScatterAxis === 'enrollment' ? p.x.toLocaleString() : p.x.toFixed(1) + '%'}\nGap: $${p.y.toLocaleString()}/student</title>
                    </circle>
                `;
            });

            // Update interpretation
            updateScatterInterpretation(r2, slope);
        }

        function updateScatterInterpretation(r2, slope) {
            const explanation = document.getElementById('scatterExplanation');
            const direction = slope > 0 ? 'positive' : 'negative';
            const strength = r2 > 0.5 ? 'strong' : r2 > 0.25 ? 'moderate' : 'weak';

            const interpretations = {
                poverty: {
                    positive: `Higher poverty rates are associated with larger funding gaps (${strength} correlation). Districts with more low-income students receive LESS adequate funding - the opposite of what equity requires.`,
                    negative: `Lower poverty rates are associated with larger funding gaps. This is unusual and may indicate other factors at play.`
                },
                sped: {
                    positive: `Districts with higher SpEd rates face larger funding gaps due to the 15.5% cap (${strength} correlation). The cap systematically underfunds districts serving more special education students.`,
                    negative: `Lower SpEd rates are associated with larger funding gaps. This may reflect other funding formula issues.`
                },
                ell: {
                    positive: `Districts with more English Language Learners face larger funding gaps (${strength} correlation). TBIP funding ($1,200/student) falls far short of actual service costs ($2,500+).`,
                    negative: `Lower ELL rates are associated with larger funding gaps. Other factors may be more significant.`
                },
                enrollment: {
                    positive: `Larger districts face bigger per-student funding gaps (${strength} correlation). Scale doesn't provide funding advantages in WA's formula.`,
                    negative: `Smaller districts face larger per-student funding gaps (${strength} correlation). This may reflect higher fixed costs spread over fewer students.`
                }
            };

            explanation.textContent = interpretations[currentScatterAxis][direction];
        }

        // ============== TIMELINE ==============
        function selectYear(year, el) {
            document.querySelectorAll('.timeline-item').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');

            const details = {
                2025: { title: 'Year 1 (2025): Emergency Repairs', cost: '$1.2B' },
                2026: { title: 'Year 2 (2026): Consolidation', cost: '$800M' },
                2027: { title: 'Year 3 (2027): Full Implementation', cost: '$1.5B' },
                2028: { title: 'Year 4 (2028): Evaluation', cost: '$400M' },
                2029: { title: 'Year 5 (2029): Sustainability', cost: '$600M' }
            };

            const d = details[year];
            document.getElementById('yearDetail').innerHTML = `
                <h3>üìÖ ${d.title}</h3>
                <p style="color: var(--text-secondary); margin-top: 10px;">Estimated Total Cost: <span style="color: var(--accent-yellow); font-weight: 600;">${d.cost}</span></p>
            `;
        }

        // ============== BRIEF ==============
        function updateBrief() {
            if (!currentDistrict) return;
            const d = currentDistrict;
            const gap = calculateFundingGap(d);

            document.getElementById('briefDistrictName').textContent = d.n;
            document.getElementById('briefSummary').textContent =
                `${d.n} serves ${d.t.toLocaleString()} students with a ${(d.li * 100).toFixed(1)}% low-income rate. ` +
                `The district faces a per-pupil funding gap of $${gap.total.toLocaleString()}, resulting in an annual shortfall of $${(gap.total * d.t / 1000000).toFixed(1)} million.`;

            document.getElementById('briefEnrollment').textContent = d.t.toLocaleString();
            document.getElementById('briefGap').textContent = '-$' + gap.total.toLocaleString();
            document.getElementById('briefShortfall').textContent = '-$' + (gap.total * d.t / 1000000).toFixed(1) + 'M';

            // Update email template
            const template = document.getElementById('emailTemplate');
            template.value = template.value
                .replace('[DISTRICT NAME]', d.n)
                .replace('[AMOUNT]', '$' + gap.total.toLocaleString())
                .replace('[TOTAL]', '$' + (gap.total * d.t / 1000000).toFixed(1) + ' million')
                .replace('[X%]', (d.li * 100).toFixed(1) + '%');
        }

        function printBrief() {
            window.print();
        }

        function copyBrief() {
            const brief = document.getElementById('briefContainer').innerText;
            navigator.clipboard.writeText(brief).then(() => alert('Brief copied!'));
        }

        function copyEmailTemplate() {
            const template = document.getElementById('emailTemplate').value;
            navigator.clipboard.writeText(template).then(() => {
                const btn = document.querySelector('.copy-template-btn');
                btn.textContent = '‚úì Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy Template', 2000);
            });
        }

        // ============== SHARE ==============
        function shareTwitter() {
            const text = encodeURIComponent('Did you know? Washington schools face a $2+ billion funding gap. Learn more:');
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        function shareFacebook() {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        function shareEmail() {
            const subject = encodeURIComponent('WA K-12 School Funding Gap Analysis');
            const body = encodeURIComponent(`Check out this interactive analysis of Washington school funding gaps: ${window.location.href}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link copied to clipboard!');
            });
        }
    </script>
</body>
</html>
